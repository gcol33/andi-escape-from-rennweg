# Andi VN ‚Äî Project Overview and Development Rules

This document defines how the project is structured, how files are organized, and the coding conventions we follow. No numbers for scenes, endings, or prompts are fixed here; this document only describes architecture and rules.

---

## 1. Project Goal

Build a small, static-site visual novel (VN) for Andi's PhD farewell.
The focus is on:

- simple branching story structure
- fast iteration
- minimal dependencies
- clean separation between engine and story
- easy collaboration (anyone can edit the story without touching code)

The final product is a **single-page VN** that loads story data and images dynamically.

### Password Protection

The game is protected by a 4-character password screen that appears on load:
- Password inputs auto-focus and auto-advance between characters
- Correct password hides the overlay and starts the game
- Incorrect attempts trigger shake animation and funny error messages
- After 5 failed attempts, a 30-second lockout is applied
- Password logic lives in `js/password.js`

---

## 2. High-Level Architecture

The VN consists of four layers:

1. **HTML shell**
   - The static structure of the page.
   - Contains only empty containers for text, buttons, and images.

2. **VN engine (JavaScript)**
   - Handles loading the story, updating the UI, rendering backgrounds and character sprites, managing flags, and handling branching logic.
   - Interprets actions (e.g. dice rolls) via a handler registry.
   - No story text lives here.

3. **Story data (generated)**
   - A single file (`js/story.js`) containing all narrative content.
   - Generated from Markdown scene files by the static site generator.
   - Includes: scene IDs, text blocks, choices, flags, background references, sprite references, actions.

4. **Scene source files (Markdown)**
   - One `.md` file per scene in the `scenes/` folder.
   - Human-readable format with YAML frontmatter and narrative text.
   - This is the **source of truth** for all story content.

This separation ensures the engine is stable, writers only edit Markdown, and the build step produces clean data.

---

## 3. Folder Structure

```
Andi/
‚îÇ
‚îú‚îÄ index.html
‚îÇ
‚îú‚îÄ css/
‚îÇ   ‚îî‚îÄ themes/
‚îÇ       ‚îú‚îÄ prototype.css   (original warm beige VN style)
‚îÇ       ‚îî‚îÄ 90s.css         (Windows 3.1 aesthetic)
‚îÇ
‚îú‚îÄ theme.md                (theme selection config)
‚îÇ
‚îú‚îÄ js/
‚îÇ   ‚îú‚îÄ engine.js
‚îÇ   ‚îú‚îÄ battle.js       (battle system module)
‚îÇ   ‚îú‚îÄ password.js     (password screen logic)
‚îÇ   ‚îú‚îÄ story.js        (generated - do not edit manually)
‚îÇ   ‚îî‚îÄ theme.js        (generated - theme configuration)
‚îÇ
‚îú‚îÄ scenes/
‚îÇ   ‚îî‚îÄ *.md            (source of truth for story)
‚îÇ
‚îú‚îÄ assets/
‚îÇ   ‚îú‚îÄ bg/
‚îÇ   ‚îú‚îÄ char/
‚îÇ   ‚îú‚îÄ fonts/        (local font files for offline use)
‚îÇ   ‚îú‚îÄ music/
‚îÇ   ‚îî‚îÄ sfx/
‚îÇ
‚îú‚îÄ editor/
‚îÇ   ‚îú‚îÄ index.html      (scene editor)
‚îÇ   ‚îú‚îÄ editor.js
‚îÇ   ‚îî‚îÄ editor.css
‚îÇ
‚îú‚îÄ tools/
‚îÇ   ‚îî‚îÄ build_story_from_md.py
‚îÇ
‚îî‚îÄ prototype/
    ‚îî‚îÄ andy.html       (original prototype for reference)
```

### index.html
Contains:
- empty containers for story text, choices, backgrounds, sprites
- continue button for text block progression
- links to CSS and JS
- no story text or logic code allowed

### css/themes/*.css
Theme CSS files define:
- layout
- background and sprite positioning
- text formatting
- continue button and choice button styling
- transitions
- color schemes

No inline styles permitted.

### theme.md
Configuration file for selecting the active theme:
```markdown
prototype [ ]
90s [x]
```
- One line per theme
- `[x]` marks the selected theme
- `[ ]` marks available but unselected themes
- Only one theme can be selected at a time

### js/engine.js
Contains VN logic:
- load story data from `story.js`
- maintain state (current scene, current text block index, flags)
- update UI
- render backgrounds and sprites
- step through text blocks with "Continue" button
- show choices after final text block
- execute actions via handler registry
- manage branching
- **never contains story text**

### js/story.js
Contains **only generated narrative data**:
- scenes with `id`, `textBlocks`, `choices`, `actions`
- `bg` and `chars` fields
- flags: `set_flags`, `require_flags`
- **Do not edit manually** ‚Äî generated by `build_story_from_md.py`

### scenes/*.md
Contains **source story content**:
- one file per scene
- YAML frontmatter for metadata
- text blocks separated by `---`
- choices section at the end
- **This is what writers edit**

---

## 4. Scene Model (Markdown Format)

Each scene is a single Markdown file in `scenes/` with this structure:

```markdown
---
id: scene_id
bg: background_filename.jpg
music: ambient_track.mp3
chars:
  - character1.svg
  - character2.svg
set_flags:
  - flag_to_set
require_flags:
  - flag_required
actions:
  - type: roll_dice
    dice: d20
    threshold: 13
    success_target: success_scene
    failure_target: failure_scene
---

First text block. This is shown when the scene loads.

The player clicks "Continue" to advance.

---

Second text block. This appears after the first "Continue" click.

You can have as many text blocks as needed.

---

Third and final text block.

After this, choices are shown (or actions execute).

### Choices

- Go left ‚Üí left_scene
- Go right ‚Üí right_scene
- Stay here (requires: has_key) ‚Üí locked_room
```

### Frontmatter Fields

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique scene identifier |
| `bg` | No | Background filename (in `assets/bg/`). Supports static (.jpg, .png) and animated (.gif, .webp, .webm, .mp4) formats |
| `chars` | No | Array of character sprite filenames (in `assets/char/`) |
| `music` | No | Background music filename (in `assets/music/`), or `none` to stop |
| `set_flags` | No | Array of flags to set when entering this scene |
| `require_flags` | No | Array of flags required to enter this scene |
| `add_items` | No | Array of item names to add to player inventory |
| `remove_items` | No | Array of item names to remove from player inventory |
| `actions` | No | Array of action objects (see Actions section) |

### Text Blocks

- Separated by `---` (horizontal rule)
- Each block is a separate "Continue" click
- Support Markdown formatting: `**bold**`, `*italic*`
- Background and characters remain constant throughout the scene
- No visual changes between blocks (only at scene transitions)

### Choices Section

- Must be under `### Choices` heading
- Each choice is a list item: `- Label text ‚Üí target_id`
- Optional flag requirements: `- Label (requires: flag_name) ‚Üí target_id`
- Optional flag setting: `- Label (sets: flag_name) ‚Üí target_id`
- Optional item requirements: `- Label (require_items: Item Name) ‚Üí target_id`
- Optional item consumption: `- Label (uses: Item Name) ‚Üí target_id`
- Optional healing: `- Label (heals: 5) ‚Üí target_id`
- Optional battle action: `- Label (battle: attack) ‚Üí target_id`
- Optional sound effect: `- Label [sfx: filename.ogg] ‚Üí target_id`
- Choices only appear after all text blocks are shown
- If no choices and no actions, scene is a game over / ending

**Choice Modifiers:**

| Modifier | Syntax | Description |
|----------|--------|-------------|
| `requires` | `(requires: flag_name)` | Only show if player has flag |
| `sets` | `(sets: flag_name)` | Set flag when choice selected |
| `require_items` | `(require_items: Item)` | Only show if player has item |
| `uses` | `(uses: Item Name)` | Consume item when selected |
| `heals` | `(heals: 5)` | Heal player HP when selected |
| `battle` | `(battle: attack)` | Battle action type (see Battle System) |
| `sfx` | `[sfx: sound.ogg]` | Play sound effect on selection |

**Choice Examples:**
```markdown
### Choices

- Take the stairs [sfx: footstep.ogg] ‚Üí main_stairs
- Use the elevator [sfx: elevator_ding.ogg] ‚Üí elevator
- Unlock the door (uses: Master Key) ‚Üí secret_room
- Drink coffee (uses: Coffee Mug, heals: 5) ‚Üí refreshed
- Fight! (battle: attack) ‚Üí battle_continue
```

---

## 5. Actions Model

Actions are special behaviors that execute after all text blocks are shown (but before choices). They are defined in the frontmatter `actions` array.

### Supported Action Types

#### `roll_dice`
Performs a dice roll and navigates based on result. Supports advantage/disadvantage, skill names, and critical hit/fumble text.

```yaml
actions:
  - type: roll_dice
    dice: d20
    threshold: 13
    modifier: advantage      # optional: advantage, disadvantage, or normal (default)
    skill: Persuasion        # optional: display name for the check
    crit_text: "Perfect!"    # optional: custom text on natural 20
    fumble_text: "Disaster!" # optional: custom text on natural 1
    success_target: success_scene
    failure_target: failure_scene
```

Parameters:
- `dice`: Dice type (d4, d6, d8, d10, d12, d20, d100)
- `threshold`: Number to roll at or below to succeed
- `modifier`: `advantage` (roll 2, take highest), `disadvantage` (roll 2, take lowest), or `normal` (default)
- `skill`: Display name shown above roll result (e.g., "Persuasion Check")
- `crit_text`: Custom text displayed on natural 20 (d20 only)
- `fumble_text`: Custom text displayed on natural 1 (d20 only)
- `success_target`: Scene ID to go to on success
- `failure_target`: Scene ID to go to on failure

**Critical Hits & Fumbles (d20 only):**
- Natural 20: Always succeeds, shows crit_text or "CRITICAL SUCCESS!"
- Natural 1: Always fails, shows fumble_text or "CRITICAL FAILURE!"

#### `start_battle`
Initiates a turn-based battle encounter with HP bars and combat actions.

```yaml
actions:
  - type: start_battle
    player_max_hp: 20
    player_ac: 10
    player_attack_bonus: 2
    player_damage: d8
    enemy:
      name: Agnes
      hp: 30
      ac: 12
      attack_bonus: 3
      damage: d6
    win_target: victory_scene
    lose_target: defeat_scene
    flee_target: escaped_scene  # optional
```

Parameters:
- `player_max_hp`: Player's maximum HP (initializes on first battle)
- `player_ac`: Player's armor class
- `player_attack_bonus`: Bonus to player's attack rolls
- `player_damage`: Player's damage dice (e.g., d6, 2d8, d10+2)
- `enemy`: Enemy stats object (see below)
- `win_target`: Scene to go to when enemy HP reaches 0
- `lose_target`: Scene to go to when player HP reaches 0
- `flee_target`: Optional scene for successful escape

Enemy object:
- `name`: Enemy display name (shown on HP bar)
- `hp`: Enemy hit points
- `ac`: Enemy armor class
- `attack_bonus`: Bonus to enemy attack rolls
- `damage`: Enemy damage dice

#### `play_sfx`
Plays a one-shot sound effect.

```yaml
actions:
  - type: play_sfx
    file: alarm_blare.mp3
```

Parameters:
- `file`: Sound effect filename (in `assets/sfx/`)

#### `custom` (for future extensibility)
Calls a named handler with parameters.

```yaml
actions:
  - type: custom
    handler: showSpecialEvent
    params:
      difficulty: hard
      reward: golden_key
```

### Action Handler Registry

The engine maintains an `actionHandlers` object that maps action types to handler functions:

```javascript
const actionHandlers = {
    roll_dice: (action, state) => { /* ... */ },
    start_battle: (action, state) => { /* ... */ },
    play_sfx: (action, state) => { /* ... */ },
    custom: (action, state) => { /* ... */ }
};
```

New action types can be added by registering handlers in the engine.

---

## 6. Static Site Generator

The script `tools/build_story_from_md.py` processes scene files:

### Input
- All `.md` files in `scenes/` directory

### Processing
1. Parse YAML frontmatter
2. Extract text blocks (split by `---`)
3. Parse `### Choices` section into structured choice objects
4. Build scene objects with all fields

### Output
- Generates `js/story.js` with a JavaScript object containing all scenes

### Validation
The generator validates:
- All `target` IDs in choices exist as scene IDs
- No duplicate scene IDs
- Required frontmatter fields are present
- Warns about unreachable scenes

### Usage
```bash
python tools/build_story_from_md.py
```

---

## 7. VN "Continue" Behavior

The engine implements a text block progression system:

1. **Scene Load**: Show first text block, display "Continue" button
2. **Continue Click**: Advance to next text block
3. **Last Block**: Hide "Continue", either:
   - Execute actions (e.g. dice roll), which navigates to next scene
   - Show choice buttons
   - Show "Play Again" if no choices (ending)

### State Tracking
- `currentSceneId`: Which scene we're in
- `currentBlockIndex`: Which text block we're showing (0-indexed)
- `flags`: Set of string flags

---

## 8. Coding Standards

### General
- Always separate content (story) from logic (engine)
- No story text inside engine code
- No logic inside story data
- Writers only edit Markdown files, never JS
- No global variables except the engine namespace

### JavaScript
- Use clear, minimal functions
- Keep engine.js stable and rarely edited
- Action handlers should be pure functions where possible

### Markdown (Scene Files)
- Use lowercase with underscores for IDs: `main_stairs`, `lost_to_coffee`
- Keep text blocks focused (one idea per block)
- Use `---` only for block separators
- Put choices at the very end of the file

### CSS
- **Never use pixel-based media queries** ‚Äî they don't scale properly with device pixel ratios
- Use `em`-based breakpoints instead (e.g., `56em` instead of `900px`)
- Reference: `1em = 16px` at default browser settings, so `56em ‚âà 900px`, `37.5em ‚âà 600px`
- Use `dvh` (dynamic viewport height) instead of `vh` for mobile browser compatibility
- **Always provide fallbacks for modern CSS features** to support older browsers (~2012):
  - `aspect-ratio`: Use padding-bottom percentage trick as fallback (e.g., `padding-bottom: 56.25%` for 16:9)
  - `clamp()`/`min()`/`max()`: Provide a static fallback value first
  - `gap` in flexbox: Use margin on children with `@supports (gap: 10px)` to remove margins in modern browsers
  - `:has()` selector: Add a fallback class via JS (e.g., `.has-game-over`) and use `@supports selector(:has(*))` for modern browsers
  - `display: flex`: Add `display: block` or `display: inline-block` as preceding fallback

### Assets
- Background filenames: lowercase with underscores, `.jpg` extension
- Character sprites: lowercase with underscores, `.svg` extension
- All assets stored inside `assets/`

---

## 9. Development Workflow

### For Writers
1. Create or edit `.md` files in `scenes/`
2. Run `python tools/build_story_from_md.py`
3. Reload browser to test
4. Repeat

### For Developers
1. Edit `js/engine.js` for logic changes
2. Edit `css/style.css` for visual changes
3. Edit `index.html` for structure changes
4. Run the build script after scene changes

The workflow must stay frictionless.
Story writers should never touch engine code.

---

## 10. UI Layout

The VN uses a traditional visual novel layout:

- **Fixed 16:9 aspect ratio** container (`#vn-container`)
- **Background layer** fills the entire container
- **Character sprites** positioned in the middle area
- **Text box** occupies the lower ~32% with semi-transparent cream background
- **Continue button** appears below text when more blocks remain
- **Choice buttons** appear after final text block
- **Title** ("Andy's Farewell") displayed above the game container

### Theme Colors (preserved from original design)
- Page background: `#f2e7d5` (warm beige)
- Text color: `#4b3e2a` (dark brown)
- Text box: `rgba(250, 241, 224, 0.95)` (cream, semi-transparent)
- Buttons: `#b08b5a` (golden brown)
- Button text: `#fffbe9` (cream white)
- Accents/borders: `#d3c2a8` (light brown)

---

## 11. Engine Features

### Text Speed Controls
Located in the upper-right of the text box. Uses symbol buttons:
- **‚ñ∂** Normal (30ms per character)
- **‚ñ∂‚ñ∂** Fast (10ms per character)
- **‚ñ∂|** Auto (30ms + auto-advances after 1.5s delay when single choice)
- **‚è≠** Skip (instant display, only visible after at least one block has been read)

### Typewriter Effect
- Text displays character-by-character with blinking cursor
- HTML tags (like `<strong>`) are rendered instantly, only text characters are typed
- Markdown bold (`**text**`) is converted to `<strong>` tags
- Click on text area or press Space to skip (only for already-read blocks)

### Read Block Tracking
- `state.readBlocks` tracks which scene+block combinations have been displayed
- First-time readers cannot skip the typewriter effect
- Skip button only appears after at least one block has been read
- Already-read text shows "(already read)" indicator

### Developer Mode
- Hold **q+w+e+r+t** keys simultaneously to toggle dev mode
- Dev mode allows skipping any text, even on first read
- Green "DEV MODE" indicator appears in top-right corner
- **Theme selector** appears below DEV MODE indicator for live theme switching

### Dice Roll Mechanics
- Defined in scene frontmatter via `actions` array
- Supports different dice types (d20, d6, etc.)
- Roll result determines which scene to navigate to
- Shows roll result message before transitioning

### Choice Buttons
- Displayed horizontally in a single row (never wrap)
- Use `flex: 1 1 0` to distribute space evenly
- Game over states show "Play Again" restart button

---

## 12. Generated Story Structure

The `js/story.js` file contains a JavaScript object like:

```javascript
const story = {
    "scene_id": {
        id: "scene_id",
        bg: "background.jpg",
        chars: ["character.svg"],
        set_flags: [],
        require_flags: [],
        actions: [],
        textBlocks: [
            "First text block...",
            "Second text block..."
        ],
        choices: [
            {
                label: "Choice text",
                target: "target_scene_id",
                sfx: "footstep.ogg",
                require_flags: [],
                set_flags: []
            }
        ]
    }
};
```

---

## 13. Audio System

The VN supports background music and sound effects.

### Background Music (`assets/music/`)
- Looping tracks that play continuously during scenes
- Set via `music` field in scene frontmatter
- Music continues playing across scene transitions unless changed
- Use `music: none` to stop music

**Available music tracks:**
- `BOSS_TIME.mp3` - Intense confrontation music
- `coding.mp3`, `coding_frenzy.mp3` - Working/coding atmosphere
- `coffee.mp3`, `too_much_coffee.mp3` - Kitchen/coffee scenes
- `default.mp3` - General background
- `dicey_decisions.mp3` - Dice roll moments
- `game_over.mp3` - Loss state music
- `glitch.mp3` - Error/glitch effects
- `i_can_do_it.mp3` - Motivational moments
- `last_day.mp3` - Nostalgic/farewell mood
- `legal_trap_stairwell.mp3` - Tense stairwell scenes
- `oh_oh.mp3`, `OH_SHIT.mp3` - Trouble/danger moments
- `outside.mp3`, `rooftop.mp3` - Outdoor scenes
- `questioning.mp3` - Dialogue/interrogation
- `reading_papers.mp3` - Document signing
- `running_escape.mp3` - Chase/escape sequences
- `spooky.mp3` - Eerie atmosphere
- `victory.mp3` - Win state music
- `zen.mp3` - Calm/peaceful moments

**Example usage in scene:**
```yaml
---
id: start
bg: hallway_fluorescent.jpg
music: last_day.mp3
---
```

### Sound Effects (`assets/sfx/`)
- One-shot sounds triggered by choice clicks (VN-style)
- Can also be played via `play_sfx` action type
- Do not loop, play once and stop
- All SFX files use `.ogg` format

**Available SFX:**
- `alarm.ogg`, `alarm_clock.ogg`, `alert.ogg` - Alert sounds
- `chain.ogg` - Chain/trap sound
- `click.ogg` - UI click/confirmation
- `dice_roll.ogg` - Dice rolling
- `door_open.ogg`, `door_slam.ogg` - Door sounds
- `elevator_ding.ogg` - Elevator arrival
- `failure.ogg`, `success.ogg` - Outcome sounds
- `footstep.ogg` - Walking/movement
- `gulp.ogg` - Drinking/swallowing
- `negative.ogg` - Refusal/negative response
- `thud.ogg` - Impact/falling
- `victory.ogg` - Win sound
- `warning.ogg`, `zap.ogg` - Warning sounds

**Choice SFX (preferred method):**
```markdown
### Choices

- Take the stairs [sfx: footstep.ogg] ‚Üí main_stairs
```

**Action SFX (for scene-level effects):**
```yaml
actions:
  - type: play_sfx
    file: alarm.ogg
```

### VN-Style Audio Behavior
When a player clicks a choice with SFX:
1. Scene transitions immediately (background, characters update)
2. **150ms pause** - Lets the new scene visuals settle
3. **SFX plays** - Music is ducked to 20% volume
4. **200ms pause** - After SFX finishes
5. **Music & text start** - Full music volume, typewriter begins

This creates the classic VN feel where audio feedback follows player actions.

### General Audio Behavior
- Background music loops indefinitely until changed
- Only one music track plays at a time (new track replaces old)
- Music is automatically ducked during SFX playback
- Audio requires user interaction to start (browser policy)
- A mute button is available in the UI

---

## 14. Asset Inventory

### Backgrounds (`assets/bg/`)

**Supported formats:**
- **Static**: `.jpg`, `.png` (best for most scenes)
- **Animated CSS**: `.gif`, `.webp` (uses CSS background-image, good browser support)
- **Animated Video**: `.webm`, `.mp4` (uses `<video>` element, best quality/compression)

**Fallback for older browsers:**
For animated backgrounds, provide a static `.jpg` fallback with the same base name. The engine will automatically use the animated version on modern browsers.

**Example usage:**
```yaml
bg: spooky_forest.webm      # Video background
bg: glitch_effect.gif       # Animated GIF
bg: hallway_fluorescent.jpg # Static image
```

**Current static backgrounds:**
- hallway_fluorescent.jpg
- stairwell_landing.jpg
- hallway_red_alert.jpg
- stairwell_escape.jpg
- hallway_dim.jpg
- office_corridor.jpg
- meeting_room_whiteboard.jpg
- office_kitchen.jpg
- bedroom_morning.jpg
- dark_office_desk.jpg
- desk_computer_code.jpg
- back_stairwell_dim.jpg
- sunny_street_freedom.jpg

### Character Sprites (`assets/char/`)
All SVG format, 200x400 viewBox:
- agnes_neutral.svg, agnes_happy.svg, agnes_angry.svg, agnes_blocking.svg, agnes_surprised.svg, agnes_victorious.svg
- joni_desperate.svg
- norbert_pleading.svg, norbert_grabbing.svg
- fabio_friendly.svg
- ali_friendly.svg
- michi_whiteboard.svg
- gilles_explaining.svg
- ruling_pointing.svg
- security_guard_waving.svg

---

## 15. Scene Editor

A visual editor is available at `editor/index.html` for creating and editing scenes without manually writing Markdown.

### Features
- **Scene list** with visual indication of modified scenes
- **Background selector** with preview
- **Character sprite placement** via drag-and-drop on canvas
- **Music selector** with preview playback
- **Text block editor** with navigation between blocks
- **Choice editor** with:
  - Button text
  - Target scene (with autocomplete)
  - Sound effect dropdown
  - Requires/Sets flags
- **Dice roll action** configuration
- **Graph view** showing scene connections
- **Preview in game** button for quick testing
- **Save/Download** individual scenes or all scenes as ZIP

### Usage
1. Open `editor/index.html` in browser
2. Select a scene from the list or create new
3. Edit using the visual interface
4. Click "Save" to download the `.md` file
5. Place the file in `scenes/` folder
6. Run `python tools/build_story_from_md.py` to regenerate story.js

### Editor Files
```
editor/
‚îú‚îÄ index.html      (editor HTML structure)
‚îú‚îÄ editor.js       (editor logic)
‚îî‚îÄ editor.css      (editor styling)
```

The editor generates Markdown files compatible with `build_story_from_md.py`.

---

## 16. Theme System

The VN supports multiple visual themes that can be switched via configuration or dev mode.

### Available Themes

| Theme | Description | Font |
|-------|-------------|------|
| `prototype` | Original warm beige VN style with cream text box and golden brown buttons | System serif |
| `70s` | Retro disco (orange, brown, gold, avocado green) | Righteous |
| `80s` | Synthwave neon (hot pink, electric blue, chrome, scanlines) | Orbitron |
| `90s` | Windows 3.1 / Early Mac aesthetic (gray panels, blue titlebars) | Silkscreen |
| `cyberpunk` | Neon city (yellow/cyan on black, grid patterns, tech noir) | Share Tech Mono |
| `dos` | MS-DOS terminal (green on black, CRT scanlines, command prompt) | VT323 |
| `dragonball` | Dragon Ball Z inspired (orange/blue energy, power-up auras) | Bangers |
| `finalfantasy` | Classic JRPG menu (blue gradients, white text, crystal motifs) | Press Start 2P |
| `gameboy` | Original Game Boy (4-shade green palette, pixelated filter) | Press Start 2P |
| `harrypotter` | Wizarding World (burgundy/gold, magical sparkles, parchment) | Cinzel |
| `lotr` | Lord of the Rings (parchment, gold, forest green, elvish elegance) | Cinzel |
| `manga` | Junji Ito horror manga (stark black & white, high contrast) | Permanent Marker |
| `nes` | 8-bit NES (limited palette, pixel font, chunky borders) | Press Start 2P |
| `snes` | 16-bit SNES (richer colors, gradients, star field) | Press Start 2P |
| `spaceopera` | Epic sci-fi (deep space, nebula colors, starfield, hologram cyan) | Orbitron |
| `starwars` | Star Wars inspired (space black, yellow crawl text, starfield) | Bebas Neue |
| `vaporwave` | A E S T H E T I C pink/cyan/purple with grid patterns | VT323 |
| `y2k` | Millennium aesthetic (chrome silver, translucent, tech optimism) | Audiowide |
| `zelda` | Legend of Zelda (forest green, Triforce gold, adventure RPG) | Press Start 2P |

### Theme Selection

Themes are selected by editing `theme.md` in the project root:

```markdown
# Theme Configuration
prototype [ ]
90s [x]
```

- Mark the desired theme with `[x]`
- Mark other themes with `[ ]`
- Run `python tools/build_story_from_md.py` to apply the change

### Creating New Themes

1. Create a new CSS file in `css/themes/` (e.g., `css/themes/mytheme.css`)
2. Copy the structure from an existing theme
3. Modify colors, fonts, borders, and styling
4. Add the theme name to `theme.md`
5. Run the build script

### Theme CSS Requirements

Each theme CSS must define styles for:
- Password overlay (`#password-overlay`, `#password-container`, `.password-char`)
- Main container (`#vn-wrapper`, `#vn-container`)
- Background and sprite layers (`#background-layer`, `#sprite-layer`)
- Text box (`#text-box`, `#story-output`)
- Controls (`#text-controls`, `.speed-btn`, `.mute-btn`)
- Buttons (`.choice-button`, `.continue-button`, `.restart-button`)
- Game over state (`.game-over`)
- Responsive breakpoints (landscape and portrait)

### Dev Mode Theme Switching

In dev mode (hold q+w+e+r+t), a theme selector dropdown appears allowing live theme switching without rebuilding. This is useful for testing themes during development.

### Generated Files

The build script generates `js/theme.js` containing:
```javascript
const themeConfig = {
  "selected": "90s",
  "available": ["prototype", "90s"]
};
```

This is loaded by `index.html` to dynamically set the correct theme CSS.

### Theme Persistence

The selected theme is saved to `localStorage` (key: `andi_vn_theme`) so it persists across page reloads.

---

## 17. Font Library (`assets/fonts/`)

All fonts are stored locally for offline USB deployment. Fonts are organized by family in subfolders.

### Display & Theme Fonts

| Font | Style | Theme Usage | File |
|------|-------|-------------|------|
| **Orbitron** | Sci-fi geometric | 80s synthwave | `Orbitron/Orbitron-VariableFont_wght.ttf` |
| **VT323** | CRT terminal | Vaporwave | `VT323/VT323-Regular.ttf` |
| **Press Start 2P** | 8-bit pixel | NES, SNES | `Press_Start_2P/PressStart2P-Regular.ttf` |
| **Bangers** | Comic/anime | Dragon Ball | `Bangers/Bangers-Regular.ttf` |
| **Bebas Neue** | Condensed display | Star Wars | `Bebas_Neue/BebasNeue-Regular.ttf` |
| **Righteous** | 70s groovy | 70s disco | `Righteous/Righteous-Regular.ttf` |
| **Silkscreen** | Pixel bitmap | 90s Windows | `Silkscreen/Silkscreen-Regular.ttf` |
| **Permanent Marker** | Hand-drawn | Manga | `Permanent_Marker/PermanentMarker-Regular.ttf` |
| **Special Elite** | Typewriter | Prototype alt | `Special_Elite/SpecialElite-Regular.ttf` |

### Sci-Fi & Futuristic Fonts

| Font | Style | File |
|------|-------|------|
| **Audiowide** | Wide sci-fi | `Audiowide/Audiowide-Regular.ttf` |
| **Staatliches** | Bold condensed | `Staatliches/Staatliches-Regular.ttf` |
| **Zen Dots** | Futuristic pixel | `Zen_Dots/ZenDots-Regular.ttf` |
| **Teko** | Tech condensed | `Teko/Teko-VariableFont_wght.ttf` |
| **Share Tech Mono** | Monospace terminal | `Share_Tech_Mono/ShareTechMono-Regular.ttf` |

### Bold & Action Fonts

| Font | Style | File |
|------|-------|------|
| **Black Ops One** | Military stencil | `Black_Ops_One/BlackOpsOne-Regular.ttf` |
| **Russo One** | Bold slavic | `Russo_One/RussoOne-Regular.ttf` |
| **Bungee** | Bold display | `Bungee/Bungee-Regular.ttf` |
| **Faster One** | Speed/racing | `Faster_One/FasterOne-Regular.ttf` |
| **Rubik Mono One** | Chunky mono | `Rubik_Mono_One/RubikMonoOne-Regular.ttf` |
| **Wallpoet** | Stencil graffiti | `Wallpoet/Wallpoet-Regular.ttf` |

### Horror & Decorative Fonts

| Font | Style | File |
|------|-------|------|
| **Creepster** | Horror dripping | `Creepster/Creepster-Regular.ttf` |
| **Nosifer** | Horror blood | `Nosifer/Nosifer-Regular.ttf` |
| **Monoton** | Retro outline | `Monoton/Monoton-Regular.ttf` |

### Alien & Sci-Fi Language Fonts

| Font | Style | File |
|------|-------|------|
| **Iceberg** | Angular alien | `Iceberg/Iceberg-Regular.ttf` |
| **Megrim** | Thin futuristic | `Megrim/Megrim-Regular.ttf` |
| **Nova Square** | Geometric alien | `Nova_Square/NovaSquare-Regular.ttf` |
| **Xanh Mono** | Quirky alien-ish | `Xanh_Mono/XanhMono-Regular.ttf` |

### Cipher/Symbol Fonts (Unreadable Alien Languages)

| Font | Maps To | Best For | File |
|------|---------|----------|------|
| **Aurebesh** | Latin alphabet | Star Wars alien text | `Aurebesh.otf` |
| **Galactic Basic** | Latin alphabet | Star Wars (alternate) | `galbasic.ttf` |
| **Klingon** | Latin alphabet | Star Trek alien text | `klingon font.ttf` |
| **Elvish Ring** | Latin alphabet | Fantasy/LOTR text | `elvish ring nfi.ttf` |
| **Alien Encounters** | Latin alphabet | Generic sci-fi alien | `Alien-Encounters-Regular.ttf` |
| **Noto Sans Symbols 2** | Unicode symbols | Decorative symbols | `Noto_Sans_Symbols_2/NotoSansSymbols2-Regular.ttf` |

### Using Fonts in Theme CSS

```css
/* Load font at top of theme CSS */
@font-face {
    font-family: 'Orbitron';
    src: url('../assets/fonts/Orbitron/static/Orbitron-Regular.ttf') format('truetype');
    font-weight: 400;
}

/* Apply to body */
body {
    font-family: 'Orbitron', 'Arial Black', sans-serif;
}

---

## 18. Inventory System

The VN supports a simple item-based inventory system for key items and consumables.

### Adding Items to Inventory

Use `add_items` in scene frontmatter:

```yaml
---
id: find_key
add_items:
  - Master Key
  - Coffee Mug
---

You found a Master Key and a Coffee Mug!
```

### Removing Items from Inventory

Use `remove_items` in scene frontmatter:

```yaml
---
id: lose_key
remove_items:
  - Master Key
---

The key breaks in the lock!
```

### Using Items in Choices

**Require an item to show a choice:**
```markdown
- Open the locked door (require_items: Master Key) ‚Üí secret_room
```

**Consume an item when selecting a choice:**
```markdown
- Use the key (uses: Master Key) ‚Üí unlocked_door
```

### Inventory Display

- Items appear in a floating panel in the top-left corner
- Panel only shows when player has at least one item
- Adding/removing items shows a floating notification

### Engine API

```javascript
// Add an item
VNEngine.addItem('Master Key');

// Remove an item
VNEngine.removeItem('Master Key');

// Check if player has an item
VNEngine.hasItem('Master Key');  // returns true/false

// Get all items
VNEngine.getInventory();  // returns ['Master Key', ...]
```

---

## 19. Battle System

The VN includes a Pokemon-style turn-based battle system with DnD d20 mechanics.

### Features Overview

- **Turn-based combat**: Player action ‚Üí Enemy action ‚Üí Repeat
- **D20 attack rolls**: Roll + bonus vs AC, nat 20 crit, nat 1 fumble
- **Mana system**: 20-40 MP pool for skills, Defend recovers MP
- **Status effects**: Burn, Poison, Stun, Frozen, Bleed, Buffs
- **Type advantages**: D&D-style vulnerabilities (2x) and resistances (0.5x)
- **Smart Enemy AI**: Health-based decision making
- **Stagger system**: Build up stagger to stun enemies
- **Terrain effects**: Map modifiers that affect combat
- **Skills**: Mana-cost abilities with status effects

### Starting a Battle

Use the `start_battle` action in scene frontmatter:

```yaml
---
id: boss_fight
bg: office_corridor.jpg
music: BOSS_TIME.mp3
chars:
  - agnes_angry.svg
actions:
  - type: start_battle
    player_max_hp: 20
    player_max_mana: 20
    player_ac: 10
    player_attack_bonus: 2
    player_damage: d6
    player_skills:
      - power_strike
      - fireball
      - heal
      - fortify
    terrain: none
    enemy:
      name: Agnes
      hp: 30
      ac: 12
      attack_bonus: 3
      damage: d8
      type: physical
      ai: aggressive
      stagger_threshold: 60
      moves:
        - name: Attack
          damage: d8
          type: physical
        - name: Fire Breath
          damage: 2d6
          type: fire
          statusEffect:
            type: burn
            chance: 0.3
    win_target: agnes_defeated
    lose_target: game_over_agnes
    flee_target: ran_away
---
```

### Battle Configuration Fields

| Field | Required | Default | Description |
|-------|----------|---------|-------------|
| `player_max_hp` | No | 20 | Player starting HP |
| `player_max_mana` | No | 20 | Player starting MP |
| `player_ac` | No | 10 | Player Armor Class |
| `player_attack_bonus` | No | 2 | Bonus to player attack rolls |
| `player_damage` | No | d6 | Player base damage dice |
| `player_skills` | No | power_strike, fireball, heal | Array of skill IDs |
| `terrain` | No | none | Terrain type for battle |
| `enemy.name` | Yes | Enemy | Enemy display name |
| `enemy.hp` | No | 20 | Enemy HP |
| `enemy.ac` | No | 12 | Enemy Armor Class |
| `enemy.attack_bonus` | No | 3 | Enemy attack bonus |
| `enemy.damage` | No | d6 | Enemy base damage |
| `enemy.type` | No | physical | Enemy elemental type |
| `enemy.ai` | No | default | AI behavior type |
| `enemy.stagger_threshold` | No | 80 | Stagger needed to stun |
| `enemy.moves` | No | basic attack | Array of enemy moves |
| `win_target` | Yes | - | Scene ID on victory |
| `lose_target` | Yes | - | Scene ID on defeat |
| `flee_target` | No | null | Scene ID on successful flee |

### Battle Choices

Define battle actions in the choices section:

```markdown
### Choices

- Attack! (battle: attack) ‚Üí battle_continue
- Use a skill! (battle: skill) ‚Üí battle_continue
- Defend (battle: defend) ‚Üí battle_continue
- Run Away (battle: flee) ‚Üí battle_continue
```

Battle action types:
- `attack`: Roll d20 + bonus vs enemy AC, deal damage on hit
- `skill`: Opens skill selection submenu (uses mana)
- `defend`: Gain +4 AC until next turn, recover 2-4 MP
- `flee`: Roll d20, need 10+ to escape to flee_target
- `item`: Use item (with `heals` for HP restoration)

### Combat Mechanics

**Attack Rolls:**
- Roll d20 + attack bonus vs target AC
- Add status effect bonuses (attack_up: +2)
- Subtract terrain penalties (darkness: -2)
- Natural 20: Critical hit (double damage, always hits)
- Natural 1: Critical fumble (always misses)

**Damage Calculation:**
1. Roll damage dice (e.g., 2d6)
2. Add status damage bonus (attack_up: +2)
3. Apply type multiplier (2x, 1x, 0.5x, or 0x)
4. Apply terrain multiplier (e.g., lava boosts fire 25%)
5. Double on critical hit
6. Minimum 1 damage

**Turn Order:**
1. Player status effects tick (DOT damage, duration -1)
2. Check if player can act (not stunned/frozen)
3. Player selects and executes action
4. Check if enemy defeated
5. Enemy status effects tick
6. Check if enemy can act
7. Enemy AI selects and executes action
8. Check if player defeated
9. Next turn

### Available Skills

| Skill ID | Name | MP | Type | Effect |
|----------|------|-----|------|--------|
| power_strike | Power Strike | 3 | physical | 2d6 damage, +1 attack |
| whirlwind | Whirlwind | 5 | physical | 1d8 damage |
| fireball | Fireball | 4 | fire | 2d6 damage, 30% burn |
| flame_burst | Flame Burst | 6 | fire | 3d4 damage, 50% burn |
| ice_shard | Ice Shard | 3 | ice | 1d8 damage, 20% freeze |
| blizzard | Blizzard | 7 | ice | 2d6 damage, 40% freeze |
| shock | Shock | 3 | lightning | 1d10 damage, 25% stun |
| thunderbolt | Thunderbolt | 6 | lightning | 2d8 damage, 35% stun |
| toxic_strike | Toxic Strike | 2 | poison | 1d4 damage, 60% poison |
| venom_spray | Venom Spray | 4 | poison | 1d6 damage, 80% 2x poison |
| smite | Smite | 4 | holy | 2d6 holy damage |
| heal | Heal | 4 | - | Heal 2d4+2 HP |
| regenerate | Regenerate | 5 | - | Apply regen buff |
| fortify | Fortify | 3 | - | +2 AC for 2 turns |
| empower | Empower | 3 | - | +2 attack/damage for 3 turns |

### Status Effects

| Status | Icon | Duration | Effect |
|--------|------|----------|--------|
| Burn | üî• | 3 turns | 2 damage/turn |
| Poison | ‚ò†Ô∏è | 4 turns | 1 damage/turn (stacks) |
| Stun | ‚ö° | 1 turn | Skip turn |
| Frozen | ‚ùÑÔ∏è | 2 turns | Skip turn, -2 AC |
| Bleed | ü©∏ | 3 turns | 1 damage/turn, +1 when attacking |
| Defense Up | üõ°Ô∏è | 2 turns | +2 AC |
| Attack Up | ‚öîÔ∏è | 3 turns | +2 attack and damage |
| Regen | üíö | 3 turns | Heal 2 HP/turn |

### Type Chart

| Attack ‚Üì / Defender ‚Üí | Physical | Fire | Ice | Lightning | Poison | Psychic | Holy | Dark |
|----------------------|----------|------|-----|-----------|--------|---------|------|------|
| Physical | 1x | 1x | 1x | 1x | 1x | 1x | 1x | 1x |
| Fire | 1x | 0.5x | 2x | 1x | 1x | 1x | 1x | 1x |
| Ice | 1x | 0.5x | 0.5x | 2x | 1x | 1x | 1x | 1x |
| Lightning | 1x | 1x | 0.5x | 0.5x | 1x | 1x | 1x | 1x |
| Poison | 1x | 1x | 1x | 1x | 0.5x | 2x | 1x | 1x |
| Psychic | 1x | 1x | 1x | 1x | 1x | 0.5x | 1x | 0x |
| Holy | 1x | 1x | 1x | 1x | 1x | 1x | 0.5x | 2x |
| Dark | 1x | 1x | 1x | 1x | 1x | 2x | 0.5x | 0.5x |

### Terrain Types

| Terrain | Icon | Effect |
|---------|------|--------|
| none | - | No effects |
| lava | üåã | Fire +25%, Ice -25%, +20% burn chance |
| ice | üßä | Ice +25%, Fire -25%, +20% freeze chance |
| swamp | üê∏ | Poison +25%, +30% poison chance |
| storm | ‚õàÔ∏è | Lightning +25%, +15% stun chance |
| holy_ground | ‚ú® | Holy +50%, Dark -50%, 1 HP regen/turn |
| darkness | üåë | Dark +50%, Holy -50%, -2 accuracy |

### Enemy AI Types

| AI Type | Behavior |
|---------|----------|
| default | Smart: heal when low (<25%), buff when high (>75%), go for kill when player low |
| aggressive | Always attacks, prefers high-damage moves |
| defensive | Heals when <30% HP, buffs when >70% HP |
| support | 50% chance to use status moves, heals when <40% HP |

### Stagger System

- Each hit adds stagger to target (damage / 2)
- When stagger reaches threshold, target is stunned
- Stagger decays 10-20 per turn
- Defending reduces stagger by 15

### Visual Feedback

- **HP/MP Bars**: Player (bottom-left), Enemy (top-right)
- **Stagger Bar**: Orange bar below HP, turns red when high
- **Status Icons**: Displayed next to HP with duration tooltips
- **Terrain Indicator**: Shows at top-center when active
- **Damage Numbers**: Float up from target (red damage, green heal, purple DOT)
- **Attack Effects**: Type-colored flash overlay on hit
- **Damage Flash**: Sprites flash when hit
- **Screen Shake**: Container shakes when player hit
- **Battle Log**: Shows rolls, damage, status messages

### HP/MP Persistence

- Player HP/MP persist across scenes (saved to localStorage)
- HP/MP only initializes on first battle encounter
- HP can be restored via `heals` modifier on choices
- MP recovers 2-4 when defending

### BattleEngine API

```javascript
// Check if battle active
BattleEngine.isActive();

// Get player stats
BattleEngine.getPlayerStats();  // { hp, maxHP, mana, maxMana }
BattleEngine.getPlayerSkills(); // [{ id, name, manaCost, canUse }]

// Execute action
BattleEngine.executeAction('attack', { move: {...} }, callback);
BattleEngine.executeAction('skill', { skillId: 'fireball' }, callback);
BattleEngine.executeAction('defend', {}, callback);
BattleEngine.executeAction('item', { heals: 5 }, callback);
BattleEngine.executeAction('flee', {}, callback);

// Status effects
BattleEngine.applyStatusTo('player', 'burn', 1);
BattleEngine.applyStatusTo('enemy', 'poison', 2);

// Healing
BattleEngine.healPlayer(10);
BattleEngine.restoreMana(5);

// Get definitions
BattleEngine.skills;         // All skill definitions
BattleEngine.statusEffects;  // All status effect definitions
BattleEngine.terrainTypes;   // All terrain definitions
```

---

## 20. Game State Persistence

The engine automatically saves game state to localStorage:

### Saved Data
- Current scene and text block position
- All flags
- Inventory items
- Player HP (if initialized)
- Scene history (for undo in dev mode)
- Read blocks (for skip button)

### Save Key
Default: `andi_vn_save`

### Reset Options
- **Play Again** (game over): Resets flags, inventory, HP, but keeps read history
- **Reset Progress** (‚Ü∫ button): Full reset including read history

---

## 21. Testing & Quality Assurance

### Automated Tests

Run tests from the project root:

```bash
# Run battle system tests (177 tests)
node tests/run-tests.js

# Run theme CSS validation tests (126 tests)
node tests/run-theme-tests.js
```

### Manual Testing Checklist

#### Core VN Functionality
- [ ] Password screen accepts correct password
- [ ] Password screen shows errors on wrong attempts
- [ ] Text blocks display with typewriter effect
- [ ] Continue button advances text
- [ ] Choice buttons appear after final text block
- [ ] Choices navigate to correct scenes
- [ ] Backgrounds load and transition smoothly
- [ ] Character sprites display correctly
- [ ] Music plays and loops
- [ ] Sound effects play on choices (with `[sfx: ...]`)
- [ ] Mute button works
- [ ] Speed controls work (Normal, Fast, Auto, Skip)

#### Battle System
- [ ] Battle intro transition plays (screen dim, "Battle Start!" text, flash)
- [ ] HP bars display for player and enemy
- [ ] Mana bar displays and updates correctly
- [ ] Attack action: roll shows, hit/miss feedback, damage numbers float up
- [ ] Skill menu opens and shows available skills with mana costs
- [ ] Skills consume mana correctly
- [ ] Defend action: shows +4 AC message, recovers MP
- [ ] Flee action: shows roll, success/failure result
- [ ] Status effects: icons display, duration ticks down
- [ ] Stagger bar fills on damage
- [ ] Limit Break bar fills over battle
- [ ] Victory outro: screen effect, "Victory!" text, sparkles
- [ ] Defeat outro: screen effect, "Defeated" text
- [ ] Battle transitions to correct win/lose/flee scenes

#### Sound Cues (Battle)
- [ ] Battle start alert sound plays
- [ ] Dice roll sound on attacks
- [ ] Hit sound (thud) on successful attacks
- [ ] Miss sound on failed attacks
- [ ] Critical hit sound (success)
- [ ] Fumble sound (failure)
- [ ] Heal sound (success) on healing
- [ ] Defend click sound
- [ ] Victory fanfare on win
- [ ] Defeat sound on loss
- [ ] Type-specific sounds (fire=zap, ice=chain, etc.)

#### Theme Testing
- [ ] Each theme loads without CSS errors
- [ ] Theme selector (dev mode) switches themes live
- [ ] Battle UI renders correctly in each theme
- [ ] HP/MP bars visible in all themes
- [ ] Choice buttons readable in all themes
- [ ] Text box visible and readable in all themes

#### Browser Compatibility
- [ ] Chrome (latest) - full functionality
- [ ] Firefox (latest) - full functionality
- [ ] Safari (latest) - full functionality
- [ ] Edge (latest) - full functionality
- [ ] Mobile Safari (iOS) - touch, audio autoplay policy
- [ ] Chrome Mobile (Android) - touch, audio autoplay policy

#### Edge Cases
- [ ] Rapid clicking during transitions doesn't break state
- [ ] Refreshing during battle resumes correctly (or resets gracefully)
- [ ] Very long text blocks scroll within text box
- [ ] Multiple status effects stack correctly
- [ ] Mana can't go negative
- [ ] HP can't exceed max HP
- [ ] Empty inventory doesn't show inventory panel

### Battle Balance Testing

Test the Agnes (HR) battle specifically:

| Metric | Target | Method |
|--------|--------|--------|
| Win rate | ~60-70% | Play 10 times with varied strategies |
| Turns to win | 5-8 | Track average fight length |
| Near-death moments | 1-2 per fight | Exciting but not frustrating |
| Skill variety | Use all skills | All skills should be situationally useful |
| Flee success | ~50% | Roll-based, feels fair |

### Performance Testing

- [ ] Initial load time < 3 seconds
- [ ] Scene transitions < 500ms
- [ ] No memory leaks during long sessions
- [ ] Battle animations run at 60fps
- [ ] Audio doesn't clip or lag

### Accessibility

- [ ] Text readable at default font size
- [ ] Sufficient color contrast
- [ ] Buttons have clear hover/focus states
- [ ] Game playable with keyboard (arrow keys, enter)

### Pre-Release Checklist

1. [ ] Run `python tools/build_story_from_md.py` to generate story.js
2. [ ] Run `node tests/run-tests.js` - all 177 tests pass
3. [ ] Run `node tests/run-theme-tests.js` - all 126 tests pass
4. [ ] Test password (correct + 5 wrong attempts)
5. [ ] Play through main story path
6. [ ] Test at least one battle encounter
7. [ ] Test on mobile device
8. [ ] Verify all assets load (no 404 errors in console)
9. [ ] Remove any debug console.log statements
10. [ ] Verify dev mode is hidden by default
