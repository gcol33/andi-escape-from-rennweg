# Andi VN — Project Overview and Development Rules

This document defines how the project is structured, how files are organized, and the coding conventions we follow. No numbers for scenes, endings, or prompts are fixed here; this document only describes architecture and rules.

---

## 1. Project Goal

Build a small, static-site visual novel (VN) for Andi's PhD farewell.
The focus is on:

- simple branching story structure
- fast iteration
- minimal dependencies
- clean separation between engine and story
- easy collaboration (anyone can edit the story without touching code)

The final product is a **single-page VN** that loads story data and images dynamically.

---

## 2. High-Level Architecture

The VN consists of four layers:

1. **HTML shell**
   - The static structure of the page.
   - Contains only empty containers for text, buttons, and images.

2. **VN engine (JavaScript)**
   - Handles loading the story, updating the UI, rendering backgrounds and character sprites, managing flags, and handling branching logic.
   - Interprets actions (e.g. dice rolls) via a handler registry.
   - No story text lives here.

3. **Story data (generated)**
   - A single file (`js/story.js`) containing all narrative content.
   - Generated from Markdown scene files by the static site generator.
   - Includes: scene IDs, text blocks, choices, flags, background references, sprite references, actions.

4. **Scene source files (Markdown)**
   - One `.md` file per scene in the `scenes/` folder.
   - Human-readable format with YAML frontmatter and narrative text.
   - This is the **source of truth** for all story content.

This separation ensures the engine is stable, writers only edit Markdown, and the build step produces clean data.

---

## 3. Folder Structure

```
Andi/
│
├─ index.html
│
├─ css/
│   └─ style.css
│
├─ js/
│   ├─ engine.js
│   └─ story.js        (generated - do not edit manually)
│
├─ scenes/
│   └─ *.md            (source of truth for story)
│
├─ assets/
│   ├─ bg/
│   ├─ char/
│   └─ sfx/
│
├─ tools/
│   └─ build_story_from_md.py
│
└─ prototype/
    └─ andy.html       (original prototype for reference)
```

### index.html
Contains:
- empty containers for story text, choices, backgrounds, sprites
- continue button for text block progression
- links to CSS and JS
- no story text or logic code allowed

### css/style.css
Defines:
- layout
- background and sprite positioning
- text formatting
- continue button and choice button styling
- transitions
No inline styles permitted.

### js/engine.js
Contains VN logic:
- load story data from `story.js`
- maintain state (current scene, current text block index, flags)
- update UI
- render backgrounds and sprites
- step through text blocks with "Continue" button
- show choices after final text block
- execute actions via handler registry
- manage branching
- **never contains story text**

### js/story.js
Contains **only generated narrative data**:
- scenes with `id`, `textBlocks`, `choices`, `actions`
- `bg` and `chars` fields
- flags: `set_flags`, `require_flags`
- **Do not edit manually** — generated by `build_story_from_md.py`

### scenes/*.md
Contains **source story content**:
- one file per scene
- YAML frontmatter for metadata
- text blocks separated by `---`
- choices section at the end
- **This is what writers edit**

---

## 4. Scene Model (Markdown Format)

Each scene is a single Markdown file in `scenes/` with this structure:

```markdown
---
id: scene_id
bg: background_filename.jpg
chars:
  - character1.svg
  - character2.svg
set_flags:
  - flag_to_set
require_flags:
  - flag_required
actions:
  - type: roll_dice
    dice: d20
    threshold: 13
    success_target: success_scene
    failure_target: failure_scene
---

First text block. This is shown when the scene loads.

The player clicks "Continue" to advance.

---

Second text block. This appears after the first "Continue" click.

You can have as many text blocks as needed.

---

Third and final text block.

After this, choices are shown (or actions execute).

### Choices

- Go left → left_scene
- Go right → right_scene
- Stay here (requires: has_key) → locked_room
```

### Frontmatter Fields

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique scene identifier |
| `bg` | No | Background image filename (in `assets/bg/`) |
| `chars` | No | Array of character sprite filenames (in `assets/char/`) |
| `set_flags` | No | Array of flags to set when entering this scene |
| `require_flags` | No | Array of flags required to enter this scene |
| `actions` | No | Array of action objects (see Actions section) |

### Text Blocks

- Separated by `---` (horizontal rule)
- Each block is a separate "Continue" click
- Support Markdown formatting: `**bold**`, `*italic*`
- Background and characters remain constant throughout the scene
- No visual changes between blocks (only at scene transitions)

### Choices Section

- Must be under `### Choices` heading
- Each choice is a list item: `- Label text → target_id`
- Optional flag requirements: `- Label (requires: flag_name) → target_id`
- Optional flag setting: `- Label (sets: flag_name) → target_id`
- Choices only appear after all text blocks are shown
- If no choices and no actions, scene is a game over / ending

---

## 5. Actions Model

Actions are special behaviors that execute after all text blocks are shown (but before choices). They are defined in the frontmatter `actions` array.

### Supported Action Types

#### `roll_dice`
Performs a dice roll and navigates based on result.

```yaml
actions:
  - type: roll_dice
    dice: d20
    threshold: 13
    success_target: success_scene
    failure_target: failure_scene
```

Parameters:
- `dice`: Dice type (d4, d6, d8, d10, d12, d20, d100)
- `threshold`: Number to roll at or below to succeed
- `success_target`: Scene ID to go to on success
- `failure_target`: Scene ID to go to on failure

#### `custom` (for future extensibility)
Calls a named handler with parameters.

```yaml
actions:
  - type: custom
    handler: showSpecialEvent
    params:
      difficulty: hard
      reward: golden_key
```

### Action Handler Registry

The engine maintains an `actionHandlers` object that maps action types to handler functions:

```javascript
const actionHandlers = {
    roll_dice: (action, state) => { /* ... */ },
    custom: (action, state) => { /* ... */ }
};
```

New action types can be added by registering handlers in the engine.

---

## 6. Static Site Generator

The script `tools/build_story_from_md.py` processes scene files:

### Input
- All `.md` files in `scenes/` directory

### Processing
1. Parse YAML frontmatter
2. Extract text blocks (split by `---`)
3. Parse `### Choices` section into structured choice objects
4. Build scene objects with all fields

### Output
- Generates `js/story.js` with a JavaScript object containing all scenes

### Validation
The generator validates:
- All `target` IDs in choices exist as scene IDs
- No duplicate scene IDs
- Required frontmatter fields are present
- Warns about unreachable scenes

### Usage
```bash
python tools/build_story_from_md.py
```

---

## 7. VN "Continue" Behavior

The engine implements a text block progression system:

1. **Scene Load**: Show first text block, display "Continue" button
2. **Continue Click**: Advance to next text block
3. **Last Block**: Hide "Continue", either:
   - Execute actions (e.g. dice roll), which navigates to next scene
   - Show choice buttons
   - Show "Play Again" if no choices (ending)

### State Tracking
- `currentSceneId`: Which scene we're in
- `currentBlockIndex`: Which text block we're showing (0-indexed)
- `flags`: Set of string flags

---

## 8. Coding Standards

### General
- Always separate content (story) from logic (engine)
- No story text inside engine code
- No logic inside story data
- Writers only edit Markdown files, never JS
- No global variables except the engine namespace

### JavaScript
- Use clear, minimal functions
- Keep engine.js stable and rarely edited
- Action handlers should be pure functions where possible

### Markdown (Scene Files)
- Use lowercase with underscores for IDs: `main_stairs`, `lost_to_coffee`
- Keep text blocks focused (one idea per block)
- Use `---` only for block separators
- Put choices at the very end of the file

### Assets
- Background filenames: lowercase with underscores, `.jpg` extension
- Character sprites: lowercase with underscores, `.svg` extension
- All assets stored inside `assets/`

---

## 9. Development Workflow

### For Writers
1. Create or edit `.md` files in `scenes/`
2. Run `python tools/build_story_from_md.py`
3. Reload browser to test
4. Repeat

### For Developers
1. Edit `js/engine.js` for logic changes
2. Edit `css/style.css` for visual changes
3. Edit `index.html` for structure changes
4. Run the build script after scene changes

The workflow must stay frictionless.
Story writers should never touch engine code.

---

## 10. UI Layout

The VN uses a traditional visual novel layout:

- **Fixed 16:9 aspect ratio** container (`#vn-container`)
- **Background layer** fills the entire container
- **Character sprites** positioned in the middle area
- **Text box** occupies the lower ~32% with semi-transparent cream background
- **Continue button** appears below text when more blocks remain
- **Choice buttons** appear after final text block
- **Title** ("Andy's Farewell") displayed above the game container

### Theme Colors (preserved from original design)
- Page background: `#f2e7d5` (warm beige)
- Text color: `#4b3e2a` (dark brown)
- Text box: `rgba(250, 241, 224, 0.95)` (cream, semi-transparent)
- Buttons: `#b08b5a` (golden brown)
- Button text: `#fffbe9` (cream white)
- Accents/borders: `#d3c2a8` (light brown)

---

## 11. Engine Features

### Text Speed Controls
Located in the upper-right of the text box. Uses symbol buttons:
- **▶** Normal (30ms per character)
- **▶▶** Fast (10ms per character)
- **▶|** Auto (30ms + auto-advances after 1.5s delay when single choice)
- **⏭** Skip (instant display, only visible after at least one block has been read)

### Typewriter Effect
- Text displays character-by-character with blinking cursor
- HTML tags (like `<strong>`) are rendered instantly, only text characters are typed
- Markdown bold (`**text**`) is converted to `<strong>` tags
- Click on text area or press Space to skip (only for already-read blocks)

### Read Block Tracking
- `state.readBlocks` tracks which scene+block combinations have been displayed
- First-time readers cannot skip the typewriter effect
- Skip button only appears after at least one block has been read
- Already-read text shows "(already read)" indicator

### Developer Mode
- Hold **q+w+e+r+t** keys simultaneously to toggle dev mode
- Dev mode allows skipping any text, even on first read
- Green "DEV MODE" indicator appears in top-right corner

### Dice Roll Mechanics
- Defined in scene frontmatter via `actions` array
- Supports different dice types (d20, d6, etc.)
- Roll result determines which scene to navigate to
- Shows roll result message before transitioning

### Choice Buttons
- Displayed horizontally in a single row (never wrap)
- Use `flex: 1 1 0` to distribute space evenly
- Game over states show "Play Again" restart button

---

## 12. Generated Story Structure

The `js/story.js` file contains a JavaScript object like:

```javascript
const story = {
    "scene_id": {
        id: "scene_id",
        bg: "background.jpg",
        chars: ["character.svg"],
        set_flags: [],
        require_flags: [],
        actions: [],
        textBlocks: [
            "First text block...",
            "Second text block..."
        ],
        choices: [
            {
                label: "Choice text",
                target: "target_scene_id",
                require_flags: [],
                set_flags: []
            }
        ]
    }
};
```

---

## 13. Asset Inventory

### Backgrounds (`assets/bg/`)
- hallway_fluorescent.jpg
- stairwell_landing.jpg
- hallway_red_alert.jpg
- stairwell_escape.jpg
- hallway_dim.jpg
- office_corridor.jpg
- meeting_room_whiteboard.jpg
- office_kitchen.jpg
- bedroom_morning.jpg
- dark_office_desk.jpg
- desk_computer_code.jpg
- back_stairwell_dim.jpg
- sunny_street_freedom.jpg

### Character Sprites (`assets/char/`)
All SVG format, 200x400 viewBox:
- agnes_neutral.svg, agnes_happy.svg, agnes_angry.svg, agnes_blocking.svg, agnes_surprised.svg, agnes_victorious.svg
- joni_desperate.svg
- norbert_pleading.svg, norbert_grabbing.svg
- fabio_friendly.svg
- ali_friendly.svg
- michi_whiteboard.svg
- gilles_explaining.svg
- ruling_pointing.svg
- security_guard_waving.svg
