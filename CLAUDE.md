# Andi VN — Project Overview and Development Rules

This document defines how the project is structured, how files are organized, and the coding conventions we follow. No numbers for scenes, endings, or prompts are fixed here; this document only describes architecture and rules.

---

## 1. Project Goal

Build a small, static-site visual novel (VN) for Andi's PhD farewell.
The focus is on:

- simple branching story structure
- fast iteration
- minimal dependencies
- clean separation between engine and story
- easy collaboration (anyone can edit the story without touching code)

The final product is a **single-page VN** that loads story data and images dynamically.

### Password Protection

The game is protected by a 4-character password screen that appears on load:
- Password inputs auto-focus and auto-advance between characters
- Correct password hides the overlay and starts the game
- Incorrect attempts trigger shake animation and funny error messages
- After 5 failed attempts, a 30-second lockout is applied
- Password logic lives in `js/password.js`

---

## 2. High-Level Architecture

The VN consists of four layers:

1. **HTML shell**
   - The static structure of the page.
   - Contains only empty containers for text, buttons, and images.

2. **VN engine (JavaScript)**
   - Handles loading the story, updating the UI, rendering backgrounds and character sprites, managing flags, and handling branching logic.
   - Interprets actions (e.g. dice rolls) via a handler registry.
   - No story text lives here.

3. **Story data (generated)**
   - A single file (`js/story.js`) containing all narrative content.
   - Generated from Markdown scene files by the static site generator.
   - Includes: scene IDs, text blocks, choices, flags, background references, sprite references, actions.

4. **Scene source files (Markdown)**
   - One `.md` file per scene in the `scenes/` folder.
   - Human-readable format with YAML frontmatter and narrative text.
   - This is the **source of truth** for all story content.

This separation ensures the engine is stable, writers only edit Markdown, and the build step produces clean data.

---

## 3. Folder Structure

```
Andi/
│
├─ index.html
│
├─ css/
│   └─ themes/
│       ├─ prototype.css   (original warm beige VN style)
│       └─ 90s.css         (Windows 3.1 aesthetic)
│
├─ theme.md                (theme selection config)
│
├─ js/
│   ├─ engine.js
│   ├─ password.js     (password screen logic)
│   ├─ story.js        (generated - do not edit manually)
│   └─ theme.js        (generated - theme configuration)
│
├─ scenes/
│   └─ *.md            (source of truth for story)
│
├─ assets/
│   ├─ bg/
│   ├─ char/
│   ├─ fonts/        (local font files for offline use)
│   ├─ music/
│   └─ sfx/
│
├─ editor/
│   ├─ index.html      (scene editor)
│   ├─ editor.js
│   └─ editor.css
│
├─ tools/
│   └─ build_story_from_md.py
│
└─ prototype/
    └─ andy.html       (original prototype for reference)
```

### index.html
Contains:
- empty containers for story text, choices, backgrounds, sprites
- continue button for text block progression
- links to CSS and JS
- no story text or logic code allowed

### css/themes/*.css
Theme CSS files define:
- layout
- background and sprite positioning
- text formatting
- continue button and choice button styling
- transitions
- color schemes

No inline styles permitted.

### theme.md
Configuration file for selecting the active theme:
```markdown
prototype [ ]
90s [x]
```
- One line per theme
- `[x]` marks the selected theme
- `[ ]` marks available but unselected themes
- Only one theme can be selected at a time

### js/engine.js
Contains VN logic:
- load story data from `story.js`
- maintain state (current scene, current text block index, flags)
- update UI
- render backgrounds and sprites
- step through text blocks with "Continue" button
- show choices after final text block
- execute actions via handler registry
- manage branching
- **never contains story text**

### js/story.js
Contains **only generated narrative data**:
- scenes with `id`, `textBlocks`, `choices`, `actions`
- `bg` and `chars` fields
- flags: `set_flags`, `require_flags`
- **Do not edit manually** — generated by `build_story_from_md.py`

### scenes/*.md
Contains **source story content**:
- one file per scene
- YAML frontmatter for metadata
- text blocks separated by `---`
- choices section at the end
- **This is what writers edit**

---

## 4. Scene Model (Markdown Format)

Each scene is a single Markdown file in `scenes/` with this structure:

```markdown
---
id: scene_id
bg: background_filename.jpg
music: ambient_track.mp3
chars:
  - character1.svg
  - character2.svg
set_flags:
  - flag_to_set
require_flags:
  - flag_required
actions:
  - type: roll_dice
    dice: d20
    threshold: 13
    success_target: success_scene
    failure_target: failure_scene
---

First text block. This is shown when the scene loads.

The player clicks "Continue" to advance.

---

Second text block. This appears after the first "Continue" click.

You can have as many text blocks as needed.

---

Third and final text block.

After this, choices are shown (or actions execute).

### Choices

- Go left → left_scene
- Go right → right_scene
- Stay here (requires: has_key) → locked_room
```

### Frontmatter Fields

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique scene identifier |
| `bg` | No | Background filename (in `assets/bg/`). Supports static (.jpg, .png) and animated (.gif, .webp, .webm, .mp4) formats |
| `chars` | No | Array of character sprite filenames (in `assets/char/`) |
| `music` | No | Background music filename (in `assets/music/`), or `none` to stop |
| `set_flags` | No | Array of flags to set when entering this scene |
| `require_flags` | No | Array of flags required to enter this scene |
| `add_items` | No | Array of item names to add to player inventory |
| `remove_items` | No | Array of item names to remove from player inventory |
| `actions` | No | Array of action objects (see Actions section) |

### Text Blocks

- Separated by `---` (horizontal rule)
- Each block is a separate "Continue" click
- Support Markdown formatting: `**bold**`, `*italic*`
- Background and characters remain constant throughout the scene
- No visual changes between blocks (only at scene transitions)

### Choices Section

- Must be under `### Choices` heading
- Each choice is a list item: `- Label text → target_id`
- Optional flag requirements: `- Label (requires: flag_name) → target_id`
- Optional flag setting: `- Label (sets: flag_name) → target_id`
- Optional item requirements: `- Label (require_items: Item Name) → target_id`
- Optional item consumption: `- Label (uses: Item Name) → target_id`
- Optional healing: `- Label (heals: 5) → target_id`
- Optional battle action: `- Label (battle: attack) → target_id`
- Optional sound effect: `- Label [sfx: filename.ogg] → target_id`
- Choices only appear after all text blocks are shown
- If no choices and no actions, scene is a game over / ending

**Choice Modifiers:**

| Modifier | Syntax | Description |
|----------|--------|-------------|
| `requires` | `(requires: flag_name)` | Only show if player has flag |
| `sets` | `(sets: flag_name)` | Set flag when choice selected |
| `require_items` | `(require_items: Item)` | Only show if player has item |
| `uses` | `(uses: Item Name)` | Consume item when selected |
| `heals` | `(heals: 5)` | Heal player HP when selected |
| `battle` | `(battle: attack)` | Battle action type (see Battle System) |
| `sfx` | `[sfx: sound.ogg]` | Play sound effect on selection |

**Choice Examples:**
```markdown
### Choices

- Take the stairs [sfx: footstep.ogg] → main_stairs
- Use the elevator [sfx: elevator_ding.ogg] → elevator
- Unlock the door (uses: Master Key) → secret_room
- Drink coffee (uses: Coffee Mug, heals: 5) → refreshed
- Fight! (battle: attack) → battle_continue
```

---

## 5. Actions Model

Actions are special behaviors that execute after all text blocks are shown (but before choices). They are defined in the frontmatter `actions` array.

### Supported Action Types

#### `roll_dice`
Performs a dice roll and navigates based on result. Supports advantage/disadvantage, skill names, and critical hit/fumble text.

```yaml
actions:
  - type: roll_dice
    dice: d20
    threshold: 13
    modifier: advantage      # optional: advantage, disadvantage, or normal (default)
    skill: Persuasion        # optional: display name for the check
    crit_text: "Perfect!"    # optional: custom text on natural 20
    fumble_text: "Disaster!" # optional: custom text on natural 1
    success_target: success_scene
    failure_target: failure_scene
```

Parameters:
- `dice`: Dice type (d4, d6, d8, d10, d12, d20, d100)
- `threshold`: Number to roll at or below to succeed
- `modifier`: `advantage` (roll 2, take highest), `disadvantage` (roll 2, take lowest), or `normal` (default)
- `skill`: Display name shown above roll result (e.g., "Persuasion Check")
- `crit_text`: Custom text displayed on natural 20 (d20 only)
- `fumble_text`: Custom text displayed on natural 1 (d20 only)
- `success_target`: Scene ID to go to on success
- `failure_target`: Scene ID to go to on failure

**Critical Hits & Fumbles (d20 only):**
- Natural 20: Always succeeds, shows crit_text or "CRITICAL SUCCESS!"
- Natural 1: Always fails, shows fumble_text or "CRITICAL FAILURE!"

#### `start_battle`
Initiates a turn-based battle encounter with HP bars and combat actions.

```yaml
actions:
  - type: start_battle
    player_max_hp: 20
    player_ac: 10
    player_attack_bonus: 2
    player_damage: d8
    enemy:
      name: Agnes
      hp: 30
      ac: 12
      attack_bonus: 3
      damage: d6
    win_target: victory_scene
    lose_target: defeat_scene
    flee_target: escaped_scene  # optional
```

Parameters:
- `player_max_hp`: Player's maximum HP (initializes on first battle)
- `player_ac`: Player's armor class
- `player_attack_bonus`: Bonus to player's attack rolls
- `player_damage`: Player's damage dice (e.g., d6, 2d8, d10+2)
- `enemy`: Enemy stats object (see below)
- `win_target`: Scene to go to when enemy HP reaches 0
- `lose_target`: Scene to go to when player HP reaches 0
- `flee_target`: Optional scene for successful escape

Enemy object:
- `name`: Enemy display name (shown on HP bar)
- `hp`: Enemy hit points
- `ac`: Enemy armor class
- `attack_bonus`: Bonus to enemy attack rolls
- `damage`: Enemy damage dice

#### `play_sfx`
Plays a one-shot sound effect.

```yaml
actions:
  - type: play_sfx
    file: alarm_blare.mp3
```

Parameters:
- `file`: Sound effect filename (in `assets/sfx/`)

#### `custom` (for future extensibility)
Calls a named handler with parameters.

```yaml
actions:
  - type: custom
    handler: showSpecialEvent
    params:
      difficulty: hard
      reward: golden_key
```

### Action Handler Registry

The engine maintains an `actionHandlers` object that maps action types to handler functions:

```javascript
const actionHandlers = {
    roll_dice: (action, state) => { /* ... */ },
    start_battle: (action, state) => { /* ... */ },
    play_sfx: (action, state) => { /* ... */ },
    custom: (action, state) => { /* ... */ }
};
```

New action types can be added by registering handlers in the engine.

---

## 6. Static Site Generator

The script `tools/build_story_from_md.py` processes scene files:

### Input
- All `.md` files in `scenes/` directory

### Processing
1. Parse YAML frontmatter
2. Extract text blocks (split by `---`)
3. Parse `### Choices` section into structured choice objects
4. Build scene objects with all fields

### Output
- Generates `js/story.js` with a JavaScript object containing all scenes

### Validation
The generator validates:
- All `target` IDs in choices exist as scene IDs
- No duplicate scene IDs
- Required frontmatter fields are present
- Warns about unreachable scenes

### Usage
```bash
python tools/build_story_from_md.py
```

---

## 7. VN "Continue" Behavior

The engine implements a text block progression system:

1. **Scene Load**: Show first text block, display "Continue" button
2. **Continue Click**: Advance to next text block
3. **Last Block**: Hide "Continue", either:
   - Execute actions (e.g. dice roll), which navigates to next scene
   - Show choice buttons
   - Show "Play Again" if no choices (ending)

### State Tracking
- `currentSceneId`: Which scene we're in
- `currentBlockIndex`: Which text block we're showing (0-indexed)
- `flags`: Set of string flags

---

## 8. Coding Standards

### General
- Always separate content (story) from logic (engine)
- No story text inside engine code
- No logic inside story data
- Writers only edit Markdown files, never JS
- No global variables except the engine namespace

### JavaScript
- Use clear, minimal functions
- Keep engine.js stable and rarely edited
- Action handlers should be pure functions where possible

### Markdown (Scene Files)
- Use lowercase with underscores for IDs: `main_stairs`, `lost_to_coffee`
- Keep text blocks focused (one idea per block)
- Use `---` only for block separators
- Put choices at the very end of the file

### CSS
- **Never use pixel-based media queries** — they don't scale properly with device pixel ratios
- Use `em`-based breakpoints instead (e.g., `56em` instead of `900px`)
- Reference: `1em = 16px` at default browser settings, so `56em ≈ 900px`, `37.5em ≈ 600px`
- Use `dvh` (dynamic viewport height) instead of `vh` for mobile browser compatibility
- **Always provide fallbacks for modern CSS features** to support older browsers (~2012):
  - `aspect-ratio`: Use padding-bottom percentage trick as fallback (e.g., `padding-bottom: 56.25%` for 16:9)
  - `clamp()`/`min()`/`max()`: Provide a static fallback value first
  - `gap` in flexbox: Use margin on children with `@supports (gap: 10px)` to remove margins in modern browsers
  - `:has()` selector: Add a fallback class via JS (e.g., `.has-game-over`) and use `@supports selector(:has(*))` for modern browsers
  - `display: flex`: Add `display: block` or `display: inline-block` as preceding fallback

### Assets
- Background filenames: lowercase with underscores, `.jpg` extension
- Character sprites: lowercase with underscores, `.svg` extension
- All assets stored inside `assets/`

---

## 9. Development Workflow

### For Writers
1. Create or edit `.md` files in `scenes/`
2. Run `python tools/build_story_from_md.py`
3. Reload browser to test
4. Repeat

### For Developers
1. Edit `js/engine.js` for logic changes
2. Edit `css/style.css` for visual changes
3. Edit `index.html` for structure changes
4. Run the build script after scene changes

The workflow must stay frictionless.
Story writers should never touch engine code.

---

## 10. UI Layout

The VN uses a traditional visual novel layout:

- **Fixed 16:9 aspect ratio** container (`#vn-container`)
- **Background layer** fills the entire container
- **Character sprites** positioned in the middle area
- **Text box** occupies the lower ~32% with semi-transparent cream background
- **Continue button** appears below text when more blocks remain
- **Choice buttons** appear after final text block
- **Title** ("Andy's Farewell") displayed above the game container

### Theme Colors (preserved from original design)
- Page background: `#f2e7d5` (warm beige)
- Text color: `#4b3e2a` (dark brown)
- Text box: `rgba(250, 241, 224, 0.95)` (cream, semi-transparent)
- Buttons: `#b08b5a` (golden brown)
- Button text: `#fffbe9` (cream white)
- Accents/borders: `#d3c2a8` (light brown)

---

## 11. Engine Features

### Text Speed Controls
Located in the upper-right of the text box. Uses symbol buttons:
- **▶** Normal (30ms per character)
- **▶▶** Fast (10ms per character)
- **▶|** Auto (30ms + auto-advances after 1.5s delay when single choice)
- **⏭** Skip (instant display, only visible after at least one block has been read)

### Typewriter Effect
- Text displays character-by-character with blinking cursor
- HTML tags (like `<strong>`) are rendered instantly, only text characters are typed
- Markdown bold (`**text**`) is converted to `<strong>` tags
- Click on text area or press Space to skip (only for already-read blocks)

### Read Block Tracking
- `state.readBlocks` tracks which scene+block combinations have been displayed
- First-time readers cannot skip the typewriter effect
- Skip button only appears after at least one block has been read
- Already-read text shows "(already read)" indicator

### Developer Mode
- Hold **q+w+e+r+t** keys simultaneously to toggle dev mode
- Dev mode allows skipping any text, even on first read
- Green "DEV MODE" indicator appears in top-right corner
- **Theme selector** appears below DEV MODE indicator for live theme switching

### Dice Roll Mechanics
- Defined in scene frontmatter via `actions` array
- Supports different dice types (d20, d6, etc.)
- Roll result determines which scene to navigate to
- Shows roll result message before transitioning

### Choice Buttons
- Displayed horizontally in a single row (never wrap)
- Use `flex: 1 1 0` to distribute space evenly
- Game over states show "Play Again" restart button

---

## 12. Generated Story Structure

The `js/story.js` file contains a JavaScript object like:

```javascript
const story = {
    "scene_id": {
        id: "scene_id",
        bg: "background.jpg",
        chars: ["character.svg"],
        set_flags: [],
        require_flags: [],
        actions: [],
        textBlocks: [
            "First text block...",
            "Second text block..."
        ],
        choices: [
            {
                label: "Choice text",
                target: "target_scene_id",
                sfx: "footstep.ogg",
                require_flags: [],
                set_flags: []
            }
        ]
    }
};
```

---

## 13. Audio System

The VN supports background music and sound effects.

### Background Music (`assets/music/`)
- Looping tracks that play continuously during scenes
- Set via `music` field in scene frontmatter
- Music continues playing across scene transitions unless changed
- Use `music: none` to stop music

**Available music tracks:**
- `BOSS_TIME.mp3` - Intense confrontation music
- `coding.mp3`, `coding_frenzy.mp3` - Working/coding atmosphere
- `coffee.mp3`, `too_much_coffee.mp3` - Kitchen/coffee scenes
- `default.mp3` - General background
- `dicey_decisions.mp3` - Dice roll moments
- `game_over.mp3` - Loss state music
- `glitch.mp3` - Error/glitch effects
- `i_can_do_it.mp3` - Motivational moments
- `last_day.mp3` - Nostalgic/farewell mood
- `legal_trap_stairwell.mp3` - Tense stairwell scenes
- `oh_oh.mp3`, `OH_SHIT.mp3` - Trouble/danger moments
- `outside.mp3`, `rooftop.mp3` - Outdoor scenes
- `questioning.mp3` - Dialogue/interrogation
- `reading_papers.mp3` - Document signing
- `running_escape.mp3` - Chase/escape sequences
- `spooky.mp3` - Eerie atmosphere
- `victory.mp3` - Win state music
- `zen.mp3` - Calm/peaceful moments

**Example usage in scene:**
```yaml
---
id: start
bg: hallway_fluorescent.jpg
music: last_day.mp3
---
```

### Sound Effects (`assets/sfx/`)
- One-shot sounds triggered by choice clicks (VN-style)
- Can also be played via `play_sfx` action type
- Do not loop, play once and stop
- All SFX files use `.ogg` format

**Available SFX:**
- `alarm.ogg`, `alarm_clock.ogg`, `alert.ogg` - Alert sounds
- `chain.ogg` - Chain/trap sound
- `click.ogg` - UI click/confirmation
- `dice_roll.ogg` - Dice rolling
- `door_open.ogg`, `door_slam.ogg` - Door sounds
- `elevator_ding.ogg` - Elevator arrival
- `failure.ogg`, `success.ogg` - Outcome sounds
- `footstep.ogg` - Walking/movement
- `gulp.ogg` - Drinking/swallowing
- `negative.ogg` - Refusal/negative response
- `thud.ogg` - Impact/falling
- `victory.ogg` - Win sound
- `warning.ogg`, `zap.ogg` - Warning sounds

**Choice SFX (preferred method):**
```markdown
### Choices

- Take the stairs [sfx: footstep.ogg] → main_stairs
```

**Action SFX (for scene-level effects):**
```yaml
actions:
  - type: play_sfx
    file: alarm.ogg
```

### VN-Style Audio Behavior
When a player clicks a choice with SFX:
1. Scene transitions immediately (background, characters update)
2. **150ms pause** - Lets the new scene visuals settle
3. **SFX plays** - Music is ducked to 20% volume
4. **200ms pause** - After SFX finishes
5. **Music & text start** - Full music volume, typewriter begins

This creates the classic VN feel where audio feedback follows player actions.

### General Audio Behavior
- Background music loops indefinitely until changed
- Only one music track plays at a time (new track replaces old)
- Music is automatically ducked during SFX playback
- Audio requires user interaction to start (browser policy)
- A mute button is available in the UI

---

## 14. Asset Inventory

### Backgrounds (`assets/bg/`)

**Supported formats:**
- **Static**: `.jpg`, `.png` (best for most scenes)
- **Animated CSS**: `.gif`, `.webp` (uses CSS background-image, good browser support)
- **Animated Video**: `.webm`, `.mp4` (uses `<video>` element, best quality/compression)

**Fallback for older browsers:**
For animated backgrounds, provide a static `.jpg` fallback with the same base name. The engine will automatically use the animated version on modern browsers.

**Example usage:**
```yaml
bg: spooky_forest.webm      # Video background
bg: glitch_effect.gif       # Animated GIF
bg: hallway_fluorescent.jpg # Static image
```

**Current static backgrounds:**
- hallway_fluorescent.jpg
- stairwell_landing.jpg
- hallway_red_alert.jpg
- stairwell_escape.jpg
- hallway_dim.jpg
- office_corridor.jpg
- meeting_room_whiteboard.jpg
- office_kitchen.jpg
- bedroom_morning.jpg
- dark_office_desk.jpg
- desk_computer_code.jpg
- back_stairwell_dim.jpg
- sunny_street_freedom.jpg

### Character Sprites (`assets/char/`)
All SVG format, 200x400 viewBox:
- agnes_neutral.svg, agnes_happy.svg, agnes_angry.svg, agnes_blocking.svg, agnes_surprised.svg, agnes_victorious.svg
- joni_desperate.svg
- norbert_pleading.svg, norbert_grabbing.svg
- fabio_friendly.svg
- ali_friendly.svg
- michi_whiteboard.svg
- gilles_explaining.svg
- ruling_pointing.svg
- security_guard_waving.svg

---

## 15. Scene Editor

A visual editor is available at `editor/index.html` for creating and editing scenes without manually writing Markdown.

### Features
- **Scene list** with visual indication of modified scenes
- **Background selector** with preview
- **Character sprite placement** via drag-and-drop on canvas
- **Music selector** with preview playback
- **Text block editor** with navigation between blocks
- **Choice editor** with:
  - Button text
  - Target scene (with autocomplete)
  - Sound effect dropdown
  - Requires/Sets flags
- **Dice roll action** configuration
- **Graph view** showing scene connections
- **Preview in game** button for quick testing
- **Save/Download** individual scenes or all scenes as ZIP

### Usage
1. Open `editor/index.html` in browser
2. Select a scene from the list or create new
3. Edit using the visual interface
4. Click "Save" to download the `.md` file
5. Place the file in `scenes/` folder
6. Run `python tools/build_story_from_md.py` to regenerate story.js

### Editor Files
```
editor/
├─ index.html      (editor HTML structure)
├─ editor.js       (editor logic)
└─ editor.css      (editor styling)
```

The editor generates Markdown files compatible with `build_story_from_md.py`.

---

## 16. Theme System

The VN supports multiple visual themes that can be switched via configuration or dev mode.

### Available Themes

| Theme | Description | Font |
|-------|-------------|------|
| `prototype` | Original warm beige VN style with cream text box and golden brown buttons | System serif |
| `70s` | Retro disco (orange, brown, gold, avocado green) | Righteous |
| `80s` | Synthwave neon (hot pink, electric blue, chrome, scanlines) | Orbitron |
| `90s` | Windows 3.1 / Early Mac aesthetic (gray panels, blue titlebars) | Silkscreen |
| `cyberpunk` | Neon city (yellow/cyan on black, grid patterns, tech noir) | Share Tech Mono |
| `dos` | MS-DOS terminal (green on black, CRT scanlines, command prompt) | VT323 |
| `dragonball` | Dragon Ball Z inspired (orange/blue energy, power-up auras) | Bangers |
| `finalfantasy` | Classic JRPG menu (blue gradients, white text, crystal motifs) | Press Start 2P |
| `gameboy` | Original Game Boy (4-shade green palette, pixelated filter) | Press Start 2P |
| `harrypotter` | Wizarding World (burgundy/gold, magical sparkles, parchment) | Cinzel |
| `lotr` | Lord of the Rings (parchment, gold, forest green, elvish elegance) | Cinzel |
| `manga` | Junji Ito horror manga (stark black & white, high contrast) | Permanent Marker |
| `nes` | 8-bit NES (limited palette, pixel font, chunky borders) | Press Start 2P |
| `snes` | 16-bit SNES (richer colors, gradients, star field) | Press Start 2P |
| `spaceopera` | Epic sci-fi (deep space, nebula colors, starfield, hologram cyan) | Orbitron |
| `starwars` | Star Wars inspired (space black, yellow crawl text, starfield) | Bebas Neue |
| `vaporwave` | A E S T H E T I C pink/cyan/purple with grid patterns | VT323 |
| `y2k` | Millennium aesthetic (chrome silver, translucent, tech optimism) | Audiowide |
| `zelda` | Legend of Zelda (forest green, Triforce gold, adventure RPG) | Press Start 2P |

### Theme Selection

Themes are selected by editing `theme.md` in the project root:

```markdown
# Theme Configuration
prototype [ ]
90s [x]
```

- Mark the desired theme with `[x]`
- Mark other themes with `[ ]`
- Run `python tools/build_story_from_md.py` to apply the change

### Creating New Themes

1. Create a new CSS file in `css/themes/` (e.g., `css/themes/mytheme.css`)
2. Copy the structure from an existing theme
3. Modify colors, fonts, borders, and styling
4. Add the theme name to `theme.md`
5. Run the build script

### Theme CSS Requirements

Each theme CSS must define styles for:
- Password overlay (`#password-overlay`, `#password-container`, `.password-char`)
- Main container (`#vn-wrapper`, `#vn-container`)
- Background and sprite layers (`#background-layer`, `#sprite-layer`)
- Text box (`#text-box`, `#story-output`)
- Controls (`#text-controls`, `.speed-btn`, `.mute-btn`)
- Buttons (`.choice-button`, `.continue-button`, `.restart-button`)
- Game over state (`.game-over`)
- Responsive breakpoints (landscape and portrait)

### Dev Mode Theme Switching

In dev mode (hold q+w+e+r+t), a theme selector dropdown appears allowing live theme switching without rebuilding. This is useful for testing themes during development.

### Generated Files

The build script generates `js/theme.js` containing:
```javascript
const themeConfig = {
  "selected": "90s",
  "available": ["prototype", "90s"]
};
```

This is loaded by `index.html` to dynamically set the correct theme CSS.

### Theme Persistence

The selected theme is saved to `localStorage` (key: `andi_vn_theme`) so it persists across page reloads.

---

## 17. Font Library (`assets/fonts/`)

All fonts are stored locally for offline USB deployment. Fonts are organized by family in subfolders.

### Display & Theme Fonts

| Font | Style | Theme Usage | File |
|------|-------|-------------|------|
| **Orbitron** | Sci-fi geometric | 80s synthwave | `Orbitron/Orbitron-VariableFont_wght.ttf` |
| **VT323** | CRT terminal | Vaporwave | `VT323/VT323-Regular.ttf` |
| **Press Start 2P** | 8-bit pixel | NES, SNES | `Press_Start_2P/PressStart2P-Regular.ttf` |
| **Bangers** | Comic/anime | Dragon Ball | `Bangers/Bangers-Regular.ttf` |
| **Bebas Neue** | Condensed display | Star Wars | `Bebas_Neue/BebasNeue-Regular.ttf` |
| **Righteous** | 70s groovy | 70s disco | `Righteous/Righteous-Regular.ttf` |
| **Silkscreen** | Pixel bitmap | 90s Windows | `Silkscreen/Silkscreen-Regular.ttf` |
| **Permanent Marker** | Hand-drawn | Manga | `Permanent_Marker/PermanentMarker-Regular.ttf` |
| **Special Elite** | Typewriter | Prototype alt | `Special_Elite/SpecialElite-Regular.ttf` |

### Sci-Fi & Futuristic Fonts

| Font | Style | File |
|------|-------|------|
| **Audiowide** | Wide sci-fi | `Audiowide/Audiowide-Regular.ttf` |
| **Staatliches** | Bold condensed | `Staatliches/Staatliches-Regular.ttf` |
| **Zen Dots** | Futuristic pixel | `Zen_Dots/ZenDots-Regular.ttf` |
| **Teko** | Tech condensed | `Teko/Teko-VariableFont_wght.ttf` |
| **Share Tech Mono** | Monospace terminal | `Share_Tech_Mono/ShareTechMono-Regular.ttf` |

### Bold & Action Fonts

| Font | Style | File |
|------|-------|------|
| **Black Ops One** | Military stencil | `Black_Ops_One/BlackOpsOne-Regular.ttf` |
| **Russo One** | Bold slavic | `Russo_One/RussoOne-Regular.ttf` |
| **Bungee** | Bold display | `Bungee/Bungee-Regular.ttf` |
| **Faster One** | Speed/racing | `Faster_One/FasterOne-Regular.ttf` |
| **Rubik Mono One** | Chunky mono | `Rubik_Mono_One/RubikMonoOne-Regular.ttf` |
| **Wallpoet** | Stencil graffiti | `Wallpoet/Wallpoet-Regular.ttf` |

### Horror & Decorative Fonts

| Font | Style | File |
|------|-------|------|
| **Creepster** | Horror dripping | `Creepster/Creepster-Regular.ttf` |
| **Nosifer** | Horror blood | `Nosifer/Nosifer-Regular.ttf` |
| **Monoton** | Retro outline | `Monoton/Monoton-Regular.ttf` |

### Alien & Sci-Fi Language Fonts

| Font | Style | File |
|------|-------|------|
| **Iceberg** | Angular alien | `Iceberg/Iceberg-Regular.ttf` |
| **Megrim** | Thin futuristic | `Megrim/Megrim-Regular.ttf` |
| **Nova Square** | Geometric alien | `Nova_Square/NovaSquare-Regular.ttf` |
| **Xanh Mono** | Quirky alien-ish | `Xanh_Mono/XanhMono-Regular.ttf` |

### Cipher/Symbol Fonts (Unreadable Alien Languages)

| Font | Maps To | Best For | File |
|------|---------|----------|------|
| **Aurebesh** | Latin alphabet | Star Wars alien text | `Aurebesh.otf` |
| **Galactic Basic** | Latin alphabet | Star Wars (alternate) | `galbasic.ttf` |
| **Klingon** | Latin alphabet | Star Trek alien text | `klingon font.ttf` |
| **Elvish Ring** | Latin alphabet | Fantasy/LOTR text | `elvish ring nfi.ttf` |
| **Alien Encounters** | Latin alphabet | Generic sci-fi alien | `Alien-Encounters-Regular.ttf` |
| **Noto Sans Symbols 2** | Unicode symbols | Decorative symbols | `Noto_Sans_Symbols_2/NotoSansSymbols2-Regular.ttf` |

### Using Fonts in Theme CSS

```css
/* Load font at top of theme CSS */
@font-face {
    font-family: 'Orbitron';
    src: url('../assets/fonts/Orbitron/static/Orbitron-Regular.ttf') format('truetype');
    font-weight: 400;
}

/* Apply to body */
body {
    font-family: 'Orbitron', 'Arial Black', sans-serif;
}

---

## 18. Inventory System

The VN supports a simple item-based inventory system for key items and consumables.

### Adding Items to Inventory

Use `add_items` in scene frontmatter:

```yaml
---
id: find_key
add_items:
  - Master Key
  - Coffee Mug
---

You found a Master Key and a Coffee Mug!
```

### Removing Items from Inventory

Use `remove_items` in scene frontmatter:

```yaml
---
id: lose_key
remove_items:
  - Master Key
---

The key breaks in the lock!
```

### Using Items in Choices

**Require an item to show a choice:**
```markdown
- Open the locked door (require_items: Master Key) → secret_room
```

**Consume an item when selecting a choice:**
```markdown
- Use the key (uses: Master Key) → unlocked_door
```

### Inventory Display

- Items appear in a floating panel in the top-left corner
- Panel only shows when player has at least one item
- Adding/removing items shows a floating notification

### Engine API

```javascript
// Add an item
VNEngine.addItem('Master Key');

// Remove an item
VNEngine.removeItem('Master Key');

// Check if player has an item
VNEngine.hasItem('Master Key');  // returns true/false

// Get all items
VNEngine.getInventory();  // returns ['Master Key', ...]
```

---

## 19. Battle System

The VN includes a DnD-inspired turn-based battle system for boss fights.

### Starting a Battle

Use the `start_battle` action in scene frontmatter:

```yaml
---
id: boss_fight
bg: office_corridor.jpg
music: BOSS_TIME.mp3
chars:
  - agnes_angry.svg
actions:
  - type: start_battle
    player_max_hp: 20
    player_ac: 10
    player_attack_bonus: 2
    player_damage: d8
    enemy:
      name: Agnes
      hp: 30
      ac: 12
      attack_bonus: 3
      damage: d6
    win_target: agnes_defeated
    lose_target: game_over_agnes
    flee_target: ran_away
---

Agnes blocks your path!

"You're not leaving without signing those papers!"
```

### Battle Choices

Define battle actions in the choices section:

```markdown
### Choices

- Attack! (battle: attack) → battle_continue
- Defend (battle: defend) → battle_continue
- Drink Coffee (uses: Coffee Mug, heals: 5, battle: item) → battle_continue
- Run Away (battle: flee) → battle_continue
```

Battle action types:
- `attack`: Roll attack vs enemy AC, deal damage on hit
- `defend`: Gain +4 AC until next turn
- `flee`: Roll DC 14, escape to flee_target on success
- `item`: Use item (with `heals` for HP restoration)

### Combat Mechanics

**Attack Rolls:**
- Roll d20 + attack bonus vs target AC
- Natural 20: Critical hit (double damage, always hits)
- Natural 1: Critical fumble (always misses)

**Damage:**
- Supports dice notation: `d6`, `2d8`, `d10+2`
- Critical hits double the damage rolled

**Turn Order:**
1. Player selects action
2. Player action resolves (with visual feedback)
3. Short delay
4. Enemy attacks (auto-roll)
5. Battle continues or ends

### Visual Feedback

- **HP Bars**: Player HP (bottom-left), Enemy HP (top-right, shows name)
- **Damage Numbers**: Float up from target when hit
- **Damage Flash**: Sprites flash red when hit
- **HP Colors**: Green (>50%), Orange (25-50%), Red (<25%, pulses)
- **Battle Log**: Shows hit/miss/damage text

### HP Persistence

- Player HP persists across scenes (saved to localStorage)
- HP only initializes on first battle encounter
- HP can be restored via `heals` modifier on choices

### Engine API

```javascript
// Get current HP
VNEngine.getHP();     // returns number or null
VNEngine.getMaxHP();  // returns max HP

// Heal the player
VNEngine.heal(10);

// Damage the player
VNEngine.damage(5);   // returns true if still alive

// Initialize HP (usually automatic)
VNEngine.initHP(20);
```

---

## 20. Game State Persistence

The engine automatically saves game state to localStorage:

### Saved Data
- Current scene and text block position
- All flags
- Inventory items
- Player HP (if initialized)
- Scene history (for undo in dev mode)
- Read blocks (for skip button)

### Save Key
Default: `andi_vn_save`

### Reset Options
- **Play Again** (game over): Resets flags, inventory, HP, but keeps read history
- **Reset Progress** (↺ button): Full reset including read history
