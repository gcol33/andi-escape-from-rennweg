<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Responsive viewport: prevents auto-zoom, allows pinch-zoom for accessibility -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#f2e7d5">
    <!-- Apple mobile web app capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Andy's Farewell</title>
    <!-- Web fonts for themed typography -->
    <link rel="stylesheet" href="css/fonts.css">
    <!-- Shared theme settings (magic numbers) -->
    <link rel="stylesheet" href="css/shared.css">
    <!-- Theme CSS loaded dynamically based on theme.js config -->
    <link id="theme-css" rel="stylesheet" href="css/themes/90s.css">
    <script>
        // Load theme configuration synchronously to prevent FOUC
        (function() {
            // Check localStorage first for user's saved preference
            var savedTheme = null;
            try {
                savedTheme = localStorage.getItem('andi_vn_theme');
            } catch (e) {}

            var script = document.createElement('script');
            script.src = 'js/theme.js';
            script.async = false;
            document.head.appendChild(script);
            script.onload = function() {
                var link = document.getElementById('theme-css');
                if (!link) return;

                // Use saved theme if valid, otherwise fall back to config
                if (savedTheme && typeof themeConfig !== 'undefined' &&
                    themeConfig.available && themeConfig.available.indexOf(savedTheme) !== -1) {
                    link.href = 'css/themes/' + savedTheme + '.css';
                } else if (typeof themeConfig !== 'undefined' && themeConfig.selected) {
                    link.href = 'css/themes/' + themeConfig.selected + '.css';
                }
            };
        })();
    </script>
</head>
<body>
    <!-- Password overlay - blocks game until correct password entered -->
    <div id="password-overlay" role="dialog" aria-modal="true" aria-label="Password required to enter">
        <div id="password-container">
            <div id="password-inputs" role="group" aria-label="Enter 6-character password">
                <input type="text" class="password-char" maxlength="1" data-index="0" autocomplete="off" autofocus aria-label="Password character 1 of 6">
                <input type="text" class="password-char" maxlength="1" data-index="1" autocomplete="off" aria-label="Password character 2 of 6">
                <input type="text" class="password-char" maxlength="1" data-index="2" autocomplete="off" aria-label="Password character 3 of 6">
                <input type="text" class="password-char" maxlength="1" data-index="3" autocomplete="off" aria-label="Password character 4 of 6">
                <input type="text" class="password-char" maxlength="1" data-index="4" autocomplete="off" aria-label="Password character 5 of 6">
                <input type="text" class="password-char" maxlength="1" data-index="5" autocomplete="off" aria-label="Password character 6 of 6">
            </div>
        </div>
    </div>

    <!-- Outer wrapper for centering the game -->
    <div id="vn-wrapper">
        <!-- Title above game -->
        <h1>Andy's Farewell</h1>

        <!-- Fixed aspect ratio game container -->
        <div id="vn-container" role="main" aria-label="Visual novel game area">
            <!-- Background Layer -->
            <div id="background-layer" role="img" aria-label="Scene background">
                <!-- Video element for animated backgrounds (WebM/MP4) -->
                <video id="bg-video" muted playsinline loop aria-hidden="true"></video>
            </div>

            <!-- Character Sprite Layer -->
            <div id="sprite-layer" aria-hidden="true"></div>

            <!-- Inventory Display (shown when player has items) -->
            <div id="inventory-display" role="status" aria-label="Your inventory"></div>

            <!-- Text Box (lower third) -->
            <div id="text-box" role="region" aria-label="Story text and controls">
                <!-- Header band with title and controls -->
                <div id="text-box-header">
                    <div id="header-spacer" aria-hidden="true"></div>
                    <span id="text-box-title"></span>
                    <div id="text-controls" role="toolbar" aria-label="Text speed controls">
                    <button class="speed-btn active" data-speed="normal" title="Normal speed" aria-label="Normal text speed" aria-pressed="true"><span class="icon-landscape" aria-hidden="true">▶</span><span class="icon-portrait" aria-hidden="true">1x</span></button>
                    <button class="speed-btn" data-speed="auto" title="Auto" aria-label="Auto-advance text" aria-pressed="false"><span class="icon-landscape" aria-hidden="true">▶|</span><span class="icon-portrait" aria-hidden="true">A</span></button>
                    <button class="speed-btn" data-speed="fast" title="Fast" aria-label="Fast text speed" aria-pressed="false"><span class="icon-landscape" aria-hidden="true">▶▶</span><span class="icon-portrait" aria-hidden="true">2x</span></button>
                    <button class="speed-btn" data-speed="skip" title="Skip read text" id="skip-btn" aria-label="Skip already-read text" aria-pressed="false"><span class="icon-landscape" aria-hidden="true">⏭</span><span class="icon-portrait" aria-hidden="true">Skip</span></button>
                    <div id="volume-control" role="group" aria-label="Volume controls">
                        <button id="mute-btn" class="mute-btn" title="Mute" aria-label="Toggle mute" aria-pressed="false">
                            <svg class="sound-on" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                            <svg class="sound-off" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none;" aria-hidden="true">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                            </svg>
                        </button>
                        <input type="range" id="volume-slider" min="0" max="100" value="40" title="Volume" aria-label="Volume level">
                    </div>
                    </div>
                </div>
                <div id="story-output" role="log" aria-live="polite" aria-label="Story text"></div>
                <div id="button-area" role="navigation" aria-label="Story navigation">
                    <button id="continue-btn" class="continue-button" style="display: none;" aria-label="Continue to next text">Continue</button>
                    <div id="choices-container" role="group" aria-label="Story choices"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio element for background music -->
    <audio id="bg-music" loop></audio>

    <!-- Scripts: Story data must load before engine (theme.js loaded in head) -->
    <script src="js/tuning.js"></script>
    <script src="js/story.js"></script>
    <script src="js/enemies.js"></script>
    <script src="js/player.js"></script>
    <script src="js/maps.js"></script>
    <script src="js/password.js"></script>

    <!-- Utility modules -->
    <script src="js/events.js"></script>
    <script src="js/animation-manager.js"></script>

    <!-- Battle UI helpers and main UI (load before QTE and battle modules) -->
    <script src="js/battle/element-utils.js"></script>
    <script src="js/battle/stat-bar.js"></script>
    <script src="js/battle/floating-number.js"></script>
    <script src="js/battle/battle-ui.js"></script>

    <!-- QTE System -->
    <script src="js/qte-ui.js"></script>
    <script src="js/qte.js"></script>

    <!-- Modular Battle System -->
    <script src="js/battle/battle-data.js"></script>
    <script src="js/battle/battle-dice.js"></script>
    <script src="js/battle/battle-dice-ui.js"></script>
    <script src="js/battle/battle-barrier.js"></script>
    <script src="js/battle/battle-intent.js"></script>
    <script src="js/battle/battle-summon.js"></script>
    <script src="js/summons.js"></script>
    <script src="js/battle/battle-core.js"></script>
    <script src="js/battle/battle-dnd.js"></script>
    <script src="js/battle/battle-pokemon.js"></script>
    <script src="js/battle/battle-exp33.js"></script>
    <script src="js/battle/battle-facade.js"></script>

    <!-- Overworld System -->
    <script src="js/overworld-ui.js"></script>
    <script src="js/overworld.js"></script>

    <script src="js/engine.js"></script>
</body>
</html>
