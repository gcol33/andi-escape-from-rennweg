<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andi VN - Scene Editor</title>
    <link rel="stylesheet" href="editor.css">
    <script>
        // Load theme configuration and apply theme class before body renders
        (function() {
            var script = document.createElement('script');
            script.src = '../js/theme.js';
            script.async = false;
            document.head.appendChild(script);
            script.onload = function() {
                if (typeof themeConfig !== 'undefined' && themeConfig.selected === '90s') {
                    document.body.classList.add('theme-90s');
                }
            };
        })();
    </script>
</head>
<body>
    <div id="app">
        <!-- Left Sidebar: Scene List -->
        <aside id="scene-list-panel">
            <div class="panel-header">
                <h2>Scenes</h2>
                <button id="new-scene-btn" class="btn-primary">+ New Scene</button>
            </div>
            <div id="scene-search">
                <input type="text" id="scene-search-input" placeholder="Search scenes...">
            </div>
            <div id="scene-list"></div>
            <div class="panel-footer">
                <button id="import-scenes-btn" class="btn-secondary">Import All</button>
            </div>
        </aside>

        <!-- Main Content: Canvas Preview -->
        <main id="editor-main">
            <div id="canvas-toolbar">
                <span id="current-scene-name">No scene selected</span>
                <div class="toolbar-actions">
                    <button id="graph-btn" class="btn-icon" title="View story graph">Graph</button>
                    <button id="preview-btn" class="btn-icon" title="Preview in game">Preview</button>
                    <button id="save-btn" class="btn-primary" disabled>Save Scene</button>
                    <button id="download-btn" class="btn-secondary" title="Download .md file">Download</button>
                    <button id="export-all-btn" class="btn-secondary" title="Export all scenes as .md files">Export All</button>
                </div>
            </div>

            <!-- Canvas Preview Area -->
            <div id="canvas-container">
                <div id="canvas-preview">
                    <div id="preview-background"></div>
                    <div id="preview-sprites"></div>
                    <div id="preview-textbox">
                        <div id="text-nav">
                            <button id="text-prev-btn" class="text-nav-btn" title="Previous block (←)">←</button>
                            <span id="text-block-indicator">Block 1 / 1</span>
                            <button id="text-next-btn" class="text-nav-btn" title="Next block (→)">→</button>
                            <button id="text-add-btn" class="text-nav-btn" title="Add new block">+</button>
                            <button id="text-delete-btn" class="text-nav-btn" title="Delete this block">×</button>
                        </div>
                        <textarea id="preview-text" placeholder="Click here to write your story text..."></textarea>
                    </div>
                </div>

                <!-- Drop zone overlay -->
                <div id="drop-zone" class="hidden">
                    <div class="drop-zone-content">
                        <span class="drop-icon">Drop image here</span>
                    </div>
                </div>
            </div>

            <!-- Node Connections Panel -->
            <div id="node-connections-panel">
                <div class="connections-section">
                    <h4>← Incoming</h4>
                    <div id="incoming-connections" class="connections-list">
                        <span class="placeholder">No scenes lead here</span>
                    </div>
                </div>
                <div class="current-scene-node">
                    <span id="node-current-scene">No scene selected</span>
                </div>
                <div class="connections-section">
                    <h4>Outgoing →</h4>
                    <div id="outgoing-connections" class="connections-list">
                        <span class="placeholder">No outgoing connections</span>
                    </div>
                </div>
            </div>

            <!-- Sprite Palette -->
            <div id="sprite-palette">
                <h3>Sprites <span class="hint">(drag onto canvas)</span></h3>
                <div id="sprite-gallery"></div>
            </div>
        </main>

        <!-- Right Sidebar: Scene Properties -->
        <aside id="properties-panel">
            <div class="panel-section">
                <h3>Scene Info</h3>
                <label>
                    Scene ID <span class="required">*</span>
                    <input type="text" id="scene-id" placeholder="unique_scene_id">
                    <span class="hint">Lowercase, underscores, no spaces</span>
                </label>
            </div>

            <div class="panel-section">
                <h3>Background</h3>
                <div id="bg-selector">
                    <div id="bg-preview" class="asset-preview">
                        <span class="placeholder">No background</span>
                    </div>
                    <select id="bg-select">
                        <option value="">-- None --</option>
                    </select>
                </div>
            </div>

            <div class="panel-section">
                <h3>Music</h3>
                <div id="music-selector">
                    <select id="music-select">
                        <option value="">-- Default --</option>
                        <option value="none">No music</option>
                    </select>
                    <button id="music-preview-btn" class="btn-icon" title="Preview music">Play</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>Choices / Outputs</h3>
                <div id="choices-container"></div>
                <button id="add-choice-btn" class="btn-secondary">+ Add Choice</button>
                <div class="hint">Leave empty for ending scene</div>
            </div>

            <div class="panel-section collapsible">
                <h3 class="collapsible-header">
                    Advanced
                    <span class="collapse-icon">+</span>
                </h3>
                <div class="collapsible-content collapsed">
                    <div class="subsection">
                        <h4>Input (Coming From)</h4>
                        <div id="incoming-scenes" class="incoming-list">
                            <span class="placeholder">Save scene to see references</span>
                        </div>
                    </div>

                    <div class="subsection">
                        <h4>Set Flags</h4>
                        <div id="set-flags-container"></div>
                        <div class="flag-input-row">
                            <input type="text" id="new-set-flag" placeholder="flag_name">
                            <button id="add-set-flag-btn" class="btn-icon">+</button>
                        </div>
                    </div>

                    <div class="subsection">
                        <h4>Require Flags</h4>
                        <div id="require-flags-container"></div>
                        <div class="flag-input-row">
                            <input type="text" id="new-require-flag" placeholder="flag_name">
                            <button id="add-require-flag-btn" class="btn-icon">+</button>
                        </div>
                    </div>

                    <div class="subsection">
                        <h4>Actions</h4>
                        <div id="actions-container"></div>
                        <button id="add-action-btn" class="btn-secondary">+ Add Dice Roll</button>
                    </div>
                </div>
            </div>

            <div class="panel-section danger-zone">
                <button id="delete-scene-btn" class="btn-danger" disabled>Delete Scene</button>
            </div>
        </aside>
    </div>

    <!-- Graph Overview Modal -->
    <div id="graph-modal" class="modal hidden">
        <div class="modal-content graph-modal-content">
            <div class="graph-header">
                <h3>Story Graph</h3>
                <div class="graph-controls">
                    <button id="graph-zoom-in" class="btn-icon" title="Zoom in">+</button>
                    <button id="graph-zoom-out" class="btn-icon" title="Zoom out">−</button>
                    <button id="graph-reset" class="btn-icon" title="Reset pan/zoom">⟲</button>
                    <button id="graph-reset-layout" class="btn-icon" title="Reset node positions">⊞</button>
                    <button id="graph-close" class="btn-icon" title="Close">✕</button>
                </div>
            </div>
            <div id="graph-container">
                <svg id="graph-svg"></svg>
            </div>
            <div class="graph-legend">
                <span class="legend-item"><span class="legend-dot choice"></span> Choice</span>
                <span class="legend-item"><span class="legend-dot success"></span> Dice Success</span>
                <span class="legend-item"><span class="legend-dot failure"></span> Dice Failure</span>
                <span class="legend-item"><span class="legend-dot missing"></span> Missing Scene</span>
                <span class="legend-item"><span class="legend-dot has-flags"></span> Requires Flags</span>
                <span class="legend-hint">Right-click node for options</span>
            </div>
        </div>
    </div>

    <!-- Graph Context Menu -->
    <div id="graph-context-menu" class="context-menu hidden">
        <button id="ctx-edit-scene" class="context-menu-item">Edit Scene</button>
        <button id="ctx-rename-scene" class="context-menu-item">Rename Scene</button>
        <button id="ctx-view-flags" class="context-menu-item">View Flags</button>
        <hr class="context-menu-divider">
        <button id="ctx-delete-scene" class="context-menu-item danger">Delete Scene</button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Delete Scene?</h3>
            <div id="delete-warnings"></div>
            <div class="modal-actions">
                <button id="delete-cancel-btn" class="btn-secondary">Cancel</button>
                <button id="delete-confirm-btn" class="btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Audio element for music preview -->
    <audio id="music-player"></audio>

    <!-- Load story data (for file:// protocol support) -->
    <script src="../js/story.js"></script>
    <script src="editor.js"></script>
</body>
</html>
