/* Andi VN - Shared Theme Settings
 * This file contains common CSS custom properties and settings
 * that all themes inherit. Import this before theme-specific styles.
 *
 * Usage in themes: @import url('../shared.css');
 * Or link separately in HTML before theme CSS
 */

/* === Z-Index Scale ===
 * All z-index values should use these variables for consistency.
 * Layer order (bottom to top):
 *   background → sprites → theme-deco → text-box → battle-ui → overlay → modal
 */
:root {
    --z-background: 1;
    --z-sprites: 2;
    --z-theme-deco: 10;      /* Theme decorations (triangles, borders, etc.) */
    --z-text-box: 20;        /* Main text box and controls */
    --z-battle-ui: 30;       /* Battle stats panels, HP bars */
    --z-battle-effects: 40;  /* Damage numbers, hit effects */
    --z-overlay: 100;        /* Dice rolls, transitions */
    --z-dev-tools: 500;      /* Dev mode indicator, theme selector */
    --z-modal: 1000;         /* Password screen, popups */
}

/* === Typography Magic Numbers === */
/* :root continued */
:root {
    /* Base font size - responsive with min/max bounds (+20%) */
    --base-font-size-fallback: 1.35rem;  /* ~22px */
    --base-font-size: clamp(1.2rem, 1.7vw, 1.8rem);  /* 19px-29px */

    /* Story text sizing (+20%) */
    --story-font-size: 1.3rem;
    --story-line-height: 1.6;

    /* UI element sizing */
    --button-font-size: 0.9rem;
    --small-font-size: 0.75rem;
    --label-font-size: 0.85rem;

    /* Spacing - using rem for scalability (1rem = 16px at default) */
    --spacing-xs: 0.25rem;   /* 4px */
    --spacing-sm: 0.5rem;    /* 8px */
    --spacing-md: 0.75rem;   /* 12px */
    --spacing-lg: 1rem;      /* 16px */
    --spacing-xl: 1.25rem;   /* 20px */

    /* Battle log line height for dynamic sizing */
    --battle-log-line-height: 2.2rem;  /* ~35px per line */

    /* Button styling - themes should override these */
    --btn-bg: rgba(100, 100, 100, 0.7);
    --btn-bg-hover: rgba(120, 120, 120, 0.8);
    --btn-color: #fff;
    --btn-border: 0.0625rem solid rgba(255, 255, 255, 0.3);  /* 1px */
    --btn-border-radius: 0.25rem;  /* 4px */

    /* Damage number font - themes should override this */
    --damage-font: 'Arial Black', 'Helvetica Neue', sans-serif;

    /* === Battle Text Tuning === */
    /* Normal battle text */
    --battle-text-size: 0.95rem;
    --battle-text-color: #fff;

    /* Special battle text - shared size */
    --battle-special-size: 1.2rem;

    /* === NEW ROLL COLOR SYSTEM ===
     * Base colors by roll TYPE (never change based on result):
     * - Hit rolls = yellow
     * - Damage rolls = red
     * - Healing rolls = green
     * - Status rolls = blue
     * - Neutral/miss = grey
     *
     * Emphasis (crit/fail/min/max) is shown via OUTLINE only, never color change.
     */

    /* Base colors by roll type */
    --roll-color-hit: #ffd700;           /* Yellow - hit/attack rolls */
    --roll-color-damage: #ff4444;        /* Red - damage rolls */
    --roll-color-heal: #4caf50;          /* Green - healing rolls */
    --roll-color-status: #64b5f6;        /* Blue - status rolls */
    --roll-color-neutral: #888888;       /* Grey - miss, neutral */

    /* Emphasis outline colors (applied via outline/glow, not color change) */
    --emphasis-crit-glow: #ff8c00;       /* Orange glow for crits */
    --emphasis-fail-glow: #ff0000;       /* Red glow for fumbles/fails */
    --emphasis-max-glow: #ffffff;        /* White/bright glow for max */
    --emphasis-min-glow: #666666;        /* Dim glow for min */

    /* Legacy variables (kept for backward compatibility, mapped to new system) */
    --battle-number-color: var(--roll-color-hit);
    --battle-hit-dice-color: var(--roll-color-hit);
    --battle-damage-dice-color: var(--roll-color-damage);
    --battle-roll-color: var(--roll-color-neutral);
    --battle-hit-color: var(--roll-color-hit);
    --battle-damage-color: var(--roll-color-damage);
    --battle-crit-color: var(--roll-color-hit);      /* Now same as hit - emphasis via outline */
    --battle-fumble-color: var(--roll-color-neutral); /* Now grey - emphasis via outline */

    /* Password input box sizing - themes can override these */
    --password-char-width: 100px;
    --password-char-height: 120px;
    --password-char-font-size: 3rem;
    --password-char-width-tablet: 80px;
    --password-char-height-tablet: 96px;
    --password-char-font-size-tablet: 2.5rem;
    --password-char-width-mobile: 60px;
    --password-char-height-mobile: 72px;
    --password-char-font-size-mobile: 2rem;
}

/* Pixel font themes need smaller base sizes */
.theme-nes,
.theme-snes {
    --base-font-size-fallback: 1rem;  /* 16px */
    --base-font-size: clamp(0.875rem, 1.15vw, 1.125rem);  /* 14px-18px */
}

/* ============================================================================
 * UNIFIED ROLL DISPLAY SYSTEM
 * ============================================================================
 * This system provides consistent visual language for ALL roll displays:
 * - Combat log dice numbers and result text
 * - Floating damage numbers (WoW-style)
 * - Status effect notifications
 *
 * RULE 1: Base color is ONLY determined by roll TYPE
 *   - Hit/Attack rolls = Yellow
 *   - Damage rolls = Red
 *   - Healing rolls = Green
 *   - Status rolls = Blue
 *   - Neutral/Miss = Grey
 *
 * RULE 2: Emphasis is ONLY determined by result CATEGORY
 *   - Crit = Strong orange glow outline
 *   - Fail/Fumble = Red glow outline
 *   - Max = Bright white/strong glow
 *   - Min = Dim/weak glow
 *   - Normal = No outline
 *
 * The color NEVER changes based on crit/fail/min/max. Only the outline does.
 * ============================================================================ */

/* === BASE ROLL TYPE COLORS ===
 * Apply these to set the base color. Combine with emphasis classes for effect.
 */
.roll-type-hit {
    color: var(--roll-color-hit) !important;
}

.roll-type-damage {
    color: var(--roll-color-damage) !important;
}

.roll-type-heal {
    color: var(--roll-color-heal) !important;
}

.roll-type-status {
    color: var(--roll-color-status) !important;
}

.roll-type-neutral {
    color: var(--roll-color-neutral) !important;
}

/* === EMPHASIS CLASSES ===
 * Add outline/glow effects WITHOUT changing color.
 * These work with any roll-type color.
 */

/* Crit emphasis - strong orange glow, scale-up animation */
.emphasis-crit {
    text-shadow:
        0 0 8px var(--emphasis-crit-glow),
        0 0 16px var(--emphasis-crit-glow),
        0 0 24px rgba(255, 140, 0, 0.5) !important;
    animation: emphasis-crit-pulse 0.5s ease-out forwards;
}

/* Fail/fumble emphasis - red glow, shake animation */
.emphasis-fail {
    text-shadow:
        0 0 8px var(--emphasis-fail-glow),
        0 0 16px rgba(255, 0, 0, 0.6) !important;
    animation: emphasis-fail-shake 0.5s ease-out forwards;
}

/* Max roll emphasis - bright white glow */
.emphasis-max {
    text-shadow:
        0 0 6px var(--emphasis-max-glow),
        0 0 12px rgba(255, 255, 255, 0.8),
        0 0 18px rgba(255, 255, 255, 0.4) !important;
    animation: emphasis-max-pulse 0.4s ease-out forwards;
}

/* Min roll emphasis - dim weak glow */
.emphasis-min {
    text-shadow:
        0 0 4px var(--emphasis-min-glow),
        0 0 8px rgba(100, 100, 100, 0.4) !important;
    animation: emphasis-min-fade 0.4s ease-out forwards;
}

/* Normal - no special emphasis, just standard text shadow for readability */
.emphasis-normal {
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000,
        1px -1px 0 #000,
        -1px 1px 0 #000;
}

/* === EMPHASIS ANIMATIONS === */

@keyframes emphasis-crit-pulse {
    0% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1.5); opacity: 1; }
    70% { transform: scale(1.3); }
    100% { transform: scale(1.2); opacity: 1; }
}

@keyframes emphasis-fail-shake {
    0% { transform: scale(1.2) rotate(0deg); opacity: 0.5; }
    20% { transform: scale(1.1) rotate(-5deg); opacity: 1; }
    40% { transform: scale(1.05) rotate(5deg); }
    60% { transform: scale(1.02) rotate(-3deg); }
    80% { transform: scale(1.01) rotate(2deg); }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

@keyframes emphasis-max-pulse {
    0% { transform: scale(0.9); opacity: 0.7; }
    50% { transform: scale(1.3); opacity: 1; }
    100% { transform: scale(1.1); opacity: 1; }
}

@keyframes emphasis-min-fade {
    0% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(0.95); opacity: 0.85; }
}

/* === COMBINED CONVENIENCE CLASSES ===
 * Pre-combined classes for common scenarios.
 * Format: roll-{type}-{emphasis}
 */

/* Hit rolls */
.roll-hit-normal {
    color: var(--roll-color-hit) !important;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.roll-hit-crit {
    color: var(--roll-color-hit) !important;
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow), 0 0 24px rgba(255, 140, 0, 0.5) !important;
    animation: emphasis-crit-pulse 0.5s ease-out forwards;
}

.roll-hit-fail {
    color: var(--roll-color-neutral) !important;  /* Miss uses grey */
    text-shadow: 0 0 8px var(--emphasis-fail-glow), 0 0 16px rgba(255, 0, 0, 0.6) !important;
    animation: emphasis-fail-shake 0.5s ease-out forwards;
}

/* Damage rolls */
.roll-damage-normal {
    color: var(--roll-color-damage) !important;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.roll-damage-crit {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow), 0 0 24px rgba(255, 140, 0, 0.5) !important;
    animation: emphasis-crit-pulse 0.5s ease-out forwards;
}

.roll-damage-max {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 6px var(--emphasis-max-glow), 0 0 12px rgba(255, 255, 255, 0.8), 0 0 18px rgba(255, 255, 255, 0.4) !important;
    animation: emphasis-max-pulse 0.4s ease-out forwards;
}

.roll-damage-min {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 4px var(--emphasis-min-glow), 0 0 8px rgba(100, 100, 100, 0.4) !important;
    animation: emphasis-min-fade 0.4s ease-out forwards;
}

/* Healing rolls */
.roll-heal-normal {
    color: var(--roll-color-heal) !important;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.roll-heal-max {
    color: var(--roll-color-heal) !important;
    text-shadow: 0 0 6px var(--emphasis-max-glow), 0 0 12px rgba(255, 255, 255, 0.8), 0 0 18px rgba(255, 255, 255, 0.4) !important;
    animation: emphasis-max-pulse 0.4s ease-out forwards;
}

.roll-heal-min {
    color: var(--roll-color-heal) !important;
    text-shadow: 0 0 4px var(--emphasis-min-glow), 0 0 8px rgba(100, 100, 100, 0.4) !important;
    animation: emphasis-min-fade 0.4s ease-out forwards;
}

/* Status rolls */
.roll-status-normal {
    color: var(--roll-color-status) !important;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.roll-status-max {
    color: var(--roll-color-status) !important;
    text-shadow: 0 0 6px var(--emphasis-max-glow), 0 0 12px rgba(255, 255, 255, 0.8), 0 0 18px rgba(255, 255, 255, 0.4) !important;
    animation: emphasis-max-pulse 0.4s ease-out forwards;
}

.roll-status-min {
    color: var(--roll-color-status) !important;
    text-shadow: 0 0 4px var(--emphasis-min-glow), 0 0 8px rgba(100, 100, 100, 0.4) !important;
    animation: emphasis-min-fade 0.4s ease-out forwards;
}

/* Neutral (miss, etc) */
.roll-neutral-normal {
    color: var(--roll-color-neutral) !important;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* AC bonus display - dark green (defensive stat) */
.ac-bonus-text {
    color: #2e7d32 !important;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Defend cooldown text - grey/muted */
.defend-cooldown-text {
    color: #888 !important;
    font-size: 0.9em;
    text-shadow: 1px 1px 0 #000;
}

/* === Single Choice Button Fix ===
 * When there's only one choice, don't stretch it across full width.
 * Use :only-child selector to target single choice scenario.
 */
#choices-container .choice-button:only-child {
    flex: 0 1 auto;
    min-width: 11.25rem;  /* 180px */
    max-width: 80%;
}

/* === Dev Mode Indicator === */
#dev-mode-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #00ff00;
    color: #000;
    padding: 5px 10px;
    font-size: 12px;  /* Fixed size - don't scale with base font */
    font-weight: bold;
    border-radius: 3px;
    z-index: var(--z-dev-tools);
    display: none;
}

#dev-mode-indicator.visible {
    display: block;
}

/* === Theme Selector Base Styles ===
 * Default styling - individual themes override colors via their CSS files
 */
#theme-selector {
    position: fixed;
    top: 40px;
    right: 10px;
    padding: 8px;
    z-index: var(--z-dev-tools);
    font-size: 12px;  /* Fixed size - don't scale with base font */
    font-family: inherit;
    display: none;
}

#theme-selector.visible {
    display: block;
}

#theme-selector label {
    margin-right: 6px;
}

#theme-selector select {
    font-family: inherit;
    font-size: 12px;
    padding: 4px 8px;
    cursor: pointer;
}

/* Ken Burns toggle container */
.ken-burns-toggle-container {
    margin-top: var(--spacing-sm);
}

.ken-burns-toggle-container label {
    cursor: pointer;
}

.ken-burns-toggle-container input[type="checkbox"] {
    margin-right: 0.375rem;
}

/* Forced dice roll input container */
.forced-roll-container {
    margin-top: var(--spacing-sm);
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-family: var(--dev-font, inherit);
    font-size: var(--dev-font-size, 0.65rem);
}

.forced-roll-container label {
    white-space: nowrap;
    font-size: inherit;
}

.forced-roll-container input[type="number"] {
    width: 2.5rem;
    padding: 0.125rem 0.25rem;
    font-size: inherit;
    font-family: inherit;
    border: var(--dev-input-border, 0.0625rem solid rgba(255, 255, 255, 0.3));
    border-radius: var(--dev-input-radius, 0.1875rem);
    background: var(--dev-input-bg, rgba(0, 0, 0, 0.3));
    color: var(--dev-input-color, inherit);
    text-align: center;
}

.forced-roll-container input[type="number"]::placeholder {
    color: var(--dev-input-placeholder, rgba(255, 255, 255, 0.5));
    font-style: italic;
    font-size: inherit;
}

/* Hide spinner buttons on number input */
.forced-roll-container input[type="number"]::-webkit-outer-spin-button,
.forced-roll-container input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.forced-roll-container input[type="number"] {
    -moz-appearance: textfield;
}

/* Undo button error flash state */
#dev-undo-btn.error {
    background-color: #c44 !important;
    color: #fff !important;
    border-color: #c44 !important;
}

/* === Reset Button (Base Styles) ===
 * Positioned fixed in corner. Themes override colors.
 * Uses fixed px sizes to avoid scaling with base font.
 */
#reset-btn {
    position: fixed;
    bottom: 10px;
    right: 10px;
    width: 44px;
    height: 44px;
    background: rgba(100, 100, 100, 0.8);
    color: #fff;
    border: none;
    border-radius: 50%;
    font-size: 20px;  /* Fixed size - don't scale with base font */
    cursor: pointer;
    z-index: var(--z-modal);
    transition: background 0.2s, transform 0.1s;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
}

#reset-btn:hover {
    background: rgba(120, 120, 120, 0.9);
    transform: scale(1.05);
}

#reset-btn:active {
    transform: scale(0.95);
}

/* === Password Lockout Message ===
 * Displayed when user exceeds max failed password attempts.
 * Positioned center of password container.
 */
#lockout-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--lockout-bg, rgba(75, 62, 42, 0.95));
    color: var(--lockout-color, #fffbe9);
    padding: var(--spacing-xl) 1.875rem;  /* 20px 30px */
    border-radius: var(--spacing-sm);
    font-size: 1.2rem;
    text-align: center;
    z-index: var(--z-modal);
    animation: fadeIn 0.3s ease-out;
    display: none;
}

#lockout-message.visible {
    display: block;
}

#password-inputs.dimmed {
    opacity: 0.3;
}

/* === Password Character Input Sizing ===
 * Base sizing using CSS variables - themes override colors/borders only.
 * Uses text-align for horizontal centering.
 * Uses box-sizing: content-box so line-height = height works for vertical centering.
 */
.password-char {
    width: var(--password-char-width);
    height: var(--password-char-height);
    font-size: var(--password-char-font-size);
    line-height: var(--password-char-height);
    text-align: center;
    padding: 0;
}

@media (max-width: 56.25em) {
    .password-char {
        width: var(--password-char-width-tablet);
        height: var(--password-char-height-tablet);
        font-size: var(--password-char-font-size-tablet);
        line-height: var(--password-char-height-tablet);
    }
}

@media (max-width: 37.5em) {
    .password-char {
        width: var(--password-char-width-mobile);
        height: var(--password-char-height-mobile);
        font-size: var(--password-char-font-size-mobile);
        line-height: var(--password-char-height-mobile);
    }
}

/* === Animated Background Video ===
 * Video element for WebM/MP4 animated backgrounds.
 * Hidden by default, shown when video background is active.
 */
#bg-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
    pointer-events: none;
}

/* === Ken Burns Effect (Apple-style subtle zoom) ===
 * Slow, cinematic zoom effect on backgrounds.
 * Toggled via dev mode checkbox, persists in localStorage.
 */
@keyframes ken-burns-zoom {
    0% {
        transform: scale(1);
    }
    100% {
        transform: scale(1.04);
    }
}

#background-layer.ken-burns {
    animation: ken-burns-zoom 30s ease-out forwards;
    /* Slightly larger to prevent edge visibility during zoom */
    transform-origin: center center;
}

#bg-video.ken-burns {
    animation: ken-burns-zoom 30s ease-out forwards;
    transform-origin: center center;
}

/* === Text Box Header Band ===
 * Header band contains the title and speed/volume controls.
 * Themes style the appearance (colors, fonts, decorations).
 */
#text-box-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    padding: 4px 12px !important;
    position: relative;
}

/* Spacer takes up left side to push controls right */
#header-spacer {
    flex: 1;
}

/* Title is absolutely centered, independent of controls width */
#text-box-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-weight: bold;
    text-align: center;
    font-size: var(--label-font-size, 0.85rem);
    /* Prevent title from overflowing into buttons */
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    pointer-events: none;
}

#text-controls {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    /* Override theme margins - controls are now inside header band */
    margin: 0 !important;
}

/* Remove extra margin from volume control */
#text-controls #volume-control {
    margin-left: 0 !important;
}

/* === Control Button Height Consistency ===
 * All header buttons (speed-btn and mute-btn) must have same height.
 * Step 1: Normalize font-size to a common base (use small-font-size variable)
 * Step 2: Apply consistent height in em units (relative to normalized font)
 */
#text-controls .speed-btn,
#text-controls .mute-btn {
    font-size: var(--small-font-size, 0.75rem) !important;
    box-sizing: border-box !important;
    height: 2em !important;
    line-height: 1 !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 0.6em !important;
}

/* === Choice Button Overflow Fix ===
 * Prevent text from overflowing choice buttons.
 * Buttons should grow as needed but text should wrap.
 */
.choice-button {
    overflow: hidden;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
}

/* === Text Box Layout Fix ===
 * Priority: Choices must NEVER be cut off.
 * Strategy:
 *   1. Text box grows based on content (height: auto)
 *   2. Text box stops growing at max-height
 *   3. When max-height is reached, story-output becomes scrollable
 *   4. Button area never shrinks or gets cut
 */

#text-box {
    max-height: 75% !important;
}

#text-box.ending-scene {
    max-height: 85% !important;
}

/* Story output: grows with content, scrolls only when text-box hits max-height */
#story-output {
    flex: 1 1 auto !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
}

/* Button area: never shrink, never cut */
#button-area {
    flex-shrink: 0 !important;
}

/* Responsive: ensure max-height is consistent */
@media (max-width: 56.25em) {
    #text-box {
        max-height: 75% !important;
    }
}

@media (max-width: 37.5em) {
    #text-box {
        max-height: 75% !important;
    }
}

@media (orientation: portrait) {
    /* Keep smaller text on portrait/mobile */
    :root {
        --base-font-size-fallback: 1.125rem;  /* 18px - original size */
        --base-font-size: clamp(1rem, 1.4vw, 1.5rem);
        --story-font-size: 1.1rem;
    }

    #text-box {
        max-height: 75% !important;
    }

    #text-box.ending-scene {
        max-height: 90% !important;
    }

    /* Fix banner/controls overlap in portrait mode */
    #text-box-header {
        flex-direction: column !important;
        padding: 4px 8px !important;
    }

    /* Title no longer needs absolute positioning in stacked layout */
    #text-box-title {
        position: static !important;
        transform: none !important;
        max-width: 100% !important;
        order: 1;
        margin-bottom: 4px;
    }

    /* Hide the spacer in portrait - not needed with stacked layout */
    #header-spacer {
        display: none !important;
    }

    /* Controls go below the title */
    #text-controls {
        order: 2;
        justify-content: center !important;
        width: 100%;
    }

    /* Dev mode panel - hidden by default in portrait, toggle on tap */
    #theme-selector {
        display: none !important;
        top: 50px !important;
        right: 5px !important;
        max-width: calc(100vw - 20px) !important;
    }

    #theme-selector.portrait-expanded {
        display: block !important;
    }

    /* Dev mode indicator becomes a toggle button in portrait */
    #dev-mode-indicator {
        cursor: pointer !important;
        user-select: none !important;
    }

    #dev-mode-indicator::after {
        content: ' ▼';
        font-size: 10px;
    }

    #dev-mode-indicator.expanded::after {
        content: ' ▲';
    }

    /* Reset button to top-left in portrait */
    #reset-btn {
        top: 10px !important;
        bottom: auto !important;
        left: 10px !important;
        right: auto !important;
        /* Safe area for iPhone notch */
        top: max(10px, env(safe-area-inset-top, 10px)) !important;
        left: max(10px, env(safe-area-inset-left, 10px)) !important;
    }

    /* Battle stats panels - smaller on portrait */
    .battle-stats-panel {
        min-width: 140px !important;
        padding: 8px 10px !important;
        font-size: 0.8rem !important;
    }

    .battle-stats-panel .stats-header {
        font-size: 0.7rem !important;
        margin-bottom: 6px !important;
    }

    .battle-stats-panel .stat-row {
        margin-bottom: 4px !important;
    }

    .battle-stats-panel .stat-label {
        font-size: 0.6rem !important;
        min-width: 18px !important;
    }

    .battle-stats-panel .stat-bar-outer {
        height: 10px !important;
    }

    .battle-stats-panel .stat-value {
        font-size: 0.55rem !important;
        min-width: 30px !important;
    }

    /* Player stats - position higher to avoid text box overlap */
    .battle-stats-panel.player-stats {
        bottom: calc(var(--battle-log-height) + 15px) !important;
        left: 5px !important;
    }

    /* Enemy stats - smaller gap from top */
    .battle-stats-panel.enemy-stats {
        top: 5px !important;
        right: 5px !important;
    }

    /* Safe area padding for iPhone home indicator */
    .battle-log-panel {
        padding-bottom: max(8px, env(safe-area-inset-bottom, 8px)) !important;
    }

    #text-box {
        padding-bottom: max(8px, env(safe-area-inset-bottom, 8px)) !important;
    }

    /* VN container safe area margins */
    #vn-container {
        padding-bottom: env(safe-area-inset-bottom, 0) !important;
    }
}

/* === GAME MECHANICS STYLES === */

/* === Inventory Display === */
#inventory-display {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px 12px;
    border-radius: 8px;
    display: none;
    z-index: var(--z-battle-ui);
    max-width: 200px;
}

.inventory-label {
    color: #ffd700;
    font-size: 0.75rem;
    font-weight: bold;
    margin-bottom: 4px;
}

.inventory-item {
    display: inline-block;
    background: rgba(255, 215, 0, 0.2);
    color: #fffbe9;
    padding: 2px 8px;
    margin: 2px;
    border-radius: 4px;
    font-size: 0.7rem;
    border: 1px solid rgba(255, 215, 0, 0.4);
}

/* === Item Notifications === */
.item-notification {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: bold;
    z-index: var(--z-modal);
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
}

.item-notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.item-notification.fade-out {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
}

.item-notification.item-added {
    border: 2px solid #4caf50;
}

.item-notification.item-added .item-icon {
    color: #4caf50;
}

.item-notification.item-used {
    border: 2px solid #ff9800;
}

.item-notification.item-used .item-icon {
    color: #ff9800;
}

/* === BATTLE STATS PANELS (Unified HP/Mana/Limit) === */
/* Clean, theme-aware stat panels for battle UI */

/* Theme-aware color variables - themes can override these */
:root {
    /* Battle log panel height - dynamically calculated in JS based on:
       - battleLogMaxLines * battleLogLineHeight (log content)
       - 7.5rem (battle choices - 2 rows of 3rem buttons + gap)
       - 1.5rem (panel padding)
       Default: 2 lines * 2.2rem = 4.4rem + 7.5rem + 1.5rem = 13.4rem */
    --battle-log-height: 13.4rem;

    --battle-hp-high: #4caf50;
    --battle-hp-medium: #ff9800;
    --battle-hp-low: #f44336;
    --battle-mana: #2196f3;
    --battle-limit: #9b59b6;           /* Purple for limit bar */
    --battle-limit-ready: #a855f7;     /* Brighter purple when ready */
    --battle-panel-bg: rgba(0, 0, 0, 0.85);
    --battle-panel-border: rgba(255, 255, 255, 0.3);
    --battle-text: #fff;
    --battle-text-dim: rgba(255, 255, 255, 0.7);
}

.battle-stats-panel {
    position: absolute;
    min-width: 200px;
    width: auto;
    z-index: var(--z-battle-ui);
    padding: 12px 14px;
    /* Base styling - themes SHOULD override these */
    background: var(--battle-panel-bg);
    border: 2px solid var(--battle-panel-border);
    border-radius: 6px;
}

.battle-stats-panel.player-stats {
    /* Position just above the battle log panel with a small gap */
    bottom: calc(var(--battle-log-height) + 10px);
    left: 10px;
    /* Fixed width to prevent layout shift when status icons appear */
    min-width: 160px;
}

.battle-stats-panel.enemy-stats {
    top: 10px;
    right: 10px;
}

/* Panel header (character name) */
.stats-header {
    font-size: 0.85rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    color: var(--battle-text);
    white-space: nowrap;
    min-height: 1.3em;  /* Reserve vertical space for status icons to prevent layout shift */
    line-height: 1.3;
}

.stats-header .ac-display {
    font-weight: normal;
    font-size: 0.75rem;
    opacity: 0.7;
    display: inline-block;
    min-width: 5.5em;  /* Prevent box expansion when AC changes (e.g., "AC 11" → "AC 15+") */
    text-align: left;
}

/* Status icon slot next to player name - fixed size reserved box */
.status-icon-slot {
    display: inline-block;
    min-width: 4em;  /* Reserve space for ~3-4 status icons to prevent layout shift */
    min-height: 1em;  /* Reserve vertical space to prevent HP bar shift */
    text-align: left;
    vertical-align: middle;
}

.status-icon-slot .status-icon {
    font-size: 0.85rem;
    cursor: help;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    vertical-align: middle;
    line-height: 1;
}

/* Stat row layout: [Label] [Bar] [Value] */
.stat-row {
    display: block;
    display: -webkit-flex;
    display: flex;
    align-items: center;
    margin-bottom: 6px;
}

/* Fallback spacing for browsers without gap */
.stat-row > * {
    margin-right: 6px;
}
.stat-row > *:last-child {
    margin-right: 0;
}

@supports (gap: 6px) {
    .stat-row {
        gap: 6px;
    }
    .stat-row > * {
        margin-right: 0;
    }
}

.stat-label {
    font-size: 0.7rem;
    font-weight: bold;
    text-transform: uppercase;
    min-width: 22px;
    color: var(--battle-text-dim);
}

.stat-bar-outer {
    flex: 1;
    height: 12px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-bar {
    height: 100%;
    transition: width 0.3s ease-out;
    border-radius: 3px;
}

.stat-value {
    font-size: 0.65rem;
    min-width: 36px;
    text-align: right;
    color: var(--battle-text);
}

/* HP bar colors - use CSS variables for theme override */
.stat-bar.hp-bar.hp-high {
    background: var(--battle-hp-high);
}

.stat-bar.hp-bar.hp-medium {
    background: var(--battle-hp-medium);
}

.stat-bar.hp-bar.hp-low {
    background: var(--battle-hp-low);
    animation: hp-pulse 0.5s ease-in-out infinite alternate;
}

@keyframes hp-pulse {
    from { opacity: 1; }
    to { opacity: 0.7; }
}

/* Mana bar color */
.stat-bar.mana-bar {
    background: var(--battle-mana);
}

/* HP Regen glow effect - green pulsing glow */
.stat-bar.hp-bar.hp-regen {
    box-shadow: 0 0 8px #2ecc71, 0 0 12px #2ecc71;
    animation: hp-regen-pulse 1.5s ease-in-out infinite;
}

@keyframes hp-regen-pulse {
    0%, 100% { box-shadow: 0 0 4px #2ecc71, 0 0 8px rgba(46, 204, 113, 0.5); }
    50% { box-shadow: 0 0 10px #2ecc71, 0 0 16px rgba(46, 204, 113, 0.8); }
}

/* Mana Regen glow effect - blue pulsing glow */
.stat-bar.mana-bar.mana-regen {
    box-shadow: 0 0 8px #3498db, 0 0 12px #3498db;
    animation: mana-regen-pulse 1.5s ease-in-out infinite;
}

@keyframes mana-regen-pulse {
    0%, 100% { box-shadow: 0 0 4px #3498db, 0 0 8px rgba(52, 152, 219, 0.5); }
    50% { box-shadow: 0 0 10px #3498db, 0 0 16px rgba(52, 152, 219, 0.8); }
}

/* Regen text colors in battle log - pulsing */
.regen-hp {
    color: #2ecc71;
    font-size: var(--battle-special-size, 1.2rem);
    font-weight: bold;
    animation: regen-text-pulse 1s ease-in-out infinite;
}

.regen-mp {
    color: #3498db;
    font-size: var(--battle-special-size, 1.2rem);
    font-weight: bold;
    animation: regen-text-pulse 1s ease-in-out infinite;
}

@keyframes regen-text-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Stat value and label text regen effects - color and pulse */
.stat-value.hp-regen,
.stat-label.hp-regen {
    color: #2ecc71;
    text-shadow: 0 0 6px rgba(46, 204, 113, 0.8);
    animation: stat-text-hp-pulse 1.5s ease-in-out infinite;
}

.stat-value.mana-regen,
.stat-label.mana-regen {
    color: #3498db;
    text-shadow: 0 0 6px rgba(52, 152, 219, 0.8);
    animation: stat-text-mana-pulse 1.5s ease-in-out infinite;
}

@keyframes stat-text-hp-pulse {
    0%, 100% {
        color: #2ecc71;
        text-shadow: 0 0 4px rgba(46, 204, 113, 0.6);
    }
    50% {
        color: #58d68d;
        text-shadow: 0 0 10px rgba(46, 204, 113, 1);
    }
}

@keyframes stat-text-mana-pulse {
    0%, 100% {
        color: #3498db;
        text-shadow: 0 0 4px rgba(52, 152, 219, 0.6);
    }
    50% {
        color: #5dade2;
        text-shadow: 0 0 10px rgba(52, 152, 219, 1);
    }
}

/* Limit bar colors */
.stat-bar.limit-bar {
    background: var(--battle-limit);
}

.stat-bar.limit-bar.limit-high {
    background: var(--battle-limit-ready);
    animation: limit-pulse 1s infinite;
}

.stat-bar.limit-bar.limit-ready {
    background: var(--battle-limit-ready);
    animation: limit-ready-pulse 0.5s infinite;
}

@keyframes limit-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

@keyframes limit-ready-pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--battle-limit-ready); }
    50% { opacity: 0.9; box-shadow: 0 0 10px var(--battle-limit-ready); }
}

/* Special styling for limit label */
.stat-label.limit-label {
    color: #ffd700;
}

/* AC display states */
.ac-display.boosted {
    color: #4caf50;
}

.ac-display.reduced {
    color: #ff6b6b;
}

/* Stagger bar - HIDDEN (system disabled for simplicity) */
.stagger-container {
    display: none;
}

.stagger-bar {
    width: 100%;
    height: 3px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 2px;
    overflow: hidden;
}

.stagger-fill {
    height: 100%;
    background: #ff9800;
    transition: width 0.2s ease-out;
    border-radius: 2px;
}

.stagger-fill.stagger-warning {
    background: #ff5722;
}

.stagger-fill.stagger-danger {
    background: #f44336;
    animation: stagger-pulse 0.3s infinite;
}

@keyframes stagger-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* Status icons row */
.status-icons {
    display: block;
    display: -webkit-flex;
    display: flex;
    flex-wrap: wrap;
    margin-top: 6px;
}

.status-icons > * {
    margin: 2px;
}

@supports (gap: 4px) {
    .status-icons {
        gap: 4px;
    }
    .status-icons > * {
        margin: 0;
    }
}

.status-icon {
    font-size: 0.85rem;
    cursor: help;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

/* === LEGACY COMPATIBILITY (for non-battle HP displays) === */
.hp-container,
.mana-container {
    display: none;
}

/* === Damage Numbers (WoW-style) ===
 * These now use the unified roll display system.
 * Base color = roll type (damage=red, heal=green, hit=yellow, neutral=grey)
 * Emphasis = result category (crit, max, min, fail, normal)
 */
.damage-number,
.battle-damage-number {
    position: absolute;
    font-size: 1.5rem;
    font-weight: normal;
    font-style: normal;
    z-index: var(--z-battle-effects);
    pointer-events: none;
    animation: damage-float 1.5s ease-out forwards;
    font-family: var(--damage-font);
    transform: translateX(-50%);
    text-align: center;
    color: var(--roll-color-damage);  /* Default to red (damage) */
}

/* WoW-style damage numbers - larger for visibility */
.damage-number.wow-style {
    font-size: var(--battle-special-size);
    font-weight: bold;
    font-style: normal;
    letter-spacing: 0;
    animation: wow-damage-float 4s ease-out forwards;
}

/* Legacy .damage class - now maps to unified roll-damage-normal */
.damage-number.damage,
.battle-damage-number.damage {
    color: var(--roll-color-damage);
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000,
        1px -1px 0 #000,
        -1px 1px 0 #000;
}

/* Critical damage - red base + crit emphasis (was gold, now red with orange glow) */
.damage-number.crit {
    font-size: var(--battle-special-size);
    color: var(--roll-color-damage);
    text-shadow:
        0 0 8px var(--emphasis-crit-glow),
        0 0 16px var(--emphasis-crit-glow),
        0 0 24px rgba(255, 140, 0, 0.5);
    animation: wow-crit-float 4s ease-out forwards;
}

/* WoW-style "CRIT!" label - damage color + crit emphasis */
.damage-number.crit-label {
    font-size: var(--battle-special-size);
    color: var(--roll-color-damage);
    text-shadow:
        0 0 8px var(--emphasis-crit-glow),
        0 0 16px var(--emphasis-crit-glow);
    animation: wow-crit-label-float 4s ease-out forwards;
}

/* Max damage - red base + max emphasis (bright white glow) */
.damage-number.maxdamage {
    font-size: var(--battle-special-size);
    color: var(--roll-color-damage);
    text-shadow:
        0 0 6px var(--emphasis-max-glow),
        0 0 12px rgba(255, 255, 255, 0.8),
        0 0 18px rgba(255, 255, 255, 0.4);
    animation: wow-crit-float 4s ease-out forwards;
}

/* WoW-style "MAX!" label - damage color + max emphasis */
.damage-number.max-label {
    font-size: var(--battle-special-size);
    color: var(--roll-color-damage);
    text-shadow:
        0 0 6px var(--emphasis-max-glow),
        0 0 12px rgba(255, 255, 255, 0.8);
    animation: wow-crit-label-float 4s ease-out forwards;
}

/* Min damage - red base + min emphasis (dim glow) */
.damage-number.mindamage {
    font-size: var(--battle-special-size);
    color: var(--roll-color-damage);
    text-shadow:
        0 0 4px var(--emphasis-min-glow),
        0 0 8px rgba(100, 100, 100, 0.4);
    animation: wow-damage-float 4s ease-out forwards;
}

/* WoW-style "MIN" label - damage color + min emphasis */
.damage-number.min-label {
    font-size: var(--battle-special-size);
    color: var(--roll-color-damage);
    text-shadow:
        0 0 4px var(--emphasis-min-glow),
        0 0 8px rgba(100, 100, 100, 0.4);
    animation: wow-hit-label-float 4s ease-out forwards;
}

/* WoW-style "Hit" label for normal hits - uses yellow (hit roll type) */
.damage-number.hit-label {
    font-size: var(--battle-special-size);
    color: var(--roll-color-hit);
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000,
        1px -1px 0 #000,
        -1px 1px 0 #000;
    animation: wow-hit-label-float 4s ease-out forwards;
}

/* Hit label floats up starting from above the damage number */
@keyframes wow-hit-label-float {
    0% {
        opacity: 1;
        transform: translateY(-2em) scale(1);
    }
    10% {
        opacity: 1;
        transform: translateY(-2.5em) scale(1);
    }
    50% {
        opacity: 1;
        transform: translateY(-4em) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(-6em) scale(1);
    }
}

/* Crit label floats up starting from above the damage number (relative offset via em units) */
@keyframes wow-crit-label-float {
    0% {
        opacity: 1;
        transform: translateY(-2em) scale(1);
    }
    10% {
        opacity: 1;
        transform: translateY(-2.5em) scale(1);
    }
    20% {
        transform: translateY(-3em) scale(1);
    }
    50% {
        opacity: 1;
        transform: translateY(-5em) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(-8em) scale(1);
    }
}

/* Heal - green base color (heal roll type) */
.damage-number.heal,
.battle-damage-number.heal {
    color: var(--roll-color-heal);
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000;
}

/* Max heal - green + max emphasis */
.damage-number.maxheal {
    color: var(--roll-color-heal);
    text-shadow:
        0 0 6px var(--emphasis-max-glow),
        0 0 12px rgba(255, 255, 255, 0.8);
}

/* Min heal - green + min emphasis */
.damage-number.minheal {
    color: var(--roll-color-heal);
    text-shadow:
        0 0 4px var(--emphasis-min-glow),
        0 0 8px rgba(100, 100, 100, 0.4);
}

/* DOT damage - red base (damage type) */
.damage-number.dot {
    color: var(--roll-color-damage);
    font-size: var(--battle-special-size);
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000;
}

/* Miss - grey/neutral base color */
.damage-number.miss {
    color: var(--roll-color-neutral);
    font-size: var(--battle-special-size);
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000;
}

/* Stat change floating numbers */
.damage-number.stat-change {
    font-size: var(--battle-special-size);
}

/* Mana change - uses status color (blue) */
.damage-number.mana-change {
    color: var(--roll-color-status);
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000;
}

/* Limit break - purple (special resource, kept distinct) */
.damage-number.limit-change {
    color: #9b59b6;
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000;
}

/* AC changes - uses dark green (defensive stat) */
.damage-number.ac-boost,
.damage-number.ac-reduce {
    color: #2e7d32;
    text-shadow:
        2px 2px 0 #000,
        -1px -1px 0 #000;
}

/* WoW-style float animation - scrolls up and fades (4s duration) */
@keyframes wow-damage-float {
    0% {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
    }
    8% {
        opacity: 1;
        transform: translateX(-50%) translateY(-5px) scale(1);
    }
    15% {
        transform: translateX(-50%) translateY(-15px) scale(1);
    }
    50% {
        opacity: 1;
        transform: translateX(-50%) translateY(-40px) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-80px) scale(1);
    }
}

/* Crit animation - bigger pop, longer hang time (3s total) */
@keyframes wow-crit-float {
    0% {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
    }
    10% {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px) scale(1);
    }
    20% {
        transform: translateX(-50%) translateY(-20px) scale(1);
    }
    40% {
        opacity: 1;
        transform: translateX(-50%) translateY(-40px) scale(1);
    }
    70% {
        opacity: 1;
        transform: translateX(-50%) translateY(-60px) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-100px) scale(1);
    }
}

/* Legacy animation for non-WoW style */
@keyframes damage-float {
    0% {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
    }
    50% {
        opacity: 1;
        transform: translateX(-50%) translateY(-30px) scale(1.2);
    }
    100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-60px) scale(0.8);
    }
}

/* === Combat Announcements (mid-screen CRITICAL/FUMBLE) === */
.combat-announcement {
    position: absolute;
    left: 50%;
    top: 40%;
    transform: translate(-50%, -50%);
    font-size: 3.5rem;
    font-weight: 900;
    font-family: 'Arial Black', 'Impact', sans-serif;
    letter-spacing: 4px;
    z-index: var(--z-overlay);
    pointer-events: none;
    text-transform: uppercase;
}

.combat-announcement.critical {
    color: #ffd700;
    text-shadow:
        4px 4px 0 #000,
        -2px -2px 0 #000,
        2px -2px 0 #000,
        -2px 2px 0 #000,
        0 0 30px rgba(255, 215, 0, 0.8),
        0 0 60px rgba(255, 150, 0, 0.6);
    animation: announcement-critical 1.5s ease-out forwards;
}

.combat-announcement.fumble {
    color: #ff3333;
    text-shadow:
        4px 4px 0 #000,
        -2px -2px 0 #000,
        2px -2px 0 #000,
        -2px 2px 0 #000,
        0 0 20px rgba(255, 0, 0, 0.6);
    animation: announcement-fumble 1.5s ease-out forwards;
}

@keyframes announcement-critical {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.3);
    }
    15% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
    }
    30% {
        transform: translate(-50%, -50%) scale(1);
    }
    70% {
        opacity: 1;
        transform: translate(-50%, -60%) scale(1);
    }
    100% {
        opacity: 0;
        transform: translate(-50%, -80%) scale(0.8);
    }
}

@keyframes announcement-fumble {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.3) rotate(-5deg);
    }
    10% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.1) rotate(3deg);
    }
    20% {
        transform: translate(-50%, -50%) scale(1) rotate(-2deg);
    }
    30% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
    }
    70% {
        opacity: 1;
        transform: translate(-50%, -55%) scale(1);
    }
    100% {
        opacity: 0;
        transform: translate(-50%, -70%) scale(0.9);
    }
}

/* === Damage Flash === */
.damage-flash {
    animation: sprite-damage-flash 0.3s ease-out;
}

@keyframes sprite-damage-flash {
    0%, 100% {
        filter: none;
    }
    25%, 75% {
        filter: brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5);
    }
    50% {
        filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(3);
    }
}

/* === Dice Roll Styles === */
.dice-roll {
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
}

.dice-roll.dice-success {
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid #4caf50;
}

.dice-roll.dice-failure {
    background: rgba(244, 67, 54, 0.2);
    border: 2px solid #f44336;
}

.dice-roll.dice-crit {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 152, 0, 0.3));
    border: 2px solid #ffd700;
    animation: crit-glow 0.5s ease-in-out 3;
}

.dice-roll.dice-fumble {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(0, 0, 0, 0.3));
    border: 2px solid #8b0000;
}

@keyframes crit-glow {
    0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
}

.skill-check-label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.8;
    margin-bottom: 4px;
}

.crit-text {
    color: #ffd700;
    font-weight: bold;
    font-size: 1.2rem;
    margin-top: 8px;
    text-shadow: 1px 1px 0 #000;
}

.fumble-text {
    color: #ff4444;
    font-weight: bold;
    font-size: 1.2rem;
    margin-top: 8px;
    text-shadow: 1px 1px 0 #000;
}

/* Damage roll min/max indicators - shared fumble/crit style */
/* Use high specificity to override theme-specific roll-result colors */
.damage-min,
.roll-result .damage-min,
.battle-log-content .roll-result .damage-min {
    color: var(--battle-fumble-color) !important;
    text-shadow: 0 0 10px #ff0000 !important;
}

.damage-max,
.roll-result .damage-max,
.battle-log-content .roll-result .damage-max {
    color: var(--battle-crit-color) !important;
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.6) !important;
}

/* === Battle Log === */
.battle-log {
    padding: 8px 12px;
    margin-bottom: 0;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    border-left: 3px solid #4caf50;
}

.battle-log.enemy-turn {
    border-left-color: #f44336;
    background: rgba(244, 67, 54, 0.1);
}

/* === Battle Result === */
.battle-result {
    text-align: center;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 8px;
    font-size: 1.4rem;
    font-weight: bold;
}

.battle-result.victory {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.3));
    border: 2px solid #4caf50;
    color: #4caf50;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.battle-result.defeat {
    background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(183, 28, 28, 0.3));
    border: 2px solid #f44336;
    color: #f44336;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

/* === Battle Action Buttons === */
.choice-button.battle-action {
    /* Battle buttons can have subtle styling differentiation */
}

/* === CUSTOM BATTLE UI (Pokemon-style) === */

/* Hide normal text box during battle */
#text-box.battle-mode {
    display: none !important;
}

/* Battle UI container - covers the full VN area */
#battle-ui {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: var(--z-battle-ui);
    pointer-events: none;
}

#battle-ui > * {
    pointer-events: auto;
}

/* Battle HP/Mana containers get battle-specific positioning */
#battle-ui .hp-container.battle-hp,
#battle-ui .mana-container.battle-mana {
    display: block;
}

/* Battle log panel - replaces text box at bottom */
.battle-log-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    /* Fixed height to prevent layout shift - matches --battle-log-height variable */
    /* Height = log content (4.4rem) + choices (7rem) + padding (1.5rem) = ~13rem */
    /* Use fixed height (not min-height) so player stats panel positions correctly */
    height: var(--battle-log-height, 13.4rem);
    background: rgba(0, 0, 0, 0.85);
    border-top: 0.1875rem solid rgba(255, 255, 255, 0.3);  /* 3px */
    padding: var(--spacing-sm) var(--spacing-md);
    box-sizing: border-box;
    /* Enable flex layout for skill/item submenus to fill space */
    display: flex;
    flex-direction: column;
    overflow: hidden;  /* Prevent overflow, submenus scroll internally */
}

.battle-log-content {
    /* Fixed height to prevent text shift when lines are added */
    /* Height = content (2 lines * 1.6rem = 3.2rem) + padding (0.5rem * 2 = 1rem) = 4.2rem */
    /* Line height must match TUNING.ui.battleLogLineHeight for consistent calculation */
    height: var(--battle-log-content-height, 4.2rem);
    box-sizing: border-box;  /* Include padding in height */
    overflow: hidden;  /* Never scroll - JS truncates to max lines */
    padding: 0.5rem 1rem;  /* Reduced vertical padding for tighter fit */
    font-size: var(--battle-text-size);
    line-height: 1.6rem;  /* Fixed rem value, not multiplier - must match TUNING.ui.battleLogLineHeight */
    color: var(--battle-text-color);
    /* Text starts at top - space is pre-reserved for 2 lines */
    flex-shrink: 0;  /* Don't shrink when in flex container */
}

.battle-log-content .roll-result {
    color: var(--battle-text-color);
}

/* Dice numbers: grey while spinning, inherit when final
 * The unified roll classes (roll-hit-normal, roll-damage-normal, etc.)
 * now control the final color, so we don't force yellow here anymore.
 */
.battle-log-content .dice-number,
.roll-result .dice-number {
    color: var(--battle-roll-color);
}

/* REMOVED: Old rule that forced all dice-final to yellow
 * This broke the unified system where damage dice should be red.
 * Color is now controlled by roll-type classes (roll-hit-*, roll-damage-*, etc.)
 */
/* .battle-log-content .dice-number.dice-final,
.roll-result .dice-number.dice-final {
    color: var(--battle-hit-dice-color) !important;
} */

/* Highlight numbers/effects in battle messages (e.g., "+4 AC", "2 turns") */
.battle-log-content strong:not(.dice-number),
.battle-log-content b,
#battle-log-content strong:not(.dice-number),
#battle-log-content b {
    color: var(--battle-number-color, #ffd700) !important;
    font-size: var(--battle-special-size, 1.2rem);
}

/* Battle number - for inline numbers in messages (e.g., "Restored 12 MP!") */
.battle-number {
    color: var(--battle-number-color, #ffd700);
    font-size: var(--battle-special-size, 1.2rem);
    font-weight: bold;
    vertical-align: baseline;
}


/* === Pokemon-style 4-choice Grid === */
.battle-choices {
    /* Fallback for browsers without grid support */
    display: block;
    display: -webkit-flex;
    display: flex;
    flex-wrap: wrap;
    /* Modern browsers: use grid */
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    padding: var(--spacing-md);
    height: 7rem;  /* Fixed height for 2 rows of buttons */
}

/* Fallback spacing for browsers without gap support */
.battle-choices > * {
    margin: 0.375rem;  /* 6px */
}

/* Modern browsers: use gap and remove margin fallback */
@supports (gap: 0.75rem) {
    .battle-choices {
        gap: var(--spacing-md);
    }
    .battle-choices > * {
        margin: 0;
    }
}

.battle-choices .choice-button {
    padding: 10px 14px;
    font-size: 0.9rem;
    font-weight: bold;
    min-height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.battle-choices .choice-button:disabled,
.battle-choices .choice-button.waiting {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
    filter: grayscale(30%);
}

/* Container waiting state - subtle visual cue */
.battle-choices.waiting {
    opacity: 0.85;
}

/* === Attack Effect Animations === */
.attack-effect {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: var(--z-battle-effects);
    animation: attack-flash 0.6s ease-out forwards;
}

.attack-effect.attack-physical {
    background: radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.4), transparent 60%);
}

.attack-effect.attack-fire {
    background: radial-gradient(circle at 50% 30%, rgba(255, 100, 0, 0.5), rgba(255, 200, 0, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-ice {
    background: radial-gradient(circle at 50% 30%, rgba(150, 220, 255, 0.5), rgba(200, 240, 255, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-lightning {
    background: radial-gradient(circle at 50% 30%, rgba(255, 255, 100, 0.6), rgba(255, 255, 200, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-poison {
    background: radial-gradient(circle at 50% 30%, rgba(150, 0, 150, 0.5), rgba(100, 200, 0, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-psychic {
    background: radial-gradient(circle at 50% 30%, rgba(200, 100, 255, 0.5), rgba(150, 50, 200, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-holy {
    background: radial-gradient(circle at 50% 30%, rgba(255, 255, 200, 0.6), rgba(255, 215, 0, 0.3) 40%, transparent 70%);
}

.attack-effect.attack-dark {
    background: radial-gradient(circle at 50% 30%, rgba(50, 0, 80, 0.6), rgba(100, 0, 100, 0.3) 40%, transparent 70%);
}

@keyframes attack-flash {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    30% {
        opacity: 1;
        transform: scale(1.1);
    }
    100% {
        opacity: 0;
        transform: scale(1.2);
    }
}

/* === Screen Shake (when player is hit) === */
@keyframes screen-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

#vn-container.screen-shake {
    animation: screen-shake 0.3s ease-out;
}

/* === Battle Log Styling === */
.battle-log.crit {
    background: rgba(255, 215, 0, 0.3);
    border-left-color: #ffd700;
}

.battle-log.fumble {
    background: rgba(139, 0, 0, 0.3);
    border-left-color: #8b0000;
}

.battle-log.status-messages {
    background: rgba(128, 128, 128, 0.2);
    border-left-color: #888;
    font-style: italic;
}

/* Status damage numbers in battle log - red color for damage */
.battle-log-content .battle-number,
.battle-log-messages .battle-number,
#battle-log-content .battle-number {
    color: var(--roll-color-damage, #ff4444) !important;
    font-size: var(--battle-special-size, 1.2rem);
    font-weight: bold;
}

/* === Status Effect Icons === */
.status-icons {
    display: block;
    display: -webkit-flex;
    display: flex;
    margin-top: 4px;
    flex-wrap: wrap;
}

/* Fallback spacing for browsers without gap support */
.status-icons > * {
    margin: 2px;
}

/* Modern browsers: use gap and remove margin fallback */
@supports (gap: 4px) {
    .status-icons {
        gap: 4px;
    }
    .status-icons > * {
        margin: 0;
    }
}

.status-icon {
    font-size: 1rem;
    cursor: help;
    position: relative;
    display: inline-block;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    animation: status-pulse 2s ease-in-out infinite;
}

.status-icon sub {
    font-size: 0.6rem;
    position: absolute;
    bottom: -2px;
    right: -4px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 50%;
    padding: 1px 3px;
    color: #fff;
}

@keyframes status-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* === Terrain Indicator === */
.terrain-indicator {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    padding: 6px 16px;
    border-radius: 20px;
    color: #fff;
    font-size: 0.85rem;
    font-weight: bold;
    z-index: var(--z-battle-ui);
    display: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.terrain-icon {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 6px;
}

/* === DOT Damage Numbers === */
.battle-damage-number.dot {
    color: #9b59b6;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
}

/* === Expanded Menu State (skill/item menus) === */
/* When skill/item menu is open, the battle-log-panel expands and player stats must move up */
.battle-log-panel.menu-expanded {
    --battle-log-height-expanded: 22rem;  /* Expanded height for skill/item menus */
    height: var(--battle-log-height-expanded);
}

/* Player stats panel moves up when menu is expanded */
.battle-stats-panel.player-stats.menu-expanded {
    bottom: calc(22rem + 10px) !important;  /* Match --battle-log-height-expanded */
}

/* === Skill Menu (replaces battle choices in battle-log-panel) === */
.skill-submenu {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 12px;
    overflow: hidden;
    min-height: 0;  /* Allow flex item to shrink below content size */
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    align-self: stretch !important;  /* Stretch to fill parent width in flex container */
    align-items: stretch;  /* Children (skill-list) stretch to full width */
}

.skill-submenu-title {
    color: #ffd700;
    font-size: 0.75rem;
    font-weight: bold;
    margin-bottom: 8px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    flex-shrink: 0;
}

.skill-list {
    /* Fallback for older browsers */
    display: flex;
    flex-wrap: wrap;
    /* Modern browsers: use grid */
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    grid-template-rows: repeat(3, 1fr);  /* 3 equal rows to fill vertical space */
    gap: 8px;
    overflow-y: auto;  /* Scroll if content exceeds available space */
    overflow-x: hidden;
    flex: 1;  /* Take remaining space in flex container */
    min-height: 0;  /* Allow shrinking below content size */
    padding: 2px; /* Prevent hover transform from triggering scrollbars */
    width: 100% !important;
    max-width: 100% !important;
    justify-items: stretch;  /* Grid items stretch to fill cell width */
    align-items: stretch;  /* Grid items stretch to fill cell height */
}

/* Fallback spacing for browsers without gap */
@supports not (gap: 8px) {
    .skill-list > * {
        margin: 4px;
    }
}

.skill-item {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 10px 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    text-align: center;
    box-sizing: border-box;
    width: 100%;
    min-height: 50px;
}

.skill-item:hover {
    background: rgba(255, 255, 255, 0.25);
}

.skill-item:active {
    background: rgba(255, 255, 255, 0.15);
}

.skill-item.disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.skill-item.disabled .skill-name {
    color: var(--roll-color-neutral, #888) !important;
}

.skill-item.disabled .skill-cost {
    color: var(--roll-color-neutral, #888) !important;
}

.skill-item.disabled:hover {
    background: rgba(255, 255, 255, 0.1);
}

.skill-name {
    color: #fff;
    font-weight: bold;
    font-size: 0.85rem;
}

.skill-cost {
    color: #60a5fa;
    font-size: 0.8rem;
    margin-top: 3px;
}

.skill-cost.insufficient {
    color: #f44336;
}

/* Effect icon slot - reserves fixed space to prevent layout shift */
.skill-effect-slot {
    display: inline-block;
    min-width: 1.2em;
    min-height: 1em;
    font-size: 0.85rem;
    text-align: center;
    vertical-align: middle;
    margin-top: 2px;
}

/* Locked skill slots - show player can earn more */
.skill-item.skill-item-locked {
    background: rgba(255, 255, 255, 0.03);
    border: 1px dashed rgba(255, 255, 255, 0.2);
    cursor: default;
    opacity: 0.6;
}

.skill-item.skill-item-locked:hover {
    background: rgba(255, 255, 255, 0.05);
}

.skill-name-locked {
    color: #666 !important;
    font-style: italic;
}

.skill-cost-locked {
    color: #555 !important;
    font-size: 0.65rem;
}

/* Back button uses theme CSS variables for consistent styling.
 * Themes can override --btn-* variables or define .skill-back-btn directly. */
.skill-back-btn {
    margin-top: auto;
    padding-top: 8px;
    width: 100%;
    padding: 8px 12px;
    background: var(--btn-bg);
    color: var(--btn-color);
    border: var(--btn-border);
    border-radius: var(--btn-border-radius);
    cursor: pointer;
    font-size: var(--button-font-size, 0.85rem);
    font-family: inherit;
    flex-shrink: 0;
}

.skill-back-btn:hover {
    background: var(--btn-bg-hover);
}

/* === Item Submenu (replaces battle choices in battle-log-panel) === */
.item-submenu {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 8px 12px;
    overflow: hidden;
    min-height: 0;  /* Allow flex item to shrink below content size */
}

.item-submenu-title {
    color: #f39c12;
    font-size: 0.75rem;
    font-weight: bold;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--battle-panel-border);
    margin-bottom: 6px;
    flex-shrink: 0;
}

.item-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;  /* Allow shrinking below content size */
}

.item-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.item-row:hover {
    background: rgba(255, 255, 255, 0.25);
}

.item-row.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    justify-content: center;
}

.item-row .item-icon {
    font-size: 1rem;
}

.item-row .item-name {
    flex: 1;
    color: var(--battle-text);
    font-size: 0.8rem;
}

.item-row .item-qty {
    color: var(--battle-text-dim);
    font-size: 0.75rem;
}

/* === Battle Choice Button Type Colors === */
.battle-choices .choice-button[data-action="attack"] {
    background: linear-gradient(to bottom, #e74c3c, #c0392b);
    border-color: #a93226;
}

.battle-choices .choice-button[data-action="skill"] {
    background: linear-gradient(to bottom, #9b59b6, #8e44ad);
    border-color: #7d3c98;
}

.battle-choices .choice-button[data-action="defend"] {
    background: linear-gradient(to bottom, #3498db, #2980b9);
    border-color: #2471a3;
}

.battle-choices .choice-button[data-action="item"] {
    background: linear-gradient(to bottom, #f39c12, #d68910);
    border-color: #b9770e;
}

.battle-choices .choice-button:hover {
    filter: brightness(1.1);
    transform: scale(1.02);
}

.battle-choices .choice-button:active {
    filter: brightness(0.9);
    transform: scale(0.98);
}

/* === Critical/Fumble Text in Log === */
.battle-log .crit-text {
    display: inline-block;
    color: #ffd700;
    font-weight: bold;
    animation: crit-bounce 0.5s ease-out;
}

.battle-log .fumble-text {
    display: inline-block;
    color: #ff4444;
    font-weight: bold;
}

@keyframes crit-bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

/* === Animated Dice Roll Numbers === */
.dice-number {
    display: inline-block;
    font-size: var(--battle-special-size);
    line-height: 1;
    vertical-align: baseline;
    transition: transform 0.1s ease-out;
}

.dice-number.dice-spinning {
    animation: dice-wobble 0.1s ease-in-out infinite;
    color: #aaa;
}

.dice-number.dice-final {
    animation: dice-reveal 0.3s ease-out forwards;
    /* color is set by roll-* classes, don't override here */
}

/* Legacy dice-crit/fumble classes - now use unified system
 * Crit: yellow (hit type) + crit emphasis
 * Fumble: grey (neutral) + fail emphasis
 */
.dice-number.dice-crit {
    color: var(--roll-color-hit) !important;
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow);
    animation: dice-crit-reveal 0.5s ease-out forwards;
}

.dice-number.dice-fumble {
    color: var(--roll-color-neutral) !important;
    text-shadow: 0 0 8px var(--emphasis-fail-glow), 0 0 16px rgba(255, 0, 0, 0.6);
    animation: dice-fumble-reveal 0.5s ease-out forwards;
}

@keyframes dice-wobble {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-2px) scale(1.05); }
}

@keyframes dice-reveal {
    0% { transform: scale(1.5); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes dice-crit-reveal {
    0% { transform: scale(0.5); opacity: 0; }
    40% { transform: scale(2); opacity: 1; }
    70% { transform: scale(1.8); }
    100% { transform: scale(1.5); }
}

@keyframes dice-fumble-reveal {
    0% { transform: scale(1.5) rotate(0deg); opacity: 0; }
    30% { transform: scale(1.2) rotate(-5deg); opacity: 1; }
    60% { transform: scale(1.1) rotate(5deg); }
    100% { transform: scale(1) rotate(0deg); }
}

/* === Roll Result Display (Collapsing Modifiers System) === */

.roll-result, .damage-result {
    display: block;
    margin: 4px 0;
    line-height: 1.8;  /* Tall enough to fit larger dice numbers without shifting */
    /* Reset theme overrides that may interfere */
    -webkit-text-stroke: 0 !important;
}

/* Modifier that appears then collapses into the number */
.mod-part {
    display: inline;
    opacity: 0;
    font-size: var(--battle-special-size);
    line-height: 1;
    vertical-align: baseline;
    color: var(--battle-number-color);  /* Modifier values are yellow (e.g., "+ 3") */
}

.mod-part.mod-animate-in {
    opacity: 1;
    animation: mod-slide-in 0.3s ease-out forwards;
}

.mod-part.mod-collapsing {
    animation: mod-collapse 0.25s ease-in forwards;
}

.mod-source {
    color: var(--battle-roll-color);  /* Source stays grey (e.g., "(STR)") */
    font-size: var(--battle-text-size);
    font-style: italic;
}

/* Overheal modifier - grey/muted to show "wasted" healing */
.overheal-mod {
    color: var(--roll-neutral-color, #888);
    font-size: var(--battle-special-size);
}

@keyframes mod-slide-in {
    0% { opacity: 0; transform: translateX(10px); }
    100% { opacity: 1; transform: translateX(0); }
}

@keyframes mod-collapse {
    0% { opacity: 1; transform: translateX(0) scale(1); }
    100% { opacity: 0; transform: translateX(-15px) scale(0.7); }
}

/* Pop effect when number updates after collapse */
.dice-number.dice-pop {
    animation: dice-number-pop 0.25s ease-out;
}

@keyframes dice-number-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

/* HIT/MISS/DAMAGE result text - no background, just colored text */
.roll-result-text {
    display: inline;
    font-weight: bold;
    font-size: var(--battle-text-size);
    line-height: 1;
    vertical-align: baseline;
}

/* Legacy result classes - now use unified system */
.result-hit {
    color: var(--roll-color-hit);
}

.result-miss {
    color: var(--roll-color-neutral);
}

.result-crit {
    color: var(--roll-color-hit);
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow);
}

.result-fumble {
    color: var(--roll-color-neutral);
    text-shadow: 0 0 8px var(--emphasis-fail-glow);
}

/* Heal roll styling - green (heal type) */
.dice-number.dice-heal {
    color: var(--roll-color-heal) !important;
}

.result-heal {
    color: var(--roll-color-heal);
    font-weight: bold;
}

/* Defend message styling - high specificity to override theme colors */
.defend-ac-bonus,
.battle-log-content .defend-ac-bonus,
.battle-log-messages .defend-ac-bonus,
#battle-log-content .defend-ac-bonus,
div.battle-log-content span.defend-ac-bonus {
    color: var(--battle-roll-color, #888) !important;  /* Grey for AC bonus */
    font-size: var(--battle-special-size, 1.2rem) !important;
    font-weight: bold !important;
}

.defend-duration,
.battle-log-content .defend-duration,
.battle-log-messages .defend-duration,
#battle-log-content .defend-duration,
div.battle-log-content span.defend-duration {
    color: var(--battle-roll-color, #888) !important;  /* Grey for duration */
    font-size: var(--battle-special-size, 1.2rem) !important;
    font-weight: bold !important;
}

@keyframes result-pop {
    0% { transform: scale(0.5); opacity: 0; }
    60% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes result-crit-pop {
    0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
    40% { transform: scale(1.5) rotate(5deg); opacity: 1; }
    70% { transform: scale(1.3) rotate(-2deg); }
    100% { transform: scale(1.2) rotate(0deg); opacity: 1; }
}

@keyframes result-fumble-shake {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.1) translateX(-3px); opacity: 1; }
    40% { transform: scale(1.05) translateX(3px); }
    60% { transform: scale(1.02) translateX(-2px); }
    80% { transform: scale(1.01) translateX(1px); }
    100% { transform: scale(1) translateX(0); opacity: 1; }
}

/* Damage display - no special styling for damage numbers, just inherit */
.damage-dice {
    /* Damage dice don't get crit/fumble colors - that's only for d20 attack rolls */
}

/* DAMAGE text - uses red (damage type) by default */
.damage-text {
    display: inline;
    font-weight: bold;
    color: var(--roll-color-damage);
    font-size: var(--battle-text-size);
}

/* Legacy damage-crit-text - red + crit emphasis */
.damage-text.damage-crit-text {
    color: var(--roll-color-damage);
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow);
}

/* Legacy damage-min/max - now uses unified emphasis system
 * Color stays red, only the glow/outline changes
 */
.damage-text.damage-min,
.roll-result .damage-text.damage-min,
.battle-log-content .roll-result .damage-text.damage-min {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 4px var(--emphasis-min-glow), 0 0 8px rgba(100, 100, 100, 0.4) !important;
}

.damage-text.damage-max,
.roll-result .damage-text.damage-max,
.battle-log-content .roll-result .damage-text.damage-max {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 6px var(--emphasis-max-glow), 0 0 12px rgba(255, 255, 255, 0.8) !important;
}

/* Damage dice styling - red for damage rolls */
.damage-dice {
    color: var(--roll-color-damage);
    font-size: var(--battle-special-size);
    font-weight: bold;
}

/* Legacy min/max damage dice - red + emphasis, NOT color change */
.dice-number.damage-min,
.roll-result .dice-number.damage-min {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 4px var(--emphasis-min-glow), 0 0 8px rgba(100, 100, 100, 0.4) !important;
    animation: emphasis-min-fade 0.4s ease-out forwards;
}

.dice-number.damage-max,
.roll-result .dice-number.damage-max {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 6px var(--emphasis-max-glow), 0 0 12px rgba(255, 255, 255, 0.8) !important;
    animation: emphasis-max-pulse 0.4s ease-out forwards;
}

/* === Effectiveness Messages === */
.effectiveness-super {
    color: #4caf50;
    font-weight: bold;
}

.effectiveness-weak {
    color: #ff9800;
    font-style: italic;
}

.effectiveness-immune {
    color: #9e9e9e;
    font-style: italic;
}

/* Limit Break Animation Effect */
.limit-break-effect {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    display: -webkit-flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.5) 0%, rgba(255, 100, 0, 0.3) 50%, transparent 70%);
    animation: limit-break-flash 1.5s ease-out forwards;
    z-index: var(--z-overlay);
    pointer-events: none;
}

.limit-break-text {
    font-size: 2rem;
    font-weight: bold;
    color: #fff;
    text-shadow:
        0 0 10px #ffd700,
        0 0 20px #ff8c00,
        0 0 30px #ff4500,
        2px 2px 4px rgba(0, 0, 0, 0.8);
    animation: limit-break-zoom 1s ease-out forwards;
}

@keyframes limit-break-flash {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
}

@keyframes limit-break-zoom {
    0% { transform: scale(0.5); opacity: 0; }
    30% { transform: scale(1.3); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* === Summon Indicator === */

.summon-indicator {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(100, 200, 255, 0.9);
    color: #1a1a3e;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    display: block;
    display: -webkit-flex;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 10px rgba(100, 200, 255, 0.5);
    animation: summon-glow 2s infinite;
    z-index: var(--z-battle-ui);
}

/* Fallback spacing for browsers without gap support */
.summon-indicator > * {
    margin: 0 4px;
}

.summon-indicator > *:first-child {
    margin-left: 0;
}

.summon-indicator > *:last-child {
    margin-right: 0;
}

/* Modern browsers: use gap and remove margin fallback */
@supports (gap: 8px) {
    .summon-indicator {
        gap: 8px;
    }
    .summon-indicator > * {
        margin: 0;
    }
}

.summon-icon {
    font-size: 1.2rem;
}

.summon-duration {
    font-size: 0.7rem;
    opacity: 0.8;
}

@keyframes summon-glow {
    0%, 100% { box-shadow: 0 2px 10px rgba(100, 200, 255, 0.5); }
    50% { box-shadow: 0 2px 20px rgba(100, 200, 255, 0.8); }
}

/* Summon turn in battle log */
.battle-log.summon-turn {
    background: rgba(100, 200, 255, 0.2);
    border-left: 3px solid #64c8ff;
}

/* === Mid-Fight Dialogue === */

.battle-dialogue {
    position: absolute;
    bottom: calc(var(--battle-log-height) + 8px);  /* Position above battle log panel */
    left: 50%;
    transform: translateX(-50%);
    z-index: var(--z-battle-effects);
    animation: dialogue-appear 0.3s ease-out;
}

.dialogue-bubble {
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    padding: 10px 20px;
    border-radius: 16px;
    font-size: var(--base-font-size, 1.35rem);
    font-style: italic;
    max-width: 80vw;
    width: max-content;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    position: relative;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.dialogue-bubble::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 10px 10px 0 10px;
    border-style: solid;
    border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
}

@keyframes dialogue-appear {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.battle-dialogue.fade-out {
    animation: dialogue-fade 0.3s ease-out forwards;
}

@keyframes dialogue-fade {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
    }
}

/* === Battle Log Special Entries === */

.battle-log.limit-break {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 100, 0, 0.2));
    border-left: 4px solid #ffd700;
    font-weight: bold;
}

.battle-log.summon {
    background: rgba(100, 200, 255, 0.2);
    border-left: 4px solid #64c8ff;
}

.battle-log.passive {
    font-style: italic;
    opacity: 0.9;
}

/* === Battle Intro/Outro Transitions === */

/* Battle intro overlay - dims screen and shows announcement */
.battle-intro-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    z-index: var(--z-overlay);
    display: flex;
    display: -webkit-flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    animation: battle-intro-dim 2s ease-out forwards;
}

@keyframes battle-intro-dim {
    0% {
        background: rgba(0, 0, 0, 0);
    }
    20% {
        background: rgba(0, 0, 0, 0.8);
    }
    70% {
        background: rgba(0, 0, 0, 0.8);
    }
    100% {
        background: rgba(0, 0, 0, 0);
    }
}

/* Battle start text announcement */
.battle-intro-text {
    font-size: calc(var(--base-font-size, 1.35rem) * 2);
    font-weight: bold;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 8px;
    text-shadow:
        0 0 20px rgba(255, 0, 0, 0.8),
        0 0 40px rgba(255, 0, 0, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
    opacity: 0;
    transform: scale(0.5);
    animation: battle-intro-text-appear 2s ease-out forwards;
    /* Ensure text stays centered and doesn't overflow */
    text-align: center;
    max-width: 90%;
    word-wrap: break-word;
}

@keyframes battle-intro-text-appear {
    0% {
        opacity: 0;
        transform: scale(0.5);
    }
    25% {
        opacity: 1;
        transform: scale(1.2);
    }
    40% {
        transform: scale(1);
    }
    70% {
        opacity: 1;
        transform: scale(1);
    }
    100% {
        opacity: 0;
        transform: scale(1.5);
    }
}

/* Enemy slide-in animation during intro */
#sprite-layer.battle-intro-enemy {
    animation: battle-enemy-slide-in 1.5s ease-out forwards;
    /* Prevent background rectangle on mobile */
    background: transparent !important;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}

#sprite-layer.battle-intro-enemy img {
    /* Ensure sprites have no visible background during animation */
    background: transparent !important;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}

@keyframes battle-enemy-slide-in {
    0% {
        transform: translateX(100%);
        opacity: 0;
    }
    60% {
        transform: translateX(-5%);
        opacity: 1;
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Flash effect for battle start impact */
.battle-intro-flash {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fff;
    z-index: var(--z-overlay);
    opacity: 0;
    pointer-events: none;
    animation: battle-intro-flash-anim 0.3s ease-out forwards;
    animation-delay: 0.4s;
}

@keyframes battle-intro-flash-anim {
    0% {
        opacity: 0;
    }
    50% {
        opacity: 0.7;
    }
    100% {
        opacity: 0;
    }
}

/* === Battle Outro (Victory/Defeat) === */

/* Victory overlay */
.battle-outro-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: var(--z-overlay);
    display: flex;
    display: -webkit-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
}

.battle-outro-overlay.victory {
    background: linear-gradient(
        135deg,
        rgba(255, 215, 0, 0.3) 0%,
        rgba(76, 175, 80, 0.4) 50%,
        rgba(255, 215, 0, 0.3) 100%
    );
    animation: victory-bg-pulse 1.5s ease-in-out infinite;
}

.battle-outro-overlay.defeat {
    background: linear-gradient(
        135deg,
        rgba(139, 0, 0, 0.5) 0%,
        rgba(0, 0, 0, 0.7) 50%,
        rgba(139, 0, 0, 0.5) 100%
    );
    animation: defeat-bg-fade 2s ease-out forwards;
}

.battle-outro-overlay.flee {
    background: rgba(100, 100, 100, 0.5);
    animation: flee-bg-fade 1s ease-out forwards;
}

@keyframes victory-bg-pulse {
    0%, 100% {
        opacity: 0.8;
    }
    50% {
        opacity: 1;
    }
}

@keyframes defeat-bg-fade {
    0% {
        background: rgba(139, 0, 0, 0.3);
    }
    100% {
        background: rgba(0, 0, 0, 0.8);
    }
}

@keyframes flee-bg-fade {
    0% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}

/* Victory/Defeat text */
.battle-outro-text {
    font-size: calc(var(--base-font-size, 1.35rem) * 2.3);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 6px;
    margin-bottom: 20px;
    opacity: 0;
    animation: outro-text-appear 0.8s ease-out forwards;
    animation-delay: 0.2s;
}

.battle-outro-text.victory {
    color: #ffd700;
    text-shadow:
        0 0 20px rgba(255, 215, 0, 0.8),
        0 0 40px rgba(255, 215, 0, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
}

.battle-outro-text.defeat {
    color: #ff4444;
    text-shadow:
        0 0 20px rgba(255, 0, 0, 0.8),
        0 0 40px rgba(139, 0, 0, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
}

.battle-outro-text.flee {
    color: #aaa;
    text-shadow:
        0 0 10px rgba(150, 150, 150, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
    font-size: calc(var(--base-font-size, 1.35rem) * 1.6);
}

@keyframes outro-text-appear {
    0% {
        opacity: 0;
        transform: translateY(-30px) scale(0.8);
    }
    60% {
        opacity: 1;
        transform: translateY(5px) scale(1.05);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Subtext (e.g., "You earned X experience") */
.battle-outro-subtext {
    font-size: 1.2rem;
    color: #fff;
    opacity: 0;
    animation: outro-subtext-appear 0.5s ease-out forwards;
    animation-delay: 0.8s;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

@keyframes outro-subtext-appear {
    0% {
        opacity: 0;
        transform: translateY(10px);
    }
    100% {
        opacity: 0.9;
        transform: translateY(0);
    }
}

/* Victory sparkles effect */
.victory-sparkle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #ffd700;
    border-radius: 50%;
    pointer-events: none;
    animation: sparkle-float 2s ease-out forwards;
}

@keyframes sparkle-float {
    0% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(-100px) scale(0.3);
    }
}

/* Defeat fade effect on enemy sprite */
#sprite-layer.battle-outro-defeat {
    animation: enemy-victory-pose 1s ease-out forwards;
}

@keyframes enemy-victory-pose {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1.05);
    }
}

/* Victory fade effect on enemy sprite */
#sprite-layer.battle-outro-victory {
    animation: enemy-defeat-fade 1s ease-out forwards;
}

@keyframes enemy-defeat-fade {
    0% {
        opacity: 1;
        transform: translateY(0);
    }
    50% {
        opacity: 0.5;
        transform: translateY(10px);
    }
    100% {
        opacity: 0;
        transform: translateY(30px);
    }
}

/* ============================================================================
   QTE SYSTEM (Quick Time Events)
   ============================================================================
   Theme-aware QTE timing bar for battle combat.
   All colors use CSS variables that themes can override.
*/

/* === QTE Theme Variables ===
   Themes should override these to match their visual style */
:root {
    /* Zone colors - Legacy (miss/partial/success/perfect) */
    --qte-zone-miss: #e74c3c;        /* Red - outer edges */
    --qte-zone-partial: #f39c12;     /* Yellow/Orange - glancing */
    --qte-zone-success: #27ae60;     /* Green - solid hit */
    --qte-zone-perfect: #3498db;     /* Blue - center sweet spot */

    /* Zone colors - Finalized Battle System (bad/normal/good/perfect) */
    --qte-zone-bad: #e74c3c;         /* Red - outer edges, worst result */
    --qte-zone-normal: #f39c12;      /* Yellow/Orange - standard roll */
    --qte-zone-good: #27ae60;        /* Green - advantage */
    /* --qte-zone-perfect already defined above */

    /* Marker colors */
    --qte-marker-color: #fff;
    --qte-marker-glow: rgba(255, 255, 255, 0.5);
    --qte-marker-perfect: var(--qte-zone-perfect);
    --qte-marker-success: var(--qte-zone-success);
    --qte-marker-partial: var(--qte-zone-partial);
    --qte-marker-miss: var(--qte-zone-miss);
    /* Finalized marker colors */
    --qte-marker-good: var(--qte-zone-good);
    --qte-marker-normal: var(--qte-zone-normal);
    --qte-marker-bad: var(--qte-zone-bad);

    /* Container styling */
    --qte-bg: rgba(0, 0, 0, 0.9);
    --qte-border: rgba(255, 255, 255, 0.3);
    --qte-text: #fff;
    --qte-text-dim: rgba(255, 255, 255, 0.7);

    /* Bar styling */
    --qte-bar-bg: rgba(0, 0, 0, 0.5);
    --qte-bar-border: rgba(255, 255, 255, 0.2);
    --qte-bar-height: 40px;

    /* Result text colors */
    --qte-result-perfect: #ffd700;
    --qte-result-success: #4caf50;
    --qte-result-partial: #ff9800;
    --qte-result-miss: #f44336;
    /* Finalized result colors */
    --qte-result-good: #4caf50;
    --qte-result-normal: #ff9800;
    --qte-result-bad: #f44336;
}

/* === QTE Container === */
.qte-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: var(--z-overlay);
    width: 80%;
    max-width: 500px;
    padding: 20px;
    background: var(--qte-bg);
    border: 2px solid var(--qte-border);
    border-radius: 12px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.9);
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    pointer-events: auto;
}

.qte-container.qte-visible {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

.qte-container.qte-hiding {
    opacity: 0;
    transform: translate(-50%, -50%) scale(1.1);
}

/* === QTE Type Variations === */
.qte-container.qte-accuracy {
    border-color: var(--qte-zone-success);
    box-shadow: 0 0 20px rgba(39, 174, 96, 0.3);
}

.qte-container.qte-dodge {
    border-color: var(--qte-zone-partial);
    box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
}

/* Finalized Battle System - Skill QTE */
.qte-container.qte-skill {
    border-color: var(--qte-zone-good);
    box-shadow: 0 0 20px rgba(39, 174, 96, 0.4);
}

/* Finalized Battle System - Defend QTE */
.qte-container.qte-defend {
    border-color: var(--qte-zone-perfect);
    box-shadow: 0 0 20px rgba(52, 152, 219, 0.4);
}

/* === QTE Label === */
.qte-label {
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 4px;
    margin-bottom: 16px;
    color: var(--qte-text);
    text-shadow: 0 0 10px currentColor;
}

.qte-accuracy .qte-label {
    color: var(--qte-zone-success);
}

.qte-dodge .qte-label {
    color: var(--qte-zone-partial);
}

.qte-skill .qte-label {
    color: var(--qte-zone-good);
}

.qte-defend .qte-label {
    color: var(--qte-zone-perfect);
}

/* Sub-label for defend QTE (shows enemy attack name) */
.qte-sublabel {
    font-size: 0.9rem;
    font-weight: normal;
    letter-spacing: 2px;
    margin-top: 4px;
    color: var(--qte-text-dim);
}

/* === QTE Bar Wrapper === */
.qte-bar-wrapper {
    position: relative;
    height: var(--qte-bar-height);
    margin-bottom: 16px;
}

/* === QTE Zones Visualization === */
.qte-zones {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    border-radius: 6px;
    overflow: hidden;
}

.qte-zone {
    height: 100%;
    transition: filter 0.1s ease;
}

.qte-zone-miss {
    background: var(--qte-zone-miss);
}

.qte-zone-partial {
    background: var(--qte-zone-partial);
}

.qte-zone-success {
    background: var(--qte-zone-success);
}

.qte-zone-perfect {
    background: var(--qte-zone-perfect);
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
}

/* Finalized Battle System Zones */
.qte-zone-bad {
    background: var(--qte-zone-bad);
}

.qte-zone-normal {
    background: var(--qte-zone-normal);
}

.qte-zone-good {
    background: var(--qte-zone-good);
}

/* Zone flash effects on result */
.qte-zones-flash-perfect .qte-zone-perfect {
    animation: qte-zone-flash 0.5s ease-out;
}

.qte-zones-flash-success .qte-zone-success {
    animation: qte-zone-flash 0.5s ease-out;
}

.qte-zones-flash-partial .qte-zone-partial {
    animation: qte-zone-flash 0.5s ease-out;
}

.qte-zones-flash-miss .qte-zone-miss {
    animation: qte-zone-flash 0.5s ease-out;
}

/* Finalized zone flash effects */
.qte-zones-flash-good .qte-zone-good {
    animation: qte-zone-flash 0.5s ease-out;
}

.qte-zones-flash-normal .qte-zone-normal {
    animation: qte-zone-flash 0.5s ease-out;
}

.qte-zones-flash-bad .qte-zone-bad {
    animation: qte-zone-flash 0.5s ease-out;
}

@keyframes qte-zone-flash {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.5); }
}

/* === QTE Timing Bar === */
.qte-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 2px solid var(--qte-bar-border);
    border-radius: 6px;
    pointer-events: none;
}

/* === QTE Marker === */
.qte-marker {
    position: absolute;
    top: -4px;
    bottom: -4px;
    width: 6px;
    background: var(--qte-marker-color);
    border-radius: 3px;
    transform: translateX(-50%);
    box-shadow:
        0 0 10px var(--qte-marker-glow),
        0 0 20px var(--qte-marker-glow);
    transition: box-shadow 0.1s ease;
    z-index: 10;
}

/* Marker color changes based on current zone */
.qte-marker.qte-marker-perfect {
    background: var(--qte-marker-perfect);
    box-shadow:
        0 0 15px var(--qte-marker-perfect),
        0 0 30px var(--qte-marker-perfect);
}

.qte-marker.qte-marker-success {
    background: var(--qte-marker-success);
    box-shadow:
        0 0 12px var(--qte-marker-success),
        0 0 24px var(--qte-marker-success);
}

.qte-marker.qte-marker-partial {
    background: var(--qte-marker-partial);
    box-shadow:
        0 0 10px var(--qte-marker-partial),
        0 0 20px var(--qte-marker-partial);
}

.qte-marker.qte-marker-miss {
    background: var(--qte-marker-miss);
    box-shadow:
        0 0 8px var(--qte-marker-miss),
        0 0 16px var(--qte-marker-miss);
}

/* Finalized Battle System marker colors */
.qte-marker.qte-marker-good {
    background: var(--qte-marker-good);
    box-shadow:
        0 0 12px var(--qte-marker-good),
        0 0 24px var(--qte-marker-good);
}

.qte-marker.qte-marker-normal {
    background: var(--qte-marker-normal);
    box-shadow:
        0 0 10px var(--qte-marker-normal),
        0 0 20px var(--qte-marker-normal);
}

.qte-marker.qte-marker-bad {
    background: var(--qte-marker-bad);
    box-shadow:
        0 0 8px var(--qte-marker-bad),
        0 0 16px var(--qte-marker-bad);
}

/* Marker stopped state */
.qte-marker.qte-marker-stopped {
    animation: qte-marker-pulse 0.3s ease-out;
}

@keyframes qte-marker-pulse {
    0% { transform: translateX(-50%) scaleY(1); }
    50% { transform: translateX(-50%) scaleY(1.3); }
    100% { transform: translateX(-50%) scaleY(1); }
}

/* Result state markers */
.qte-marker.qte-marker-result-perfect {
    animation: qte-marker-perfect-result 0.5s ease-out forwards;
}

.qte-marker.qte-marker-result-success {
    animation: qte-marker-success-result 0.3s ease-out forwards;
}

.qte-marker.qte-marker-result-partial {
    animation: qte-marker-partial-result 0.3s ease-out forwards;
}

.qte-marker.qte-marker-result-miss {
    animation: qte-marker-miss-result 0.3s ease-out forwards;
}

@keyframes qte-marker-perfect-result {
    0% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.5); }
    100% { transform: translateX(-50%) scale(1.2); }
}

@keyframes qte-marker-success-result {
    0% { transform: translateX(-50%) scale(1); }
    100% { transform: translateX(-50%) scale(1.1); }
}

@keyframes qte-marker-partial-result {
    0% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(0.9); }
    100% { transform: translateX(-50%) scale(1); }
}

@keyframes qte-marker-miss-result {
    0% { transform: translateX(-50%) scale(1) rotate(0deg); }
    25% { transform: translateX(-50%) scale(1) rotate(-10deg); }
    75% { transform: translateX(-50%) scale(1) rotate(10deg); }
    100% { transform: translateX(-50%) scale(1) rotate(0deg); }
}

/* === QTE Instructions === */
.qte-instructions {
    text-align: center;
    font-size: 0.9rem;
    color: var(--qte-text-dim);
    margin-bottom: 8px;
}

.qte-key {
    display: inline-block;
    background: var(--qte-border);
    color: var(--qte-text);
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
    margin: 0 4px;
}

/* === QTE Result Display === */
.qte-result {
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2px;
    animation: qte-result-appear 0.3s ease-out forwards;
}

.qte-result-perfect {
    color: var(--qte-result-perfect);
    text-shadow:
        0 0 20px var(--qte-result-perfect),
        0 0 40px var(--qte-result-perfect);
}

.qte-result-success {
    color: var(--qte-result-success);
    text-shadow: 0 0 15px var(--qte-result-success);
}

.qte-result-partial {
    color: var(--qte-result-partial);
    text-shadow: 0 0 10px var(--qte-result-partial);
}

.qte-result-miss {
    color: var(--qte-result-miss);
    text-shadow: 0 0 10px var(--qte-result-miss);
}

/* Finalized Battle System result text */
.qte-result-good {
    color: var(--qte-result-good);
    text-shadow: 0 0 10px var(--qte-result-good);
}

.qte-result-normal {
    color: var(--qte-result-normal);
    text-shadow: 0 0 10px var(--qte-result-normal);
}

.qte-result-bad {
    color: var(--qte-result-bad);
    text-shadow: 0 0 10px var(--qte-result-bad);
}

@keyframes qte-result-appear {
    0% {
        opacity: 0;
        transform: scale(0.5);
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

/* === Container Result Effects === */
.qte-container.qte-result-perfect {
    border-color: var(--qte-result-perfect);
    box-shadow: 0 0 30px var(--qte-result-perfect);
}

.qte-container.qte-result-success {
    border-color: var(--qte-result-success);
    box-shadow: 0 0 20px var(--qte-result-success);
}

.qte-container.qte-result-partial {
    border-color: var(--qte-result-partial);
    box-shadow: 0 0 15px var(--qte-result-partial);
}

.qte-container.qte-result-miss {
    border-color: var(--qte-result-miss);
    box-shadow: 0 0 15px var(--qte-result-miss);
}

/* Finalized Battle System container result states */
.qte-container.qte-result-good {
    border-color: var(--qte-result-good);
    box-shadow: 0 0 15px var(--qte-result-good);
}

.qte-container.qte-result-normal {
    border-color: var(--qte-result-normal);
    box-shadow: 0 0 15px var(--qte-result-normal);
}

.qte-container.qte-result-bad {
    border-color: var(--qte-result-bad);
    box-shadow: 0 0 15px var(--qte-result-bad);
}

/* === QTE Chain Combo Display === */
.qte-chain-progress {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 12px;
}

.qte-chain-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--qte-bar-border);
    border: 2px solid var(--qte-text-dim);
    transition: all 0.2s ease;
}

.qte-chain-dot-complete {
    background: var(--qte-zone-success);
    border-color: var(--qte-zone-success);
}

.qte-chain-dot-current {
    border-color: var(--qte-text);
    animation: qte-chain-dot-pulse 0.5s ease-in-out infinite;
}

@keyframes qte-chain-dot-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.qte-chain-flash {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    font-weight: bold;
    pointer-events: none;
    animation: qte-chain-flash-anim 0.3s ease-out forwards;
}

.qte-chain-flash-perfect {
    color: var(--qte-result-perfect);
}

.qte-chain-flash-success,
.qte-chain-flash-good {
    color: var(--qte-result-success);
}

.qte-chain-flash-partial,
.qte-chain-flash-normal {
    color: var(--qte-result-partial);
}

.qte-chain-flash-miss,
.qte-chain-flash-bad {
    color: var(--qte-result-miss);
}

@keyframes qte-chain-flash-anim {
    0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
    100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.5);
    }
}

.qte-chain-hit {
    animation: qte-chain-hit-pulse 0.2s ease-out;
}

@keyframes qte-chain-hit-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* === QTE Combo Display (Future Enhancement) === */
.qte-combo {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 12px;
}

.qte-combo-input {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    background: var(--qte-bar-bg);
    border: 2px solid var(--qte-border);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.qte-combo-pending {
    opacity: 0.5;
}

.qte-combo-current {
    opacity: 1;
    border-color: var(--qte-zone-success);
    animation: qte-combo-pulse 0.5s ease-in-out infinite;
}

.qte-combo-success {
    opacity: 1;
    background: var(--qte-zone-success);
    border-color: var(--qte-zone-success);
}

.qte-combo-fail {
    animation: qte-combo-shake 0.3s ease-out;
}

@keyframes qte-combo-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

@keyframes qte-combo-shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* === QTE Responsive Adjustments === */
@media (max-width: 37.5em) {
    .qte-container {
        width: 90%;
        padding: 16px;
    }

    .qte-label {
        font-size: 1.2rem;
        letter-spacing: 2px;
    }

    :root {
        --qte-bar-height: 32px;
    }

    .qte-result {
        font-size: 1.4rem;
    }

    .qte-combo-input {
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
    }
}

/* === Portrait Mode Adjustments === */
@media (orientation: portrait) {
    .qte-container {
        width: 85%;
        top: 40%;
    }

    .qte-label {
        margin-bottom: 12px;
    }

    .qte-bar-wrapper {
        margin-bottom: 12px;
    }

    /* === Battle UI Portrait Mode Centering Fixes === */

    /* Center the battle log panel content */
    .battle-log-panel {
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        width: 95% !important;
        max-width: 100% !important;
    }

    /* Center player stats panel above battle log */
    .battle-stats-panel.player-stats {
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        min-width: auto !important;
        width: auto !important;
        max-width: 90% !important;
    }

    /* Center enemy stats panel at top */
    .battle-stats-panel.enemy-stats {
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        top: max(5px, env(safe-area-inset-top, 5px)) !important;
        min-width: auto !important;
        width: auto !important;
        max-width: 90% !important;
    }

    /* Center terrain indicator */
    .terrain-indicator {
        top: calc(max(5px, env(safe-area-inset-top, 5px)) + 55px) !important;
    }

    /* Battle choices grid - ensure proper centering */
    .battle-choices {
        justify-content: center !important;
        align-content: center !important;
    }

    /* Skill/Item submenus - stretch to fill width */
    .skill-submenu,
    .item-submenu {
        align-items: stretch !important;
    }

    .skill-list {
        width: 100% !important;
    }

    /* === Password Screen Portrait Fixes === */
    /* Make password inputs wrap and fit in narrow portrait container */
    #password-inputs {
        flex-wrap: wrap !important;
        justify-content: center !important;
        max-width: 90% !important;
        gap: 8px !important;
    }

    .password-char {
        /* Smaller boxes for portrait - use relative sizing */
        width: min(var(--password-char-width-mobile), 15vw) !important;
        height: min(var(--password-char-height-mobile), 18vw) !important;
        font-size: min(var(--password-char-font-size-mobile), 5vw) !important;
        line-height: min(var(--password-char-height-mobile), 18vw) !important;
    }

    /* === Battle Intro Text Centering === */
    .battle-intro-text {
        text-align: center !important;
        max-width: 85% !important;
        /* Reduce letter spacing for narrow screens */
        letter-spacing: 4px !important;
        /* Smaller font for portrait */
        font-size: calc(var(--base-font-size, 1.35rem) * 1.5) !important;
    }

    /* === iOS Safe Area - Bottom Padding === */
    /* Ensure bottom UI elements don't overlap iPhone home indicator */
    #vn-container {
        padding-bottom: env(safe-area-inset-bottom, 0) !important;
    }

    .battle-log-panel {
        /* Account for iOS safe area in height calculation */
        padding-bottom: calc(var(--spacing-sm) + env(safe-area-inset-bottom, 0)) !important;
    }

    /* Choices container needs safe area padding too */
    .battle-choices {
        padding-bottom: env(safe-area-inset-bottom, 0) !important;
    }

    #text-box {
        padding-bottom: calc(var(--spacing-sm) + env(safe-area-inset-bottom, 0)) !important;
    }
}

/* =============================================================================
   ERROR SCREEN OVERLAY
   Shows user-friendly error messages for missing scenes/assets
============================================================================= */

.error-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-modal);
    animation: error-fade-in 0.3s ease-out;
}

@keyframes error-fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
}

.error-dialog {
    background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
    border: 2px solid #e74c3c;
    border-radius: 12px;
    padding: 2rem;
    max-width: 420px;
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.error-title {
    color: #e74c3c;
    font-size: 1.5rem;
    margin: 0 0 1rem 0;
    font-weight: bold;
}

.error-message {
    color: #ecf0f1;
    font-size: 1rem;
    margin: 0 0 0.75rem 0;
    line-height: 1.5;
}

.error-suggestion {
    color: #95a5a6;
    font-size: 0.875rem;
    margin: 0 0 1.5rem 0;
    font-style: italic;
}

.error-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.error-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.1s, background-color 0.2s;
}

.error-btn:hover {
    transform: scale(1.05);
}

.error-btn:active {
    transform: scale(0.98);
}

.error-btn-back {
    background: #3498db;
    color: white;
}

.error-btn-back:hover {
    background: #2980b9;
}

.error-btn-restart {
    background: #27ae60;
    color: white;
}

.error-btn-restart:hover {
    background: #219a52;
}

/* ==========================================================================
   OVERWORLD SYSTEM (Pokemon-style top-down movement)
   ========================================================================== */

.overworld-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: var(--z-sprites);
    display: none;
    justify-content: center;
    align-items: center;
    background: #000;
}

.overworld-container.active {
    display: flex;
}

.overworld-canvas {
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    /* Scale to fit container while maintaining aspect ratio */
    max-width: 100%;
    max-height: 100%;
}

/* Hide VN elements when overworld is active */
.overworld-active #background-layer,
.overworld-active #sprite-layer,
.overworld-active #text-box {
    display: none;
}

/* Overworld interaction prompt */
.overworld-prompt {
    position: absolute;
    bottom: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1rem;
    z-index: var(--z-text-box);
    border: 2px solid rgba(255, 255, 255, 0.3);
    animation: prompt-bounce 0.5s ease-out;
}

@keyframes prompt-bounce {
    0% { transform: translateX(-50%) translateY(20px); opacity: 0; }
    100% { transform: translateX(-50%) translateY(0); opacity: 1; }
}

/* Mobile touch controls */
.overworld-touch-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: var(--z-overlay);
    display: none;
}

/* Show on touch devices */
@media (hover: none) and (pointer: coarse) {
    .overworld-touch-controls {
        display: block;
    }
}

.touch-dpad {
    display: grid;
    grid-template-columns: 48px 48px 48px;
    grid-template-rows: 48px 48px 48px;
    gap: 4px;
}

.touch-btn {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    font-size: 1.5rem;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
}

.touch-btn:active {
    background: rgba(255, 255, 255, 0.5);
}

.touch-btn-up { grid-column: 2; grid-row: 1; }
.touch-btn-down { grid-column: 2; grid-row: 3; }
.touch-btn-left { grid-column: 1; grid-row: 2; }
.touch-btn-right { grid-column: 3; grid-row: 2; }
.touch-btn-action {
    grid-column: 2;
    grid-row: 2;
    font-size: 0.8rem;
    font-weight: bold;
}

/* === Battle Pause Overlay === */
.battle-pause-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: var(--z-modal);
    animation: pauseFadeIn 0.2s ease-out;
}

@keyframes pauseFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.battle-pause-overlay .pause-text {
    font-family: var(--font-ui);
    font-size: 3rem;
    color: #fff;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    letter-spacing: 0.3em;
    margin-bottom: 1rem;
}

.battle-pause-overlay .pause-hint {
    font-family: var(--font-ui);
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.6);
    letter-spacing: 0.1em;
}

/* Freeze all animations when paused */
.battle-paused,
.battle-paused * {
    animation-play-state: paused !important;
    transition: none !important;
}

/* Freeze floating damage numbers */
.battle-paused .damage-number {
    animation-play-state: paused !important;
}

/* Freeze dice spinning */
.battle-paused .dice-spinning {
    animation-play-state: paused !important;
}

/* Freeze typewriter cursor */
.battle-paused .roll-result {
    animation-play-state: paused !important;
}
