/* === BATTLE UI ===
 * Pokemon-style battle interface: log, choices, skill/item menus,
 * attack effects, dice animations, intro/outro transitions.
 */

/* === Dice Roll Styles === */
.dice-roll {
    padding: 12px;
    margin-bottom: 12px;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
}

.dice-roll.dice-success {
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid #4caf50;
}

.dice-roll.dice-failure {
    background: rgba(244, 67, 54, 0.2);
    border: 2px solid #f44336;
}

.dice-roll.dice-crit {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 152, 0, 0.3));
    border: 2px solid #ffd700;
    animation: crit-glow 0.5s ease-in-out 3;
}

.dice-roll.dice-fumble {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(0, 0, 0, 0.3));
    border: 2px solid #8b0000;
}

@keyframes crit-glow {
    0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
}

.skill-check-label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.8;
    margin-bottom: 4px;
}

.crit-text {
    color: #ffd700;
    font-weight: bold;
    font-size: var(--battle-text-size);
    margin-top: 8px;
    text-shadow: 1px 1px 0 #000;
}

.fumble-text {
    color: #ff4444;
    font-weight: bold;
    font-size: var(--battle-text-size);
    margin-top: 8px;
    text-shadow: 1px 1px 0 #000;
}

/* Damage roll min/max indicators - shared fumble/crit style */
/* Use high specificity to override theme-specific roll-result colors */
.damage-min,
.roll-result .damage-min,
.battle-log-content .roll-result .damage-min {
    color: var(--battle-fumble-color) !important;
    text-shadow: 0 0 10px #ff0000 !important;
}

.damage-max,
.roll-result .damage-max,
.battle-log-content .roll-result .damage-max {
    color: var(--battle-crit-color) !important;
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.6) !important;
}

/* === Battle Log === */
.battle-log {
    padding: 8px 12px;
    margin-bottom: 0;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    border-left: 3px solid #4caf50;
}

.battle-log.enemy-turn {
    border-left-color: #f44336;
    background: rgba(244, 67, 54, 0.1);
}

/* === Battle Result === */
.battle-result {
    text-align: center;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 8px;
    font-size: 1.4rem;
    font-weight: bold;
}

.battle-result.victory {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.3));
    border: 2px solid #4caf50;
    color: #4caf50;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.battle-result.defeat {
    background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(183, 28, 28, 0.3));
    border: 2px solid #f44336;
    color: #f44336;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

/* === Battle Action Buttons === */
.choice-button.battle-action {
    /* Battle buttons can have subtle styling differentiation */
}

/* === CUSTOM BATTLE UI (Pokemon-style) === */

/* Hide normal text box during battle */
#text-box.battle-mode {
    display: none !important;
}

/* Battle UI container - covers the full VN area */
#battle-ui {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: var(--z-battle-ui);
    pointer-events: none;
}

#battle-ui > * {
    pointer-events: auto;
}

/* Battle HP/Mana containers get battle-specific positioning */
#battle-ui .hp-container.battle-hp,
#battle-ui .mana-container.battle-mana {
    display: block;
}

/* Battle log panel - replaces text box at bottom */
.battle-log-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    /* Fixed height to prevent layout shift - matches --battle-log-height variable */
    /* Height = log content (4.4rem) + choices (7rem) + padding (1.5rem) = ~13rem */
    /* Use fixed height (not min-height) so player stats panel positions correctly */
    height: var(--battle-log-height, 13.4rem);
    background: rgba(0, 0, 0, 0.85);
    border-top: 0.1875rem solid rgba(255, 255, 255, 0.3);  /* 3px */
    padding: var(--spacing-sm) var(--spacing-md);
    box-sizing: border-box;
    /* Enable flex layout for skill/item submenus to fill space */
    display: flex;
    flex-direction: column;
    overflow: hidden;  /* Prevent overflow, submenus scroll internally */
}

.battle-log-content {
    /* Fixed height to prevent text shift when lines are added */
    /* With font-size: 0.95rem and line-height: 1.8 multiplier = 1.71rem per line */
    /* Height = 2 lines * 1.71rem = 3.42rem + padding (0.8rem + 0.5rem) = ~4.7rem */
    height: var(--battle-log-content-height, 4.8rem);
    box-sizing: border-box;  /* Include padding in height */
    overflow-y: auto;  /* Allow scrolling - JS scrolls to bottom, CSS hides scrollbar */
    overflow-x: hidden;
    padding: 0.5rem 1rem;  /* Symmetric padding - content starts at top */
    font-size: var(--battle-text-size);
    line-height: 1.8;  /* More breathing room between lines */
    color: var(--battle-text-color);
    flex-shrink: 0;  /* Don't shrink when in flex container */
    scrollbar-width: none;  /* Firefox - hide scrollbar */
    -ms-overflow-style: none;  /* IE/Edge - hide scrollbar */
    /* Ensure content starts at top, not centered */
    display: block;
    vertical-align: top;
}

.battle-log-content::-webkit-scrollbar {
    display: none;  /* Chrome/Safari */
}

/* Messages wrapper - content starts at top, doesn't move when new lines added */
.battle-log-messages {
    display: block;
    /* Remove margin from first roll-result so it starts at container top */
}

.battle-log-messages .roll-result:first-child {
    margin-top: 0;
}

.battle-log-content .roll-result {
    color: var(--battle-text-color);
}

/* Dice numbers: grey while spinning, inherit when final */
.battle-log-content .dice-number,
.roll-result .dice-number {
    color: var(--battle-roll-color);
}

/* Highlight numbers/effects in battle messages (e.g., "+4 AC", "2 turns") */
.battle-log-content strong:not(.dice-number),
.battle-log-content b,
#battle-log-content strong:not(.dice-number),
#battle-log-content b {
    color: var(--battle-number-color, #ffd700) !important;
    font-size: var(--battle-special-size, 1.2rem);
}

/* Battle number - for inline numbers in messages (e.g., "Restored 12 MP!") */
.battle-number {
    color: var(--battle-number-color, #ffd700);
    font-size: var(--battle-text-size, 0.95rem);
    font-weight: bold;
    vertical-align: baseline;
}


/* === Pokemon-style 4-choice Grid === */
.battle-choices {
    /* Fallback for browsers without grid support */
    display: block;
    display: -webkit-flex;
    display: flex;
    flex-wrap: wrap;
    /* Modern browsers: use grid */
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    padding: var(--spacing-md);
    height: 7rem;  /* Fixed height for 2 rows of buttons */
}

/* Fallback spacing for browsers without gap support */
.battle-choices > * {
    margin: 0.375rem;  /* 6px */
}

/* Modern browsers: use gap and remove margin fallback */
@supports (gap: 0.75rem) {
    .battle-choices {
        gap: var(--spacing-md);
    }
    .battle-choices > * {
        margin: 0;
    }
}

.battle-choices .choice-button {
    padding: 10px 14px;
    font-size: 0.9rem;
    font-weight: bold;
    min-height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--btn-color, #fff);
}

.battle-choices .choice-button:disabled,
.battle-choices .choice-button.waiting {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
    filter: grayscale(30%);
}

/* Container waiting state - subtle visual cue */
.battle-choices.waiting {
    opacity: 0.85;
}

/* === Attack Effect Animations === */
.attack-effect {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: var(--z-battle-effects);
    animation: attack-flash 0.6s ease-out forwards;
}

.attack-effect.attack-physical {
    background: radial-gradient(circle at 50% 30%, rgba(255, 255, 255, 0.4), transparent 60%);
}

.attack-effect.attack-fire {
    background: radial-gradient(circle at 50% 30%, rgba(255, 100, 0, 0.5), rgba(255, 200, 0, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-ice {
    background: radial-gradient(circle at 50% 30%, rgba(150, 220, 255, 0.5), rgba(200, 240, 255, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-lightning {
    background: radial-gradient(circle at 50% 30%, rgba(255, 255, 100, 0.6), rgba(255, 255, 200, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-poison {
    background: radial-gradient(circle at 50% 30%, rgba(150, 0, 150, 0.5), rgba(100, 200, 0, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-psychic {
    background: radial-gradient(circle at 50% 30%, rgba(200, 100, 255, 0.5), rgba(150, 50, 200, 0.2) 40%, transparent 70%);
}

.attack-effect.attack-holy {
    background: radial-gradient(circle at 50% 30%, rgba(255, 255, 200, 0.6), rgba(255, 215, 0, 0.3) 40%, transparent 70%);
}

.attack-effect.attack-dark {
    background: radial-gradient(circle at 50% 30%, rgba(50, 0, 80, 0.6), rgba(100, 0, 100, 0.3) 40%, transparent 70%);
}

@keyframes attack-flash {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    30% {
        opacity: 1;
        transform: scale(1.1);
    }
    100% {
        opacity: 0;
        transform: scale(1.2);
    }
}

/* === Screen Shake (when player is hit) === */
@keyframes screen-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

#vn-container.screen-shake {
    animation: screen-shake 0.3s ease-out;
}

/* === Battle Log Styling === */
.battle-log.crit {
    background: rgba(255, 215, 0, 0.3);
    border-left-color: #ffd700;
}

.battle-log.fumble {
    background: rgba(139, 0, 0, 0.3);
    border-left-color: #8b0000;
}

.battle-log.status-messages {
    background: rgba(128, 128, 128, 0.2);
    border-left-color: #888;
    font-style: italic;
}

/* Battle number variants for different stat types */
.battle-number-hp {
    color: var(--roll-color-heal, #2ecc71) !important;
    font-size: var(--battle-text-size, 0.95rem);
    font-weight: bold;
}

.battle-number-mp {
    color: var(--roll-color-status, #3498db) !important;
    font-size: var(--battle-text-size, 0.95rem);
    font-weight: bold;
}

.battle-number-damage {
    color: var(--roll-color-damage, #ff4444) !important;
    font-size: var(--battle-text-size, 0.95rem);
    font-weight: bold;
}

/* === Status Effect Icons === */
.status-icons {
    display: block;
    display: -webkit-flex;
    display: flex;
    margin-top: 4px;
    flex-wrap: wrap;
}

/* Fallback spacing for browsers without gap support */
.status-icons > * {
    margin: 2px;
}

/* Modern browsers: use gap and remove margin fallback */
@supports (gap: 4px) {
    .status-icons {
        gap: 4px;
    }
    .status-icons > * {
        margin: 0;
    }
}

.status-icon {
    font-size: 1rem;
    cursor: help;
    position: relative;
    display: inline-block;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    animation: status-pulse 2s ease-in-out infinite;
}

.status-icon sub {
    font-size: 0.6rem;
    position: absolute;
    bottom: -2px;
    right: -4px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 50%;
    padding: 1px 3px;
    color: #fff;
}

@keyframes status-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* === Terrain Indicator === */
.terrain-indicator {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    padding: 6px 16px;
    border-radius: 20px;
    color: #fff;
    font-size: 0.85rem;
    font-weight: bold;
    z-index: var(--z-battle-ui);
    display: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.terrain-icon {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 6px;
}

/* === DOT Damage Numbers === */
.battle-damage-number.dot {
    color: #9b59b6;
    text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
}

/* === Expanded Menu State (skill/item menus) === */
/* When skill/item menu is open, the battle-log-panel expands and player stats must move up */
.battle-log-panel.menu-expanded {
    --battle-log-height-expanded: 22rem;  /* Expanded height for skill/item menus */
    height: var(--battle-log-height-expanded);
}

/* Player stats panel moves up when menu is expanded */
.battle-stats-panel.player-stats.menu-expanded {
    bottom: calc(22rem + 10px) !important;  /* Match --battle-log-height-expanded */
}

/* === Skill Menu (replaces battle choices in battle-log-panel) === */
.skill-submenu {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 12px;
    overflow: hidden;
    min-height: 0;  /* Allow flex item to shrink below content size */
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    align-self: stretch !important;  /* Stretch to fill parent width in flex container */
    align-items: stretch;  /* Children (skill-list) stretch to full width */
}

.skill-submenu-title {
    color: #ffd700;
    font-size: var(--battle-text-size, 0.95rem);
    font-weight: bold;
    margin-bottom: 8px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    flex-shrink: 0;
}

.skill-list {
    /* Fallback for older browsers */
    display: flex;
    flex-wrap: wrap;
    /* Modern browsers: use grid */
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    grid-template-rows: repeat(3, 1fr);  /* 3 equal rows to fill vertical space */
    gap: 8px;
    overflow-y: auto;  /* Scroll if content exceeds available space */
    overflow-x: hidden;
    flex: 1;  /* Take remaining space in flex container */
    min-height: 0;  /* Allow shrinking below content size */
    padding: 2px; /* Prevent hover transform from triggering scrollbars */
    width: 100% !important;
    max-width: 100% !important;
    justify-items: stretch;  /* Grid items stretch to fill cell width */
    align-items: stretch;  /* Grid items stretch to fill cell height */
}

/* Fallback spacing for browsers without gap */
@supports not (gap: 8px) {
    .skill-list > * {
        margin: 4px;
    }
}

.skill-item {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 8px 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    text-align: center;
    box-sizing: border-box;
    width: 100%;
}

.skill-item:hover {
    background: rgba(255, 255, 255, 0.25);
}

.skill-item:active {
    background: rgba(255, 255, 255, 0.15);
}

.skill-item.disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.skill-item.disabled .skill-name {
    color: var(--roll-color-neutral, #888) !important;
}

.skill-item.disabled .skill-cost {
    color: var(--roll-color-neutral, #888) !important;
}

.skill-item.disabled:hover {
    background: rgba(255, 255, 255, 0.1);
}

.skill-name {
    color: #fff;
    font-weight: bold;
    font-size: var(--battle-text-size, 0.95rem);
}

.skill-cost {
    color: #60a5fa;
    font-size: var(--battle-text-size, 0.95rem);
    margin-top: 2px;
}

.skill-cost.insufficient {
    color: #f44336;
}

/* Effect icon slot - reserves fixed space to prevent layout shift */
.skill-effect-slot {
    display: inline-block;
    min-width: 1.2em;
    min-height: 1em;
    font-size: 0.85rem;
    text-align: center;
    vertical-align: middle;
    margin-top: 2px;
}

/* Locked skill slots - show player can earn more */
.skill-item.skill-item-locked {
    background: rgba(255, 255, 255, 0.03);
    border: 1px dashed rgba(255, 255, 255, 0.2);
    cursor: default;
    opacity: 0.6;
}

.skill-item.skill-item-locked:hover {
    background: rgba(255, 255, 255, 0.05);
}

.skill-name-locked {
    color: #666 !important;
    font-style: italic;
}

.skill-cost-locked {
    color: #555 !important;
    font-size: 0.65rem;
}

/* Back button uses theme CSS variables for consistent styling. */
.skill-back-btn {
    margin-top: auto;
    padding-top: 8px;
    width: 100%;
    padding: 8px 12px;
    background: var(--btn-bg);
    color: var(--btn-color);
    border: var(--btn-border);
    border-radius: var(--btn-border-radius);
    cursor: pointer;
    font-size: var(--button-font-size, 0.85rem);
    font-family: inherit;
    flex-shrink: 0;
}

.skill-back-btn:hover {
    background: var(--btn-bg-hover);
}

/* === Item Submenu (replaces battle choices in battle-log-panel) === */
.item-submenu {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 8px 12px;
    overflow: hidden;
    min-height: 0;  /* Allow flex item to shrink below content size */
}

.item-submenu-title {
    color: #f39c12;
    font-size: 0.75rem;
    font-weight: bold;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--battle-panel-border);
    margin-bottom: 6px;
    flex-shrink: 0;
}

.item-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;  /* Allow shrinking below content size */
}

.item-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.item-row:hover {
    background: rgba(255, 255, 255, 0.25);
}

.item-row.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    justify-content: center;
}

.item-row .item-icon {
    font-size: 1rem;
}

.item-row .item-name {
    flex: 1;
    color: var(--battle-text);
    font-size: 0.8rem;
}

.item-row .item-qty {
    color: var(--battle-text-dim);
    font-size: 0.75rem;
}

/* === Battle Choice Button Type Colors === */
.battle-choices .choice-button[data-action="attack"] {
    background: linear-gradient(to bottom, #e74c3c, #c0392b);
    border-color: #a93226;
}

.battle-choices .choice-button[data-action="skill"] {
    background: linear-gradient(to bottom, #9b59b6, #8e44ad);
    border-color: #7d3c98;
}

.battle-choices .choice-button[data-action="defend"] {
    background: linear-gradient(to bottom, #3498db, #2980b9);
    border-color: #2471a3;
}

.battle-choices .choice-button[data-action="item"] {
    background: linear-gradient(to bottom, #f39c12, #d68910);
    border-color: #b9770e;
}

.battle-choices .choice-button:hover {
    filter: brightness(1.1);
    transform: scale(1.02);
}

.battle-choices .choice-button:active {
    filter: brightness(0.9);
    transform: scale(0.98);
}

/* === Critical/Fumble Text in Log === */
.battle-log .crit-text {
    display: inline-block;
    color: #ffd700;
    font-weight: bold;
    animation: crit-bounce 0.5s ease-out;
}

.battle-log .fumble-text {
    display: inline-block;
    color: #ff4444;
    font-weight: bold;
}

@keyframes crit-bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

/* === Animated Dice Roll Numbers === */
.dice-number {
    display: inline-block;
    font-size: var(--battle-special-size);
    line-height: 1;
    vertical-align: baseline;
    transition: transform 0.1s ease-out;
    /* Prevent faux-bold and white outline artifacts */
    -webkit-text-stroke: 0;
    font-weight: normal;
}

.dice-number.dice-spinning {
    animation: dice-wobble 0.1s ease-in-out infinite;
    color: #aaa;
}

.dice-number.dice-final {
    animation: dice-reveal 0.3s ease-out forwards;
    /* color is set by roll-* classes, don't override here */
}

/* Legacy dice-crit/fumble classes - now use unified system */
.dice-number.dice-crit {
    color: var(--roll-color-hit) !important;
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow);
    animation: dice-crit-reveal 0.5s ease-out forwards;
}

.dice-number.dice-fumble {
    color: var(--roll-color-neutral) !important;
    text-shadow: 0 0 8px var(--emphasis-fail-glow), 0 0 16px rgba(255, 0, 0, 0.6);
    animation: dice-fumble-reveal 0.5s ease-out forwards;
}

@keyframes dice-wobble {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-2px) scale(1.05); }
}

@keyframes dice-reveal {
    0% { transform: scale(1.5); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes dice-crit-reveal {
    0% { transform: scale(0.5); opacity: 0; }
    40% { transform: scale(2); opacity: 1; }
    70% { transform: scale(1.8); }
    100% { transform: scale(1.5); }
}

@keyframes dice-fumble-reveal {
    0% { transform: scale(1.5) rotate(0deg); opacity: 0; }
    30% { transform: scale(1.2) rotate(-5deg); opacity: 1; }
    60% { transform: scale(1.1) rotate(5deg); }
    100% { transform: scale(1) rotate(0deg); }
}

/* === Roll Result Display (Collapsing Modifiers System) === */

.roll-result, .damage-result {
    display: block;
    margin: 4px 0;
    line-height: 1.8;  /* Match battle-log-content line-height */
    min-height: 1.8em;
    position: relative;  /* For absolute-positioned collapsing modifiers */
    /* Reset theme overrides that may interfere */
    -webkit-text-stroke: 0 !important;
}

/* Modifier that appears then collapses into the number */
.mod-part {
    display: inline;
    opacity: 0;
    font-size: var(--battle-special-size);
    line-height: 1;
    vertical-align: baseline;
    color: var(--battle-number-color);  /* Modifier values are yellow (e.g., "+ 3") */
}

.mod-part.mod-animate-in {
    opacity: 1;
    animation: mod-slide-in 0.3s ease-out forwards;
}

.mod-part.mod-collapsing {
    /* Stay inline, just fade out while moving left */
    animation: mod-collapse 0.25s ease-in forwards;
}

.mod-source {
    color: var(--battle-roll-color);  /* Source stays grey (e.g., "(STR)") */
    font-size: var(--battle-text-size);
    font-style: italic;
}

/* Damage modifier - red color for damage bonuses (e.g., "+ 1 (Timing)") */
.mod-part.damage-mod {
    color: var(--roll-color-damage);
}

/* Overheal modifier - grey/muted to show "wasted" healing */
.overheal-mod {
    color: var(--roll-neutral-color, #888);
    font-size: var(--battle-special-size);
}

@keyframes mod-slide-in {
    0% { opacity: 0; transform: translateX(10px); }
    100% { opacity: 1; transform: translateX(0); }
}

@keyframes mod-collapse {
    0% { opacity: 1; transform: translateX(0); }
    100% { opacity: 0; transform: translateX(-1em); }
}

/* Pop effect when number updates after collapse */
.dice-number.dice-pop {
    animation: dice-number-pop 0.25s ease-out;
}

@keyframes dice-number-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

/* =========================================================================
   ADVANTAGE/DISADVANTAGE DICE
   Two dice shown side by side, loser collapses into winner, winner pops up
   ========================================================================= */

/* Both advantage dice - simple inline */
.dice-number.advantage-die {
    display: inline;
}

/* Separator between the two dice */
.advantage-separator {
    display: inline;
    opacity: 0.6;
}

.advantage-separator-fade {
    display: none;
}

/* Loser die - just hide */
.dice-number.advantage-loser-left,
.dice-number.advantage-loser-right {
    display: none;
}

/* Winner die */
.dice-number.advantage-winner {
}

/* HIT/MISS/DAMAGE result text - no background, just colored text */
.roll-result-text {
    display: inline;
    font-weight: normal;
    font-size: var(--battle-text-size);
    line-height: 1;
    vertical-align: baseline;
    -webkit-text-stroke: 0;
}

/* Legacy result classes - now use unified system */
.result-hit {
    color: var(--roll-color-hit);
}

.result-miss {
    color: var(--roll-color-neutral);
}

.result-crit {
    color: var(--roll-color-hit);
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow);
}

.result-fumble {
    color: var(--roll-color-neutral);
    text-shadow: 0 0 8px var(--emphasis-fail-glow);
}

/* Heal roll styling - green (heal type) */
.dice-number.dice-heal {
    color: var(--roll-color-heal) !important;
}

.result-heal {
    color: var(--roll-color-heal);
    font-weight: bold;
}

/* Defend message styling - high specificity to override theme colors */
.defend-ac-bonus,
.battle-log-content .defend-ac-bonus,
.battle-log-messages .defend-ac-bonus,
#battle-log-content .defend-ac-bonus,
div.battle-log-content span.defend-ac-bonus {
    color: var(--battle-roll-color, #888) !important;  /* Grey for AC bonus */
    font-size: var(--battle-special-size, 1.2rem) !important;
    font-weight: bold !important;
}

.defend-duration,
.battle-log-content .defend-duration,
.battle-log-messages .defend-duration,
#battle-log-content .defend-duration,
div.battle-log-content span.defend-duration {
    color: var(--battle-roll-color, #888) !important;  /* Grey for duration */
    font-size: var(--battle-special-size, 1.2rem) !important;
    font-weight: bold !important;
}

@keyframes result-pop {
    0% { transform: scale(0.5); opacity: 0; }
    60% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes result-crit-pop {
    0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
    40% { transform: scale(1.5) rotate(5deg); opacity: 1; }
    70% { transform: scale(1.3) rotate(-2deg); }
    100% { transform: scale(1.2) rotate(0deg); opacity: 1; }
}

@keyframes result-fumble-shake {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.1) translateX(-3px); opacity: 1; }
    40% { transform: scale(1.05) translateX(3px); }
    60% { transform: scale(1.02) translateX(-2px); }
    80% { transform: scale(1.01) translateX(1px); }
    100% { transform: scale(1) translateX(0); opacity: 1; }
}

/* Damage display - no special styling for damage numbers, just inherit */
.damage-dice {
    /* Damage dice don't get crit/fumble colors - that's only for d20 attack rolls */
}

/* DAMAGE text - uses red (damage type) by default */
.damage-text {
    display: inline;
    font-weight: bold;
    color: var(--roll-color-damage);
    font-size: var(--battle-text-size);
}

/* Legacy damage-crit-text - red + crit emphasis */
.damage-text.damage-crit-text {
    color: var(--roll-color-damage);
    text-shadow: 0 0 8px var(--emphasis-crit-glow), 0 0 16px var(--emphasis-crit-glow);
}

/* Legacy damage-min/max - now uses unified emphasis system */
.damage-text.damage-min,
.roll-result .damage-text.damage-min,
.battle-log-content .roll-result .damage-text.damage-min {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 4px var(--emphasis-min-glow), 0 0 8px rgba(100, 100, 100, 0.4) !important;
}

.damage-text.damage-max,
.roll-result .damage-text.damage-max,
.battle-log-content .roll-result .damage-text.damage-max {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 6px var(--emphasis-max-glow), 0 0 12px rgba(255, 140, 0, 0.8) !important;
}

/* Damage dice styling - red for damage rolls */
.damage-dice {
    color: var(--roll-color-damage);
    font-size: var(--battle-special-size);
    font-weight: bold;
}

/* Legacy min/max damage dice - red + emphasis, NOT color change */
.dice-number.damage-min,
.roll-result .dice-number.damage-min {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 4px var(--emphasis-min-glow), 0 0 8px rgba(100, 100, 100, 0.4) !important;
    animation: emphasis-min-fade 0.4s ease-out forwards;
}

.dice-number.damage-max,
.roll-result .dice-number.damage-max {
    color: var(--roll-color-damage) !important;
    text-shadow: 0 0 6px var(--emphasis-max-glow), 0 0 12px rgba(255, 140, 0, 0.8) !important;
    animation: emphasis-max-pulse 0.4s ease-out forwards;
}

/* === Effectiveness Messages === */
.effectiveness-super {
    color: #4caf50;
    font-weight: bold;
}

.effectiveness-weak {
    color: #ff9800;
    font-style: italic;
}

.effectiveness-immune {
    color: #9e9e9e;
    font-style: italic;
}

/* Limit Break Animation Effect */
.limit-break-effect {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    display: -webkit-flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.5) 0%, rgba(255, 100, 0, 0.3) 50%, transparent 70%);
    animation: limit-break-flash 1.5s ease-out forwards;
    z-index: var(--z-overlay);
    pointer-events: none;
}

.limit-break-text {
    font-size: 2rem;
    font-weight: bold;
    color: #fff;
    text-shadow:
        0 0 10px #ffd700,
        0 0 20px #ff8c00,
        0 0 30px #ff4500,
        2px 2px 4px rgba(0, 0, 0, 0.8);
    animation: limit-break-zoom 1s ease-out forwards;
}

@keyframes limit-break-flash {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
}

@keyframes limit-break-zoom {
    0% { transform: scale(0.5); opacity: 0; }
    30% { transform: scale(1.3); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* === Summon Indicator === */

.summon-indicator {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(100, 200, 255, 0.9);
    color: #1a1a3e;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    display: block;
    display: -webkit-flex;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 10px rgba(100, 200, 255, 0.5);
    animation: summon-glow 2s infinite;
    z-index: var(--z-battle-ui);
}

/* Fallback spacing for browsers without gap support */
.summon-indicator > * {
    margin: 0 4px;
}

.summon-indicator > *:first-child {
    margin-left: 0;
}

.summon-indicator > *:last-child {
    margin-right: 0;
}

/* Modern browsers: use gap and remove margin fallback */
@supports (gap: 8px) {
    .summon-indicator {
        gap: 8px;
    }
    .summon-indicator > * {
        margin: 0;
    }
}

.summon-icon {
    font-size: 1.2rem;
}

.summon-duration {
    font-size: 0.7rem;
    opacity: 0.8;
}

@keyframes summon-glow {
    0%, 100% { box-shadow: 0 2px 10px rgba(100, 200, 255, 0.5); }
    50% { box-shadow: 0 2px 20px rgba(100, 200, 255, 0.8); }
}

/* Summon turn in battle log */
.battle-log.summon-turn {
    background: rgba(100, 200, 255, 0.2);
    border-left: 3px solid #64c8ff;
}

/* === Mid-Fight Dialogue === */

.battle-dialogue {
    position: absolute;
    bottom: calc(var(--battle-log-height) + 8px);  /* Position above battle log panel */
    left: 50%;
    transform: translateX(-50%);
    z-index: var(--z-battle-effects);
    animation: dialogue-appear 0.3s ease-out;
    max-width: 95%;
    width: 95%;
    display: flex;
    justify-content: center;
    pointer-events: none;
}

.dialogue-bubble {
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    padding: 10px 20px;
    border-radius: 16px;
    font-size: var(--base-font-size, 1.35rem);
    font-style: italic;
    max-width: 100%;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    position: relative;
    word-wrap: break-word;
    overflow-wrap: break-word;
    box-sizing: border-box;
}

.dialogue-bubble::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 10px 10px 0 10px;
    border-style: solid;
    border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
}

@keyframes dialogue-appear {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.battle-dialogue.fade-out {
    animation: dialogue-fade 0.3s ease-out forwards;
}

@keyframes dialogue-fade {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
    }
}

/* === Battle Log Special Entries === */

.battle-log.limit-break {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 100, 0, 0.2));
    border-left: 4px solid #ffd700;
    font-weight: bold;
}

.battle-log.summon {
    background: rgba(100, 200, 255, 0.2);
    border-left: 4px solid #64c8ff;
}

.battle-log.passive {
    font-style: italic;
    opacity: 0.9;
}

/* === Battle Intro/Outro Transitions === */

/* Battle intro overlay - dims screen and shows announcement */
.battle-intro-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    z-index: var(--z-overlay);
    display: flex;
    display: -webkit-flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    animation: battle-intro-dim 2s ease-out forwards;
}

@keyframes battle-intro-dim {
    0% {
        background: rgba(0, 0, 0, 0);
    }
    20% {
        background: rgba(0, 0, 0, 0.8);
    }
    70% {
        background: rgba(0, 0, 0, 0.8);
    }
    100% {
        background: rgba(0, 0, 0, 0);
    }
}

/* Battle start text announcement */
.battle-intro-text {
    font-size: calc(var(--base-font-size, 1.35rem) * 2);
    font-weight: bold;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 8px;
    text-shadow:
        0 0 20px rgba(255, 0, 0, 0.8),
        0 0 40px rgba(255, 0, 0, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
    opacity: 0;
    transform: scale(0.5);
    animation: battle-intro-text-appear 2s ease-out forwards;
    /* Ensure text stays centered and doesn't overflow */
    text-align: center;
    max-width: 90%;
    word-wrap: break-word;
}

@keyframes battle-intro-text-appear {
    0% {
        opacity: 0;
        transform: scale(0.5);
    }
    25% {
        opacity: 1;
        transform: scale(1.2);
    }
    40% {
        transform: scale(1);
    }
    70% {
        opacity: 1;
        transform: scale(1);
    }
    100% {
        opacity: 0;
        transform: scale(1.5);
    }
}

/* Enemy slide-in animation during intro */
#sprite-layer.battle-intro-enemy {
    animation: battle-enemy-slide-in 1.5s ease-out forwards;
    /* Prevent background rectangle on mobile */
    background: transparent !important;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}

#sprite-layer.battle-intro-enemy img {
    /* Ensure sprites have no visible background during animation */
    background: transparent !important;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}

@keyframes battle-enemy-slide-in {
    0% {
        transform: translateX(100%);
        opacity: 0;
    }
    60% {
        transform: translateX(-5%);
        opacity: 1;
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Flash effect for battle start impact */
.battle-intro-flash {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fff;
    z-index: var(--z-overlay);
    opacity: 0;
    pointer-events: none;
    animation: battle-intro-flash-anim 0.3s ease-out forwards;
    animation-delay: 0.4s;
}

@keyframes battle-intro-flash-anim {
    0% {
        opacity: 0;
    }
    50% {
        opacity: 0.7;
    }
    100% {
        opacity: 0;
    }
}

/* === Battle Outro (Victory/Defeat) === */

/* Victory overlay */
.battle-outro-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: var(--z-overlay);
    display: flex;
    display: -webkit-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
}

.battle-outro-overlay.victory {
    background: linear-gradient(
        135deg,
        rgba(255, 215, 0, 0.3) 0%,
        rgba(76, 175, 80, 0.4) 50%,
        rgba(255, 215, 0, 0.3) 100%
    );
    animation: victory-bg-pulse 1.5s ease-in-out infinite;
}

.battle-outro-overlay.defeat {
    background: linear-gradient(
        135deg,
        rgba(139, 0, 0, 0.5) 0%,
        rgba(0, 0, 0, 0.7) 50%,
        rgba(139, 0, 0, 0.5) 100%
    );
    animation: defeat-bg-fade 2s ease-out forwards;
}

.battle-outro-overlay.flee {
    background: rgba(100, 100, 100, 0.5);
    animation: flee-bg-fade 1s ease-out forwards;
}

@keyframes victory-bg-pulse {
    0%, 100% {
        opacity: 0.8;
    }
    50% {
        opacity: 1;
    }
}

@keyframes defeat-bg-fade {
    0% {
        background: rgba(139, 0, 0, 0.3);
    }
    100% {
        background: rgba(0, 0, 0, 0.8);
    }
}

@keyframes flee-bg-fade {
    0% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}

/* Victory/Defeat text */
.battle-outro-text {
    font-size: calc(var(--base-font-size, 1.35rem) * 2.3);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 6px;
    margin-bottom: 20px;
    opacity: 0;
    animation: outro-text-appear 0.8s ease-out forwards;
    animation-delay: 0.2s;
}

.battle-outro-text.victory {
    color: #ffd700;
    text-shadow:
        0 0 20px rgba(255, 215, 0, 0.8),
        0 0 40px rgba(255, 215, 0, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
}

.battle-outro-text.defeat {
    color: #ff4444;
    text-shadow:
        0 0 20px rgba(255, 0, 0, 0.8),
        0 0 40px rgba(139, 0, 0, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
}

.battle-outro-text.flee {
    color: #aaa;
    text-shadow:
        0 0 10px rgba(150, 150, 150, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
    font-size: calc(var(--base-font-size, 1.35rem) * 1.6);
}

@keyframes outro-text-appear {
    0% {
        opacity: 0;
        transform: translateY(-30px) scale(0.8);
    }
    60% {
        opacity: 1;
        transform: translateY(5px) scale(1.05);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Subtext (e.g., "You earned X experience") */
.battle-outro-subtext {
    font-size: 1.2rem;
    color: #fff;
    opacity: 0;
    animation: outro-subtext-appear 0.5s ease-out forwards;
    animation-delay: 0.8s;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

@keyframes outro-subtext-appear {
    0% {
        opacity: 0;
        transform: translateY(10px);
    }
    100% {
        opacity: 0.9;
        transform: translateY(0);
    }
}

/* Victory sparkles effect */
.victory-sparkle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #ffd700;
    border-radius: 50%;
    pointer-events: none;
    animation: sparkle-float 2s ease-out forwards;
}

@keyframes sparkle-float {
    0% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(-100px) scale(0.3);
    }
}

/* Defeat fade effect on enemy sprite */
#sprite-layer.battle-outro-defeat {
    animation: enemy-victory-pose 1s ease-out forwards;
}

@keyframes enemy-victory-pose {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1.05);
    }
}

/* Victory fade effect on enemy sprite */
#sprite-layer.battle-outro-victory {
    animation: enemy-defeat-fade 1s ease-out forwards;
}

@keyframes enemy-defeat-fade {
    0% {
        opacity: 1;
        transform: translateY(0);
    }
    50% {
        opacity: 0.5;
        transform: translateY(10px);
    }
    100% {
        opacity: 0;
        transform: translateY(30px);
    }
}
